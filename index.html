<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>La Lista</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged,
      signInWithEmailAndPassword,
      createUserWithEmailAndPassword,
      signInWithPopup,
      GoogleAuthProvider,
      sendPasswordResetEmail,
      signOut,
      updateProfile
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBBS_h2F_gm8pYo4w3iM4Ac-ibr9DfcwLU",
      authDomain: "lalista-ed7d4.firebaseapp.com",
      projectId: "lalista-ed7d4",
      storageBucket: "lalista-ed7d4.firebasestorage.app",
      messagingSenderId: "842332318376",
      appId: "1:842332318376:web:cfa9cfe4b639ea3924709d",
      measurementId: "G-45QYFHG3VS"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const googleProvider = new GoogleAuthProvider();

    // Exponer al scope global para el resto del c√≥digo
    window._fbAuth = auth;
    window._fbSignInEmail = (email, pass) => signInWithEmailAndPassword(auth, email, pass);
    window._fbRegister = (email, pass) => createUserWithEmailAndPassword(auth, email, pass);
    window._fbGoogleLogin = () => signInWithPopup(auth, googleProvider);
    window._fbResetPassword = (email) => sendPasswordResetEmail(auth, email);
    window._fbSignOut = () => signOut(auth);
    window._fbUpdateProfile = (data) => updateProfile(auth.currentUser, data);
    window._fbOnAuthStateChanged = (cb) => onAuthStateChanged(auth, cb);

    // Notificar que Firebase est√° listo
    window.dispatchEvent(new Event("firebaseReady"));
  </script>

  <style>
    :root{
      --text:#f3f4f6;
      --muted:rgba(243,244,246,.72);
      --card:#ffffff;
      --ink:#0b1022;
      --inkMuted:rgba(11,16,34,.55);
      --pill:rgba(0,0,0,.06);
      --pillActive:rgba(0,0,0,.12);
      --navBg:#ffffff;
      --stroke:rgba(0,0,0,.10);
      --cta:#23c7b6;
      --cta2:#1aa99c;
      --shadow:0 18px 60px rgba(0,0,0,.22);
      --shadow2:0 14px 34px rgba(0,0,0,.12);
      --red:#ef4444;
    }

    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%}
    body{
      font-family:system-ui,-apple-system,Segoe UI,Roboto;
      background:#000;
      color:var(--text);
    }

    .frame{
      width:min(430px,100%);
      height:min(920px,100vh);
      margin:0 auto;
      border-radius:28px;
      overflow:hidden;
      position:relative;
      background:#000;
    }

    .screen{position:absolute;inset:0;display:none;overflow:auto;}
    .screen.active{display:block;}

    /* =============== ONBOARDING / AUTH SCREEN =============== */
    .onboarding{
      height:100%;
      padding:18px;
      display:flex;
      align-items:flex-end;
      justify-content:center;
      background:
        linear-gradient(180deg,rgba(0,0,0,.2),rgba(0,0,0,.85)),
        url("https://images.unsplash.com/photo-1507525428034-b723cf961d3e?auto=format&fit=crop&w=1400&q=60")
        center/cover no-repeat;
    }
    .obLogo{
      position:absolute;
      top:calc(env(safe-area-inset-top,0px) + 18px);
      left:0;right:0;
      text-align:center;
      font-weight:800;
      letter-spacing:.35em;
      font-size:28px;
      user-select:none;
      color:#fff;
    }
    .obHero{
      position:absolute;
      top:45%;
      left:18px;right:18px;
      transform:translateY(-50%);
    }
    .obTitle{
      font-size:40px;
      font-weight:850;
      line-height:1.05;
      color:#fff;
    }
    .obSubtitle{
      margin-top:22px;
      font-size:14px;
      line-height:1.55;
      color:var(--muted);
      text-align:center;
      max-width:36ch;
      margin-inline:auto;
    }
    .obButtons{
      width:100%;
      padding-bottom:calc(env(safe-area-inset-bottom,0px) + 6px);
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .btnEntrar{
      width:100%;border:none;border-radius:999px;padding:16px;
      font-size:16px;font-weight:750;
      background:linear-gradient(180deg,var(--cta),var(--cta2));
      color:#062a26;cursor:pointer;
    }
    .btnEntrar:active{transform:translateY(1px)}
    .btnRegistrar{
      width:100%;border:1.5px solid rgba(255,255,255,.55);
      border-radius:999px;padding:15px;
      font-size:16px;font-weight:750;
      background:rgba(255,255,255,.12);
      color:#fff;cursor:pointer;
      backdrop-filter:blur(8px);
    }
    .btnRegistrar:active{transform:translateY(1px)}

    /* =============== AUTH POPUP MODAL =============== */
    .authModalBack{
      position:absolute;inset:0;
      background:rgba(0,0,0,.55);
      display:none;
      align-items:flex-end;
      justify-content:center;
      padding:14px;
      z-index:200;
      backdrop-filter:blur(4px);
      -webkit-backdrop-filter:blur(4px);
    }
    .authModalBack.show{display:flex;}

    .authCard{
      width:100%;
      background:#fff;
      border-radius:24px;
      padding:24px 20px 20px;
      box-shadow:var(--shadow);
      position:relative;
      max-height:92vh;
      overflow-y:auto;
    }

    .authModalClose{
      position:absolute;
      top:14px;right:14px;
      width:36px;height:36px;
      border-radius:50%;
      border:none;
      background:rgba(11,16,34,.07);
      cursor:pointer;
      font-size:16px;
      color:rgba(11,16,34,.55);
      display:flex;align-items:center;justify-content:center;
    }
    .authModalClose:active{background:rgba(11,16,34,.12);}

    .authTabs{
      display:flex;gap:0;
      background:rgba(11,16,34,.07);
      border-radius:14px;padding:4px;
      margin-bottom:22px;
    }
    .authTab{
      flex:1;border:none;background:transparent;
      padding:10px;border-radius:11px;
      font-size:14px;font-weight:800;
      color:rgba(11,16,34,.50);cursor:pointer;
      transition:all .18s ease;
    }
    .authTab.active{
      background:#fff;color:var(--ink);
      box-shadow:0 2px 12px rgba(0,0,0,.12);
    }

    .authForm{display:none;}
    .authForm.active{display:block;}

    .authField{margin-bottom:12px;}
    .authField label{
      display:block;font-size:12px;font-weight:800;
      color:rgba(11,16,34,.60);margin-bottom:6px;
    }
    .authField input{
      width:100%;border-radius:14px;
      border:1.5px solid rgba(11,16,34,.12);
      padding:13px 14px;font-size:15px;
      color:var(--ink);outline:none;
      transition:border-color .15s;background:#fff;
    }
    .authField input:focus{border-color:var(--cta);}

    .authError{
      display:none;
      background:rgba(239,68,68,.08);
      border:1px solid rgba(239,68,68,.25);
      border-radius:12px;padding:10px 12px;
      font-size:13px;font-weight:700;color:#b91c1c;
      margin-bottom:12px;
    }
    .authError.show{display:block;}

    .authSuccess{
      display:none;
      background:rgba(35,199,182,.08);
      border:1px solid rgba(35,199,182,.30);
      border-radius:12px;padding:10px 12px;
      font-size:13px;font-weight:700;color:#0a3a34;
      margin-bottom:12px;
    }
    .authSuccess.show{display:block;}

    .btnPrimary{
      width:100%;border:none;border-radius:14px;
      padding:15px;font-size:15px;font-weight:800;
      background:linear-gradient(180deg,#0b1022,#1a2340);
      color:#fff;cursor:pointer;margin-bottom:10px;transition:opacity .15s;
    }
    .btnPrimary:active{opacity:.85;}
    .btnPrimary:disabled{opacity:.55;cursor:not-allowed;}

    .btnGoogle{
      width:100%;border:1.5px solid rgba(11,16,34,.14);
      border-radius:14px;padding:14px;font-size:15px;font-weight:800;
      background:#fff;color:var(--ink);cursor:pointer;
      display:flex;align-items:center;justify-content:center;
      gap:10px;transition:background .15s;
    }
    .btnGoogle:active{background:#f5f5f5;}
    .btnGoogle svg{flex:0 0 20px;}

    .authDivider{
      display:flex;align-items:center;gap:10px;margin:14px 0;
    }
    .authDivider::before,.authDivider::after{
      content:"";flex:1;height:1px;background:rgba(11,16,34,.10);
    }
    .authDivider span{font-size:12px;font-weight:700;color:rgba(11,16,34,.40);}

    .forgotLink{
      display:block;text-align:right;font-size:12px;font-weight:700;
      color:rgba(11,16,34,.50);cursor:pointer;
      margin-top:-4px;margin-bottom:14px;
      background:none;border:none;padding:0;
    }
    .forgotLink:hover{color:var(--ink);}

    /* Loading spinner overlay */
    .authSpinner{
      display:none;position:absolute;inset:0;
      background:rgba(255,255,255,.70);border-radius:24px;
      align-items:center;justify-content:center;z-index:10;
    }
    .authSpinner.show{display:flex;}
    .spinner{
      width:32px;height:32px;
      border:3px solid rgba(11,16,34,.15);
      border-top-color:var(--cta);border-radius:50%;
      animation:spin .7s linear infinite;
    }
    @keyframes spin{to{transform:rotate(360deg)}}

    /* =============== APP SHELL =============== */
    .app{
      height:100%;
      background:#123d1f;
      display:flex;
    }
    .appShell{
      flex:1;
      margin:14px;
      background:#f6f7fb;
      border-radius:22px;
      overflow:hidden;
      display:flex;
      flex-direction:column;
      box-shadow:var(--shadow);
      position:relative;
    }
    .topbar{
      padding:calc(env(safe-area-inset-top,0px) + 16px) 16px 12px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      background:#f6f7fb;
      z-index:2;
    }
    .topbar h1{font-size:22px;color:var(--ink);font-weight:850;}
    .gear{
      width:40px;height:40px;
      border-radius:14px;
      border:1px solid var(--stroke);
      background:#fff;
      cursor:pointer;
    }
    .gear:active{transform:translateY(1px)}

    .tabs{
      display:flex;gap:10px;
      padding:0 16px 12px;
      background:#f6f7fb;z-index:2;
    }
    .tab{
      padding:10px 14px;border-radius:999px;
      background:var(--pill);border:none;
      font-weight:750;font-size:13px;
      color:rgba(11,16,34,.75);cursor:pointer;
    }
    .tab.active{background:var(--pillActive);color:var(--ink);}

    .ideaTabs{display:flex;gap:10px;margin-bottom:12px;}
    .ideaTab{
      padding:10px 14px;border-radius:999px;
      background:var(--pill);border:none;
      font-weight:750;font-size:13px;
      color:rgba(11,16,34,.75);cursor:pointer;
    }
    .ideaTab.active{background:var(--pillActive);color:var(--ink);}

    .content{flex:1;overflow:hidden;background:#f6f7fb;}

    .carousel{
      height:100%;display:flex;gap:14px;
      overflow-x:auto;scroll-snap-type:x mandatory;
      -webkit-overflow-scrolling:touch;
      padding:6px 16px 92px;
    }
    .carousel::-webkit-scrollbar{display:none}

    .objCard{
      flex:0 0 calc(100% - 32px);height:100%;
      scroll-snap-align:start;background:var(--card);
      border-radius:20px;overflow:hidden;
      display:flex;flex-direction:column;
      box-shadow:var(--shadow2);
      border:1px solid rgba(0,0,0,.06);
      cursor:pointer;transition:opacity .18s ease;
    }
    .objCard.done{opacity:.62;}
    .objCard.done .objImg{filter:saturate(.85) contrast(.95);}
    .objCard.done .objTitle,.objCard.done .objMeta{color:rgba(11,16,34,.55);}
    .objImg{flex:1;background:center/cover no-repeat;}
    .objBody{
      padding:16px;display:flex;
      align-items:flex-start;justify-content:space-between;gap:12px;
    }
    .objTitle{font-size:16px;font-weight:850;color:var(--ink);line-height:1.15;}
    .objMeta{margin-top:6px;font-size:13px;color:var(--inkMuted);font-weight:650;}
    .badge{
      flex:0 0 auto;font-size:11px;font-weight:850;
      padding:8px 10px;border-radius:999px;
      background:rgba(0,0,0,.06);color:rgba(11,16,34,.75);
      border:1px solid rgba(0,0,0,.06);white-space:nowrap;
    }
    .badge.done{
      background:rgba(35,199,182,.18);
      border-color:rgba(35,199,182,.30);color:#0a3a34;
    }

    #map{height:100%;width:100%;}
    .leaflet-container{background:#f6f7fb;}

    .profileWrap{
      height:100%;overflow:auto;
      padding:8px 16px 92px;
      -webkit-overflow-scrolling:touch;
    }
    .sectionTitle{
      margin:10px 2px 10px;font-size:14px;
      font-weight:900;color:rgba(11,16,34,.78);
    }
    .kpiGrid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px;}
    .kpi{
      background:#fff;border-radius:18px;
      border:1px solid rgba(0,0,0,.06);
      box-shadow:var(--shadow2);padding:14px;
    }
    .kpi .label{font-size:12px;color:rgba(11,16,34,.55);font-weight:800;}
    .kpi .value{margin-top:8px;font-size:22px;color:var(--ink);font-weight:950;letter-spacing:-.4px;}
    .kpi .sub{margin-top:6px;font-size:12px;color:rgba(11,16,34,.55);font-weight:700;}

    /* User card in profile */
    .userCard{
      background:#fff;border-radius:18px;
      border:1px solid rgba(0,0,0,.06);
      box-shadow:var(--shadow2);
      padding:16px;margin-bottom:12px;
      display:flex;align-items:center;gap:14px;
    }
    .userAvatar{
      width:48px;height:48px;border-radius:50%;
      background:linear-gradient(135deg,var(--cta),var(--cta2));
      display:flex;align-items:center;justify-content:center;
      font-size:20px;font-weight:900;color:#fff;
      flex:0 0 auto;overflow:hidden;
    }
    .userAvatar img{width:100%;height:100%;object-fit:cover;}
    .userName{font-size:14px;font-weight:900;color:var(--ink);}
    .userEmail{font-size:12px;color:rgba(11,16,34,.55);font-weight:700;margin-top:3px;}
    .btnSignOut{
      margin-left:auto;
      border:1.5px solid rgba(11,16,34,.12);
      background:#fff;border-radius:12px;
      padding:9px 12px;font-size:12px;
      font-weight:800;color:rgba(11,16,34,.65);
      cursor:pointer;white-space:nowrap;
    }
    .btnSignOut:active{background:#f5f5f5;}

    .list{
      background:#fff;border-radius:18px;
      border:1px solid rgba(0,0,0,.06);
      box-shadow:var(--shadow2);overflow:hidden;
    }
    .rowItem{
      display:flex;align-items:flex-start;
      justify-content:space-between;gap:10px;
      padding:14px;border-top:1px solid rgba(0,0,0,.06);
    }
    .rowItem:first-child{border-top:none}
    .rowLeft{min-width:0;}
    .rowItem strong{display:block;color:var(--ink);font-size:13px;line-height:1.2;}
    .rowItem small{display:block;margin-top:6px;color:rgba(11,16,34,.55);font-weight:700;font-size:12px;}
    .cost{font-weight:950;color:rgba(11,16,34,.78);font-size:13px;white-space:nowrap;}

    /* DETALLE */
    .detail{height:100%;background:#123d1f;display:flex;padding:14px;}
    .detailShell{
      flex:1;border-radius:22px;overflow:hidden;
      box-shadow:var(--shadow);position:relative;background:#000;
    }
    .detailHero{
      position:absolute;inset:0;
      background:#000 center/cover no-repeat;cursor:pointer;
    }
    .detailOverlay{
      position:absolute;inset:0;
      background:linear-gradient(180deg,rgba(0,0,0,.15) 0%,rgba(0,0,0,.55) 55%,rgba(0,0,0,.90) 100%);
    }
    .detailTopBtns{
      position:absolute;
      top:calc(env(safe-area-inset-top,0px) + 14px);
      left:14px;right:14px;
      display:flex;justify-content:space-between;align-items:center;z-index:5;
    }
    .iconBtn{
      width:42px;height:42px;border-radius:14px;
      border:1px solid rgba(255,255,255,.22);
      background:rgba(255,255,255,.18);color:#fff;cursor:pointer;
      backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);
    }
    .iconBtn:active{transform:translateY(1px)}
    .detailThumbs{
      position:absolute;top:120px;right:14px;
      z-index:5;display:flex;flex-direction:column;gap:10px;
    }
    .thumb{
      width:54px;height:54px;border-radius:14px;
      border:2px solid rgba(255,255,255,.88);
      background:center/cover no-repeat;cursor:pointer;
      box-shadow:0 10px 25px rgba(0,0,0,.35);
    }
    .thumb.dim{border-color:rgba(255,255,255,.45);opacity:.9;}
    .detailTitleBlock{
      position:absolute;left:18px;right:88px;bottom:300px;z-index:5;color:#fff;
    }
    .detailTitleBlock h2{font-size:28px;font-weight:950;letter-spacing:-.4px;line-height:1.05;}
    .detailTitleBlock .subline{margin-top:10px;font-size:13px;color:rgba(255,255,255,.78);font-weight:700;}
    .sheet{
      position:absolute;left:0;right:0;bottom:0;
      background:#f6f7fb;border-radius:22px 22px 0 0;
      padding:14px 14px 18px;z-index:6;min-height:46%;
    }
    .chips{display:flex;gap:10px;flex-wrap:wrap;padding:4px 4px 10px;}
    .chip{
      display:flex;flex-direction:column;gap:2px;
      background:#fff;border:1px solid rgba(0,0,0,.06);
      box-shadow:var(--shadow2);border-radius:16px;
      padding:10px 12px;min-width:92px;
    }
    .chip .k{font-size:11px;color:rgba(11,16,34,.55);font-weight:900;}
    .chip .v{font-size:14px;color:var(--ink);font-weight:950;}
    .descTitle{padding:6px;font-size:14px;font-weight:950;color:rgba(11,16,34,.78);}
    .desc{
      padding:0 6px 12px;font-size:13px;line-height:1.55;
      color:rgba(11,16,34,.60);max-height:120px;overflow:auto;
    }
    .sheetBottom{
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      padding:6px;padding-bottom:calc(env(safe-area-inset-bottom,0px) + 8px);
    }
    .price{font-weight:950;color:var(--ink);font-size:22px;letter-spacing:-.4px;}
    .action{
      width:56px;height:56px;border-radius:18px;border:none;
      background:#0b1022;color:#fff;font-size:20px;cursor:pointer;box-shadow:var(--shadow2);
    }
    .action:active{transform:translateY(1px)}

    /* NAV */
    .nav{position:absolute;left:14px;right:14px;bottom:14px;pointer-events:none;}
    .navInner{
      pointer-events:auto;height:64px;background:var(--navBg);
      border-radius:18px;display:flex;justify-content:space-around;
      align-items:center;box-shadow:var(--shadow2);border:1px solid rgba(0,0,0,.08);
    }
    .navBtn{
      width:46px;height:46px;border-radius:16px;border:none;
      font-size:20px;background:transparent;color:rgba(11,16,34,.45);cursor:pointer;
    }
    .navBtn.active{background:#0b1022;color:#fff;}
    .navBtn:active{transform:translateY(1px)}

    /* MODALES */
    .modalBack{
      position:absolute;inset:0;background:rgba(0,0,0,.45);
      display:none;align-items:flex-end;justify-content:center;
      padding:14px;z-index:80;
    }
    .modalBack.show{display:flex;}
    .modal{
      width:100%;background:#fff;border-radius:20px;
      box-shadow:var(--shadow);border:1px solid rgba(0,0,0,.08);overflow:hidden;
    }
    .modalHead{
      display:flex;align-items:center;justify-content:space-between;
      padding:12px 12px 10px;border-bottom:1px solid rgba(0,0,0,.08);
    }
    .modalHead strong{color:var(--ink);font-size:14px;}
    .close{
      border:none;width:40px;height:40px;border-radius:14px;
      background:rgba(0,0,0,.06);cursor:pointer;color:var(--ink);font-size:18px;
    }
    .modalBody{
      padding:12px;max-height:min(72vh,600px);
      overflow:auto;-webkit-overflow-scrolling:touch;
    }
    .modalActions{
      display:flex;gap:10px;padding:12px;border-top:1px solid rgba(0,0,0,.08);
    }
    .primary,.ghost,.danger{
      flex:1;border-radius:14px;padding:12px;font-weight:900;
      border:1px solid rgba(0,0,0,.10);cursor:pointer;font-size:13px;
    }
    .ghost{background:#fff;color:var(--ink);}
    .primary{background:#0b1022;color:#fff;border-color:#0b1022;}
    .danger{background:#fff;color:#b91c1c;border-color:rgba(185,28,28,.35);}

    .miniList{display:grid;gap:10px;}
    .miniItem{
      background:#fff;border:1px solid rgba(0,0,0,.08);
      box-shadow:var(--shadow2);border-radius:16px;overflow:hidden;
      display:flex;gap:10px;cursor:pointer;transition:opacity .18s ease;
    }
    .miniItem.done{opacity:.62;}
    .miniImg{width:72px;height:72px;background:center/cover no-repeat;flex:0 0 auto;}
    .miniText{padding:10px 10px 10px 0;min-width:0;flex:1;}
    .miniText b{display:block;color:var(--ink);font-size:13px;line-height:1.2;}
    .miniText span{display:block;margin-top:6px;color:rgba(11,16,34,.55);font-weight:700;font-size:12px;}
    .tag{
      align-self:center;margin-right:10px;font-size:11px;font-weight:900;
      padding:7px 10px;border-radius:999px;background:rgba(0,0,0,.06);
      color:rgba(11,16,34,.75);border:1px solid rgba(0,0,0,.06);white-space:nowrap;
    }
    .tag.done{background:rgba(35,199,182,.18);border-color:rgba(35,199,182,.30);color:#0a3a34;}

    .form{display:grid;gap:10px;}
    .field label{display:block;font-size:12px;font-weight:900;color:rgba(11,16,34,.65);margin:2px 2px 6px;}
    .field input,.field select,.field textarea{
      width:100%;border-radius:14px;border:1px solid rgba(0,0,0,.10);
      padding:12px;font-size:14px;outline:none;
    }
    .field textarea{min-height:96px;resize:none;}
    .inline{display:flex;gap:10px;}
    .inline .field{flex:1;}
    .switchRow{
      display:flex;align-items:center;justify-content:space-between;
      gap:12px;padding:10px 12px;border:1px solid rgba(0,0,0,.10);border-radius:14px;
    }
    .switchRow span{font-size:13px;color:rgba(11,16,34,.70);font-weight:900;}
    .smallNote{font-size:12px;color:rgba(11,16,34,.55);font-weight:700;padding:2px 2px 8px;}
    .fileRow{
      display:flex;gap:10px;align-items:center;flex-wrap:wrap;
      padding:10px 12px;border:1px solid rgba(0,0,0,.10);
      border-radius:14px;background:rgba(0,0,0,.02);
    }
    .fileRow button{
      border:none;border-radius:12px;padding:10px 12px;
      background:#0b1022;color:#fff;font-weight:900;cursor:pointer;font-size:12px;
    }
    .fileRow button:active{transform:translateY(1px)}
    .fileRow span{font-size:12px;font-weight:800;color:rgba(11,16,34,.65);}
    .hiddenInput{display:none}

    /* LIGHTBOX */
    .lightbox{
      position:absolute;inset:0;background:rgba(0,0,0,.92);
      display:none;z-index:120;padding:14px;
    }
    .lightbox.show{display:block;}
    .lbTop{
      display:flex;justify-content:space-between;align-items:center;
      padding-top:calc(env(safe-area-inset-top,0px) + 6px);margin-bottom:12px;
    }
    .lbBtn{
      width:42px;height:42px;border-radius:14px;
      border:1px solid rgba(255,255,255,.18);background:rgba(255,255,255,.10);
      color:#fff;cursor:pointer;backdrop-filter:blur(10px);
    }
    .lbBtn:active{transform:translateY(1px)}
    .lbCounter{color:rgba(255,255,255,.85);font-weight:900;font-size:13px;}
    .lbStage{
      height:calc(100% - 120px);display:flex;
      align-items:center;justify-content:center;user-select:none;touch-action:pan-y;
    }
    .lbImg{
      max-width:100%;max-height:100%;border-radius:18px;
      box-shadow:0 20px 70px rgba(0,0,0,.55);object-fit:contain;background:#111;
    }
    .lbNav{
      position:absolute;left:14px;right:14px;top:50%;
      transform:translateY(-50%);display:flex;
      justify-content:space-between;pointer-events:none;
    }
    .lbNav .lbBtn{pointer-events:auto;}
    .lbHint{
      position:absolute;left:14px;right:14px;
      bottom:calc(env(safe-area-inset-bottom,0px) + 18px);
      text-align:center;color:rgba(255,255,255,.6);font-size:12px;font-weight:800;
    }

    /* WIZARD */
    .wizardStep{display:none;}
    .wizardStep.active{display:block;}
    .wizardDots{display:flex;gap:8px;justify-content:center;margin:8px 0 10px;}
    .dot{width:8px;height:8px;border-radius:999px;background:rgba(11,16,34,.18);}
    .dot.active{background:rgba(11,16,34,.75);}

    /* COVER GRID */
    .coverGrid{
      display:grid;grid-template-columns:1fr 1fr 1fr;
      gap:10px;margin-top:10px;margin-bottom:10px;
    }
    .coverOpt{
      border-radius:14px;border:2px solid rgba(0,0,0,.10);overflow:hidden;
      cursor:pointer;background:#f0f0f0;box-shadow:var(--shadow2);
      transition:transform .12s ease,border-color .12s ease;position:relative;
    }
    .coverOpt:active{transform:translateY(1px)}
    .coverOpt img{width:100%;height:78px;object-fit:cover;display:block;}
    .coverOpt.selected{border-color:rgba(35,199,182,.85);}
    .coverOpt .cap{padding:6px 8px;font-size:11px;font-weight:900;color:rgba(11,16,34,.70);}
    .coverSkeleton{
      width:100%;height:78px;
      background:linear-gradient(90deg,#e8e8e8 25%,#f5f5f5 50%,#e8e8e8 75%);
      background-size:200% 100%;animation:shimmer 1.4s infinite;border-radius:12px 12px 0 0;
    }
    @keyframes shimmer{0%{background-position:200% 0}100%{background-position:-200% 0}}

    .pexelsCredit{font-size:10px;color:rgba(11,16,34,.40);font-weight:700;text-align:right;padding:2px 2px 6px;}
    .pexelsCredit a{color:rgba(11,16,34,.55);text-decoration:none;}
    .apiNotice{
      background:rgba(255,193,7,.12);border:1px solid rgba(255,193,7,.40);
      border-radius:12px;padding:10px 12px;font-size:12px;
      color:rgba(11,16,34,.75);font-weight:700;margin-bottom:10px;
    }
    .apiNotice a{color:#0b1022;text-decoration:underline;}

    /* btn la lista */
    .btn{
      width:100%;border:none;border-radius:999px;padding:16px;
      font-size:16px;font-weight:750;
      background:linear-gradient(180deg,var(--cta),var(--cta2));
      color:#062a26;cursor:pointer;
    }
    .btn:active{transform:translateY(1px)}
  </style>
</head>

<body>
<div class="frame">

  <!-- LIGHTBOX -->
  <div class="lightbox" id="lightbox">
    <div class="lbTop">
      <button class="lbBtn" id="lbClose">‚úï</button>
      <div class="lbCounter" id="lbCounter">1/1</div>
      <div style="width:42px;height:42px;"></div>
    </div>
    <div class="lbStage" id="lbStage">
      <img class="lbImg" id="lbImg" alt="Foto" />
    </div>
    <div class="lbNav">
      <button class="lbBtn" id="lbPrev">‚Äπ</button>
      <button class="lbBtn" id="lbNext">‚Ä∫</button>
    </div>
    <div class="lbHint">Deslice ‚óÄ ‚ñ∂ para cambiar ¬∑ toque fuera para cerrar</div>
  </div>

  <!-- =============== PANTALLA ONBOARDING + AUTH =============== -->
  <div class="screen active" id="screen-auth">

    <!-- Fondo con foto y textos -->
    <section class="onboarding">
      <div class="obLogo">LA LISTA</div>
      <div class="obHero">
        <div class="obTitle">Tus objetivos.<br>Tu historia.</div>
        <div class="obSubtitle">
          Hola. Bienvenido a <b>La Lista</b>.<br>
          Aqu√≠ guardas lo que quieres hacer, vivir y cumplir,
          para no perder el foco en lo que de verdad importa.
          No es una app m√°s. Es un recordatorio.
        </div>
      </div>
      <div class="obButtons">
        <button class="btnEntrar" id="openLoginBtn">Entrar ‚Üí</button>
        <button class="btnRegistrar" id="openRegisterBtn">Crear una cuenta</button>
      </div>
    </section>

    <!-- POPUP AUTH MODAL (sobre el onboarding) -->
    <div class="authModalBack" id="authModalBack">
      <div class="authCard">

        <!-- Bot√≥n cerrar -->
        <button class="authModalClose" id="authModalClose">‚úï</button>

        <!-- Spinner -->
        <div class="authSpinner" id="authSpinner"><div class="spinner"></div></div>

        <!-- Tabs -->
        <div class="authTabs">
          <button class="authTab active" id="tabLogin">Entrar</button>
          <button class="authTab" id="tabRegister">Registrarse</button>
        </div>

        <!-- ===== FORM LOGIN ===== -->
        <div class="authForm active" id="formLogin">
          <div class="authError" id="loginError"></div>

          <div class="authField">
            <label>Correo electr√≥nico</label>
            <input id="loginEmail" type="email" placeholder="tu@correo.com" autocomplete="email" />
          </div>
          <div class="authField">
            <label>Contrase√±a</label>
            <input id="loginPass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password" />
          </div>

          <button class="forgotLink" id="forgotBtn">¬øOlvidaste tu contrase√±a?</button>
          <button class="btnPrimary" id="loginBtn">Entrar ‚Üí</button>

          <div class="authDivider"><span>o contin√∫a con</span></div>

          <button class="btnGoogle" id="loginGoogleBtn">
            <svg viewBox="0 0 48 48"><path fill="#FFC107" d="M43.6 20H24v8h11.3C33.7 33.6 29.3 36 24 36c-6.6 0-12-5.4-12-12s5.4-12 12-12c3 0 5.7 1.1 7.8 2.9l6-6C34.5 6.4 29.5 4 24 4 12.9 4 4 12.9 4 24s8.9 20 20 20c11 0 19.7-8 19.7-20 0-1.3-.1-2.7-.1-4z"/><path fill="#FF3D00" d="M6.3 14.7l6.9 5.1C15 16 19.2 13 24 13c3 0 5.7 1.1 7.8 2.9l6-6C34.5 6.4 29.5 4 24 4 16.3 4 9.7 8.4 6.3 14.7z"/><path fill="#4CAF50" d="M24 44c5.2 0 9.9-1.9 13.5-5l-6.2-5.2C29.4 35.6 26.8 36.5 24 36.5c-5.2 0-9.6-3.4-11.2-8l-6.9 5.3C9.6 39.5 16.3 44 24 44z"/><path fill="#1976D2" d="M43.6 20H24v8h11.3c-.8 2.3-2.3 4.3-4.3 5.8l6.2 5.2c3.6-3.4 5.8-8.4 5.8-13.9 0-1.3-.1-2.7-.1-4-.1 0 0-.1 0-.1z"/></svg>
            Continuar con Google
          </button>
        </div>

        <!-- ===== FORM REGISTRO ===== -->
        <div class="authForm" id="formRegister">
          <div class="authError" id="registerError"></div>
          <div class="authSuccess" id="registerSuccess"></div>

          <div class="authField">
            <label>Nombre</label>
            <input id="registerName" type="text" placeholder="Tu nombre" autocomplete="name" />
          </div>
          <div class="authField">
            <label>Correo electr√≥nico</label>
            <input id="registerEmail" type="email" placeholder="tu@correo.com" autocomplete="email" />
          </div>
          <div class="authField">
            <label>Contrase√±a (m√≠n. 6 caracteres)</label>
            <input id="registerPass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="new-password" />
          </div>

          <button class="btnPrimary" id="registerBtn">Crear cuenta ‚Üí</button>

          <div class="authDivider"><span>o contin√∫a con</span></div>

          <button class="btnGoogle" id="registerGoogleBtn">
            <svg viewBox="0 0 48 48"><path fill="#FFC107" d="M43.6 20H24v8h11.3C33.7 33.6 29.3 36 24 36c-6.6 0-12-5.4-12-12s5.4-12 12-12c3 0 5.7 1.1 7.8 2.9l6-6C34.5 6.4 29.5 4 24 4 12.9 4 4 12.9 4 24s8.9 20 20 20c11 0 19.7-8 19.7-20 0-1.3-.1-2.7-.1-4z"/><path fill="#FF3D00" d="M6.3 14.7l6.9 5.1C15 16 19.2 13 24 13c3 0 5.7 1.1 7.8 2.9l6-6C34.5 6.4 29.5 4 24 4 16.3 4 9.7 8.4 6.3 14.7z"/><path fill="#4CAF50" d="M24 44c5.2 0 9.9-1.9 13.5-5l-6.2-5.2C29.4 35.6 26.8 36.5 24 36.5c-5.2 0-9.6-3.4-11.2-8l-6.9 5.3C9.6 39.5 16.3 44 24 44z"/><path fill="#1976D2" d="M43.6 20H24v8h11.3c-.8 2.3-2.3 4.3-4.3 5.8l6.2 5.2c3.6-3.4 5.8-8.4 5.8-13.9 0-1.3-.1-2.7-.1-4-.1 0 0-.1 0-.1z"/></svg>
            Continuar con Google
          </button>
        </div>

      </div><!-- /authCard -->
    </div><!-- /authModalBack -->

  </div><!-- /screen-auth -->

  <!-- =============== APP =============== -->
  <div class="screen" id="screen-app">
    <section class="app">
      <div class="appShell">

        <div class="topbar">
          <h1 id="pageTitle">Mis objetivos</h1>
          <div style="display:flex;gap:8px;">
            <button class="gear" id="searchBtn">üîç</button>
            <button class="gear" id="gearBtn">‚öôÔ∏è</button>
          </div>
        </div>

        <div id="homeHeader">
          <div class="tabs">
            <button class="tab active" data-cat="Todos">Todos</button>
            <button class="tab" data-cat="Viajes">Viajes</button>
            <button class="tab" data-cat="Experiencias">Experiencias</button>
          </div>
          <div style="padding:0 16px 12px;">
            <button class="btn" id="addWizardBtn">A√±adir objetivo</button>
          </div>
        </div>

        <div class="content" id="view-home"><div class="carousel" id="carousel"></div></div>
        <div class="content" id="view-compass" style="display:none;"><div id="map"></div></div>
        <div class="content" id="view-profile" style="display:none;">
          <div class="profileWrap">
            <!-- User info card -->
            <div class="userCard" id="userCard">
              <div class="userAvatar" id="userAvatar">?</div>
              <div>
                <div class="userName" id="userName">‚Äî</div>
                <div class="userEmail" id="userEmail">‚Äî</div>
              </div>
              <button class="btnSignOut" id="signOutBtn">Cerrar sesi√≥n</button>
            </div>

            <div class="sectionTitle">Resumen</div>
            <div class="kpiGrid">
              <div class="kpi"><div class="label">Pendientes</div><div class="value" id="kpiPend">0</div><div class="sub">Por cumplir</div></div>
              <div class="kpi"><div class="label">Cumplidos</div><div class="value" id="kpiDone">0</div><div class="sub">Completados</div></div>
              <div class="kpi"><div class="label">Coste total</div><div class="value" id="kpiCostTotal">0‚Ç¨</div><div class="sub">Suma de todos</div></div>
              <div class="kpi"><div class="label">Coste pendiente</div><div class="value" id="kpiCostPend">0‚Ç¨</div><div class="sub">Lo que queda</div></div>
            </div>
            <div class="sectionTitle">Pendientes</div>
            <div class="list" id="listPend"></div>
            <div class="sectionTitle" style="margin-top:14px;">Cumplidos</div>
            <div class="list" id="listDone"></div>
          </div>
        </div>

        <!-- AJUSTES MODAL -->
        <div class="modalBack" id="settingsBack">
          <div class="modal">
            <div class="modalHead">
              <strong>Ajustes ¬∑ Objetivos</strong>
              <button class="close" id="settingsClose">‚úï</button>
            </div>
            <div class="modalBody">
              <div id="settingsListView">
                <div class="smallNote">Toque un objetivo para editarlo.</div>
                <div class="miniList" id="settingsList"></div>
              </div>
              <div id="settingsFormView" style="display:none;">
                <div class="smallNote" id="formModeNote">Editar objetivo</div>
                <form class="form" id="objForm" onsubmit="return false;">
                  <div class="field"><label>T√≠tulo</label><input id="fTitle" type="text" placeholder="Ej: Ver auroras boreales" /></div>
                  <div class="inline">
                    <div class="field"><label>Categor√≠a</label><select id="fCat"><option>Viajes</option><option>Experiencias</option><option>Familia</option><option>Trabajo</option></select></div>
                    <div class="field"><label>Coste (‚Ç¨)</label><input id="fCost" type="number" min="0" step="1" placeholder="0" /></div>
                  </div>
                  <div class="switchRow"><span>¬øCumplido?</span><input id="fDone" type="checkbox" /></div>
                  <div class="field"><label>Descripci√≥n</label><textarea id="fDesc" placeholder="Escriba el por qu√©‚Ä¶"></textarea></div>
                  <div class="field"><label>Imagen principal (URL)</label><input id="fImg0" type="url" placeholder="https://‚Ä¶" /></div>
                  <div class="inline">
                    <div class="field"><label>Miniatura 1 (URL)</label><input id="fImg1" type="url" placeholder="https://‚Ä¶" /></div>
                    <div class="field"><label>Miniatura 2 (URL)</label><input id="fImg2" type="url" placeholder="https://‚Ä¶" /></div>
                  </div>
                  <div class="field"><label>Miniatura 3 (URL)</label><input id="fImg3" type="url" placeholder="https://‚Ä¶" /></div>
                  <div class="field">
                    <label>Fotos del m√≥vil (la primera ser√° portada)</label>
                    <div class="fileRow"><button type="button" id="pickLocalBtn">A√±adir fotos</button><span id="localCount">0 seleccionadas</span></div>
                    <input class="hiddenInput" id="localFiles" type="file" accept="image/*" multiple />
                  </div>
                  <div class="field"><label>Lugar</label><input id="fPlace" type="text" placeholder="Ej: Troms√∏, Noruega" /></div>
                  <div class="inline">
                    <div class="field"><label>Latitud</label><input id="fLat" type="number" step="0.000001" placeholder="69.6492" /></div>
                    <div class="field"><label>Longitud</label><input id="fLng" type="number" step="0.000001" placeholder="18.9553" /></div>
                  </div>
                  <div class="smallNote">Sin lat/lng no aparece en el mapa.</div>
                </form>
              </div>
            </div>
            <div class="modalActions" id="settingsActionsList">
              <button class="ghost" id="btnAdd">A√±adir</button>
              <button class="primary" id="btnCloseList">Cerrar</button>
            </div>
            <div class="modalActions" id="settingsActionsForm" style="display:none;">
              <button class="danger" id="btnDelete">Borrar</button>
              <button class="ghost" id="btnBackToList">Volver</button>
              <button class="primary" id="btnSave">Guardar</button>
            </div>
          </div>
        </div>

        <!-- IDEAS MODAL -->
        <div class="modalBack" id="ideasBack">
          <div class="modal">
            <div class="modalHead"><strong>Explorar ideas</strong><button class="close" id="ideasClose">‚úï</button></div>
            <div class="modalBody">
              <div class="ideaTabs">
                <button class="ideaTab active" data-idea-cat="Viajes">Viajes</button>
                <button class="ideaTab" data-idea-cat="Familia">Familia</button>
                <button class="ideaTab" data-idea-cat="Trabajo">Trabajo</button>
              </div>
              <div class="smallNote">Toque "A√±adir" para a√±adirlo paso a paso.</div>
              <div class="miniList" id="ideasList"></div>
            </div>
            <div class="modalActions"><button class="primary" id="ideasClose2">Cerrar</button></div>
          </div>
        </div>

        <!-- WIZARD MODAL -->
        <div class="modalBack" id="wizardBack">
          <div class="modal">
            <div class="modalHead"><strong>Nuevo objetivo</strong><button class="close" id="wizardClose">‚úï</button></div>
            <div class="modalBody">
              <div class="wizardDots" id="wizardDots"></div>

              <div class="wizardStep active" data-step="0">
                <div class="smallNote">Paso 1 ¬∑ T√≠tulo</div>
                <div class="field"><label>T√≠tulo</label><input id="wTitle" type="text" placeholder="Ej: Dormir en un igl√∫" /></div>
              </div>

              <div class="wizardStep" data-step="1">
                <div class="smallNote">Paso 2 ¬∑ Categor√≠a + Coste</div>
                <div class="field"><label>Categor√≠a</label><select id="wCat"><option>Viajes</option><option>Experiencias</option><option>Familia</option><option>Trabajo</option></select></div>
                <div class="field"><label>Coste (‚Ç¨)</label><input id="wCost" type="number" min="0" step="1" placeholder="0" /></div>
              </div>

              <div class="wizardStep" data-step="2">
                <div class="smallNote">Paso 3 ¬∑ Descripci√≥n</div>
                <div class="field"><label>Descripci√≥n</label><textarea id="wDesc" placeholder="¬øPor qu√© lo quieres hacer?"></textarea></div>
              </div>

              <div class="wizardStep" data-step="3">
                <div class="smallNote">Paso 4 ¬∑ Lugar + Coordenadas (opcional)</div>
                <div class="field"><label>Lugar</label><input id="wPlace" type="text" placeholder="Ej: Troms√∏, Noruega" /></div>
                <div class="inline">
                  <div class="field"><label>Lat</label><input id="wLat" type="number" step="0.000001" placeholder="69.6492" /></div>
                  <div class="field"><label>Lng</label><input id="wLng" type="number" step="0.000001" placeholder="18.9553" /></div>
                </div>
              </div>

              <div class="wizardStep" data-step="4">
                <div class="smallNote">Paso 5 ¬∑ Foto</div>
                <div class="field">
                  <label>Buscar im√°genes (Pexels)</label>
                  <div style="display:flex;gap:8px;">
                    <input id="wSearchQuery" type="text" placeholder="Ej: aurora boreal noruega" style="flex:1;" />
                    <button type="button" id="wSearchBtn" style="border:none;border-radius:14px;padding:12px 14px;background:#0b1022;color:#fff;font-weight:900;cursor:pointer;font-size:13px;">Buscar</button>
                  </div>
                </div>
                <div id="pexelsApiNotice" class="apiNotice" style="display:none;">‚ö†Ô∏è A√±ade tu API key de <a href="https://www.pexels.com/api/" target="_blank">Pexels (gratis)</a> para activar la b√∫squeda.</div>
                <div class="coverGrid" id="coverGrid"></div>
                <div class="pexelsCredit" id="pexelsCredit" style="display:none;">Fotos de <a href="https://www.pexels.com" target="_blank">Pexels</a></div>
                <div class="field" style="margin-top:8px;"><label>O pega una URL directamente</label><input id="wImgUrl" type="url" placeholder="https://‚Ä¶" /></div>
                <div class="field">
                  <label>Fotos del m√≥vil (local)</label>
                  <div class="fileRow"><button type="button" id="wPickLocalBtn">A√±adir fotos</button><span id="wLocalCount">0 seleccionadas</span></div>
                  <input class="hiddenInput" id="wLocalFiles" type="file" accept="image/*" multiple />
                </div>
              </div>
            </div>
            <div class="modalActions">
              <button class="ghost" id="wPrev">Atr√°s</button>
              <button class="primary" id="wNext">Siguiente</button>
            </div>
          </div>
        </div>

      </div>

      <div class="nav">
        <div class="navInner">
          <button class="navBtn active" data-nav="home">‚åÇ</button>
          <button class="navBtn" data-nav="compass">üß≠</button>
          <button class="navBtn" data-nav="profile">üë§</button>
        </div>
      </div>
    </section>
  </div>

  <!-- DETALLE -->
  <div class="screen" id="screen-detail">
    <section class="detail">
      <div class="detailShell">
        <div class="detailHero" id="detailHero"></div>
        <div class="detailOverlay"></div>
        <div class="detailTopBtns">
          <button class="iconBtn" id="backBtn">‚Üê</button>
          <button class="iconBtn" id="toggleDoneTop">‚ô°</button>
        </div>
        <div class="detailThumbs" id="detailThumbs"></div>
        <div class="detailTitleBlock">
          <h2 id="detailTitle">‚Äî</h2>
          <div class="subline" id="detailSub">‚Äî</div>
        </div>
        <div class="sheet">
          <div class="chips">
            <div class="chip"><div class="k">Categor√≠a</div><div class="v" id="chipCat">‚Äî</div></div>
            <div class="chip"><div class="k">Estado</div><div class="v" id="chipState">‚Äî</div></div>
            <div class="chip"><div class="k">Coste</div><div class="v" id="chipCost">‚Äî</div></div>
          </div>
          <div class="descTitle">Descripci√≥n</div>
          <div class="desc" id="detailDesc">‚Äî</div>
          <div class="sheetBottom">
            <div>
              <div style="font-size:12px;color:rgba(11,16,34,.55);font-weight:900;">Coste total</div>
              <div class="price" id="detailPrice">‚Äî</div>
            </div>
            <button class="action" id="toggleDoneBtn">‚Ä∫</button>
          </div>
        </div>
      </div>
    </section>
  </div>

</div><!-- /frame -->

<script>
/* ================================================================
   PEXELS API
================================================================ */
const PEXELS_API_KEY = "TU_API_KEY_AQUI";

async function fetchPexelsImages(query, perPage){
  perPage = perPage || 3;
  const hasKey = PEXELS_API_KEY && PEXELS_API_KEY !== "TU_API_KEY_AQUI";
  if(!hasKey) return { photos: getFallbackImages(query), hasKey: false };
  try{
    const res = await fetch(
      "https://api.pexels.com/v1/search?query=" + encodeURIComponent(query) + "&per_page=" + perPage + "&orientation=landscape",
      { headers: { "Authorization": PEXELS_API_KEY } }
    );
    if(!res.ok) throw new Error("pexels " + res.status);
    const data = await res.json();
    if(!data.photos || !data.photos.length) return { photos: getFallbackImages(query), hasKey: true };
    return {
      photos: data.photos.map(p => ({ url: p.src.large2x || p.src.large, thumb: p.src.medium, photographer: p.photographer })),
      hasKey: true
    };
  }catch(e){
    return { photos: getFallbackImages(query), hasKey: false };
  }
}

function getFallbackImages(query){
  return [0,1,2].map(i => ({
    url: "https://picsum.photos/seed/" + encodeURIComponent(query + i) + "/800/500",
    thumb: "https://picsum.photos/seed/" + encodeURIComponent(query + i) + "/400/250",
    photographer: "Lorem Picsum"
  }));
}

/* ================================================================
   STORAGE (por usuario ‚Äî clave incluye uid)
================================================================ */
const BASE_KEY = "lalista_v6_";
let currentUid = null;

function storageKey(){
  return BASE_KEY + (currentUid || "guest");
}
function loadObjetivos(){
  try{
    const raw = localStorage.getItem(storageKey());
    if(!raw) return [];
    const d = JSON.parse(raw);
    return Array.isArray(d) ? d : [];
  }catch(e){ return []; }
}
function saveObjetivos(){
  localStorage.setItem(storageKey(), JSON.stringify(objetivos));
}

let objetivos = [];

/* ================================================================
   HELPERS
================================================================ */
const $ = q => document.querySelector(q);
const $$ = q => document.querySelectorAll(q);
const eur = n => (Math.round((Number(n)||0)*100)/100).toLocaleString("es-ES") + "‚Ç¨";
function escapeHTML(str){
  return String(str).replace(/[&<>"']/g, s => ({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"}[s]));
}
function firstImg(o){ return (o.imgs && o.imgs.length) ? o.imgs[0] : ""; }

/* ================================================================
   FIREBASE AUTH ‚Äî espera a que el m√≥dulo est√© listo
================================================================ */
function waitFirebase(cb){
  if(window._fbOnAuthStateChanged){ cb(); }
  else { window.addEventListener("firebaseReady", cb, { once: true }); }
}

waitFirebase(() => {
  window._fbOnAuthStateChanged(user => {
    if(user){
      currentUid = user.uid;
      objetivos = loadObjetivos();
      showAppScreen(user);
    } else {
      currentUid = null;
      showAuthScreen();
    }
  });
});

/* ================================================================
   AUTH SCREEN LOGIC
================================================================ */
const screenAuth = $("#screen-auth");
const screenApp  = $("#screen-app");
const screenDetail = $("#screen-detail");

/* ---- Popup auth helpers ---- */
function openAuthModal(tab){
  // tab: "login" | "register"
  switchAuthTab(tab || "login");
  $("#authModalBack").classList.add("show");
}
function closeAuthModal(){
  $("#authModalBack").classList.remove("show");
}
function switchAuthTab(tab){
  const isLogin = tab === "login";
  $("#tabLogin").classList.toggle("active", isLogin);
  $("#tabRegister").classList.toggle("active", !isLogin);
  $("#formLogin").classList.toggle("active", isLogin);
  $("#formRegister").classList.toggle("active", !isLogin);
}

// Botones del onboarding
$("#openLoginBtn").addEventListener("click", () => openAuthModal("login"));
$("#openRegisterBtn").addEventListener("click", () => openAuthModal("register"));

// Cerrar popup
$("#authModalClose").addEventListener("click", closeAuthModal);
$("#authModalBack").addEventListener("click", e => {
  if(e.target === $("#authModalBack")) closeAuthModal();
});

function showAuthScreen(){
  screenAuth.classList.add("active");
  screenApp.classList.remove("active");
  screenDetail.classList.remove("active");
  closeAuthModal();
}

function showAppScreen(user){
  closeAuthModal();
  screenAuth.classList.remove("active");
  screenApp.classList.add("active");
  screenDetail.classList.remove("active");
  updateUserUI(user);
  renderHome("Todos");
  showView("home");
}

function updateUserUI(user){
  if(!user) return;
  const nameEl   = $("#userName");
  const emailEl  = $("#userEmail");
  const avatarEl = $("#userAvatar");
  if(nameEl)  nameEl.textContent  = user.displayName || "Sin nombre";
  if(emailEl) emailEl.textContent = user.email || "";
  if(avatarEl){
    if(user.photoURL){
      avatarEl.innerHTML = '<img src="' + user.photoURL + '" alt="avatar">';
    } else {
      const initial = (user.displayName || user.email || "?")[0].toUpperCase();
      avatarEl.textContent = initial;
    }
  }
}

function setAuthLoading(on){
  $("#authSpinner").classList.toggle("show", on);
  $$("#formLogin .btnPrimary, #formLogin .btnGoogle, #formRegister .btnPrimary, #formRegister .btnGoogle")
    .forEach(b => b.disabled = on);
}

function showAuthError(el, msg){ el.textContent = msg; el.classList.add("show"); }
function clearAuthError(el){ el.textContent = ""; el.classList.remove("show"); }

function friendlyError(code){
  const map = {
    "auth/invalid-email":           "Correo electr√≥nico no v√°lido.",
    "auth/user-not-found":          "No existe cuenta con ese correo.",
    "auth/wrong-password":          "Contrase√±a incorrecta.",
    "auth/invalid-credential":      "Correo o contrase√±a incorrectos.",
    "auth/email-already-in-use":    "Ya existe una cuenta con ese correo.",
    "auth/weak-password":           "La contrase√±a debe tener al menos 6 caracteres.",
    "auth/popup-closed-by-user":    "Ventana cerrada. Int√©ntalo de nuevo.",
    "auth/cancelled-popup-request": "Solicitud cancelada.",
    "auth/network-request-failed":  "Error de red. Comprueba tu conexi√≥n.",
    "auth/too-many-requests":       "Demasiados intentos. Espera un momento.",
  };
  return map[code] || "Error inesperado (" + code + ").";
}

// Tabs dentro del popup
$("#tabLogin").addEventListener("click", () => switchAuthTab("login"));
$("#tabRegister").addEventListener("click", () => switchAuthTab("register"));

// Login email
$("#loginBtn").addEventListener("click", async () => {
  const email = $("#loginEmail").value.trim();
  const pass  = $("#loginPass").value;
  const errEl = $("#loginError");
  clearAuthError(errEl);
  if(!email || !pass){ showAuthError(errEl, "Rellena el correo y la contrase√±a."); return; }
  setAuthLoading(true);
  try{
    await window._fbSignInEmail(email, pass);
    // onAuthStateChanged se encarga del resto
  }catch(e){
    showAuthError(errEl, friendlyError(e.code));
  }finally{
    setAuthLoading(false);
  }
});

// Enter en campos de login
["loginEmail","loginPass"].forEach(id => {
  $(("#" + id)).addEventListener("keydown", e => { if(e.key === "Enter") $("#loginBtn").click(); });
});

// Registro email
$("#registerBtn").addEventListener("click", async () => {
  const name  = $("#registerName").value.trim();
  const email = $("#registerEmail").value.trim();
  const pass  = $("#registerPass").value;
  const errEl = $("#registerError");
  const okEl  = $("#registerSuccess");
  clearAuthError(errEl);
  okEl.classList.remove("show");
  if(!name){ showAuthError(errEl, "Escribe tu nombre."); return; }
  if(!email || !pass){ showAuthError(errEl, "Rellena todos los campos."); return; }
  setAuthLoading(true);
  try{
    await window._fbRegister(email, pass);
    await window._fbUpdateProfile({ displayName: name });
    // onAuthStateChanged se encarga de entrar
  }catch(e){
    showAuthError(errEl, friendlyError(e.code));
  }finally{
    setAuthLoading(false);
  }
});

// Enter en campos de registro
["registerName","registerEmail","registerPass"].forEach(id => {
  $(("#" + id)).addEventListener("keydown", e => { if(e.key === "Enter") $("#registerBtn").click(); });
});

// Google login
function handleGoogleLogin(){
  setAuthLoading(true);
  window._fbGoogleLogin()
    .catch(e => {
      const errEl = $("#formLogin").classList.contains("active") ? $("#loginError") : $("#registerError");
      showAuthError(errEl, friendlyError(e.code));
    })
    .finally(() => setAuthLoading(false));
}
$("#loginGoogleBtn").addEventListener("click", handleGoogleLogin);
$("#registerGoogleBtn").addEventListener("click", handleGoogleLogin);

// Olvid√© contrase√±a
$("#forgotBtn").addEventListener("click", async () => {
  const email = $("#loginEmail").value.trim();
  const errEl = $("#loginError");
  clearAuthError(errEl);
  if(!email){ showAuthError(errEl, "Escribe primero tu correo."); return; }
  setAuthLoading(true);
  try{
    await window._fbResetPassword(email);
    clearAuthError(errEl);
    const okEl = document.createElement("div");
    okEl.className = "authSuccess show";
    okEl.textContent = "‚úâÔ∏è Correo de recuperaci√≥n enviado. Revisa tu bandeja.";
    $("#formLogin").insertBefore(okEl, $("#formLogin").firstChild);
    setTimeout(() => okEl.remove(), 6000);
  }catch(e){
    showAuthError(errEl, friendlyError(e.code));
  }finally{
    setAuthLoading(false);
  }
});

// Cerrar sesi√≥n
$("#signOutBtn").addEventListener("click", async () => {
  if(!confirm("¬øCerrar sesi√≥n?")) return;
  await window._fbSignOut();
});

/* ================================================================
   SCREENS / VIEWS
================================================================ */
const pageTitle  = $("#pageTitle");
const homeHeader = $("#homeHeader");
const viewHome    = $("#view-home");
const viewCompass = $("#view-compass");
const viewProfile = $("#view-profile");

function showOnly(view){
  viewHome.style.display    = view === "home"    ? "block" : "none";
  viewCompass.style.display = view === "compass" ? "block" : "none";
  viewProfile.style.display = view === "profile" ? "block" : "none";
}
function setNavActive(which){
  $$(".navBtn").forEach(b => b.classList.remove("active"));
  const b = document.querySelector('.navBtn[data-nav="' + which + '"]');
  if(b) b.classList.add("active");
}
function showView(which){
  setNavActive(which);
  if(which === "home"){
    pageTitle.textContent = "Mis objetivos";
    homeHeader.style.display = "block";
    showOnly("home");
  } else if(which === "compass"){
    pageTitle.textContent = "Mapa";
    homeHeader.style.display = "none";
    showOnly("compass");
    initMapIfNeeded();
    setTimeout(() => { if(map){ map.invalidateSize(); renderMapMarkers(); } }, 60);
  } else if(which === "profile"){
    pageTitle.textContent = "Perfil";
    homeHeader.style.display = "none";
    showOnly("profile");
    renderProfile();
    // actualizar card de usuario
    if(window._fbAuth && window._fbAuth.currentUser) updateUserUI(window._fbAuth.currentUser);
  }
}
$$(".navBtn").forEach(btn => btn.addEventListener("click", () => showView(btn.dataset.nav)));

/* ================================================================
   HOME
================================================================ */
const carousel = $("#carousel");
let currentCat = "Todos";

function renderHome(cat){
  cat = cat || "Todos";
  currentCat = cat;
  const list = objetivos.filter(o => cat === "Todos" || o.cat === cat);
  carousel.innerHTML = list.map(o =>
    '<article class="objCard ' + (o.done?"done":"") + '" data-id="' + o.id + '">'
    + '<div class="objImg" style="background-image:url(\'' + firstImg(o) + '\')"></div>'
    + '<div class="objBody"><div>'
    + '<div class="objTitle">' + escapeHTML(o.titulo) + '</div>'
    + '<div class="objMeta">' + escapeHTML(o.cat) + ' ¬∑ ' + eur(o.coste) + (o.place ? " ¬∑ " + escapeHTML(o.place) : "") + '</div>'
    + '</div><div class="badge ' + (o.done?"done":"") + '">' + (o.done?"Cumplido":o.cat) + '</div></div></article>'
  ).join("");
  carousel.scrollTo({left:0,behavior:"auto"});
}

$$(".tab").forEach(t => t.addEventListener("click", () => {
  $$(".tab").forEach(x => x.classList.remove("active"));
  t.classList.add("active");
  renderHome(t.dataset.cat);
}));
carousel.addEventListener("click", e => {
  const card = e.target.closest(".objCard");
  if(card) openDetail(Number(card.dataset.id));
});

/* ================================================================
   PROFILE
================================================================ */
function renderProfile(){
  const pend = objetivos.filter(o => !o.done);
  const done = objetivos.filter(o => o.done);
  const costTotal = objetivos.reduce((a,o) => a+(Number(o.coste)||0), 0);
  const costPend  = pend.reduce((a,o) => a+(Number(o.coste)||0), 0);
  const costDone  = done.reduce((a,o) => a+(Number(o.coste)||0), 0);

  $("#kpiPend").textContent = pend.length;
  $("#kpiDone").textContent = done.length;
  $("#kpiCostTotal").textContent = eur(costTotal);
  $("#kpiCostPend").textContent  = eur(costPend);

  $("#listPend").innerHTML = pend.length
    ? pend.map(o => '<div class="rowItem"><div class="rowLeft"><strong>' + escapeHTML(o.titulo) + '</strong><small>' + escapeHTML(o.cat) + (o.place?" ¬∑ "+escapeHTML(o.place):"") + '</small></div><div class="cost">' + eur(o.coste||0) + '</div></div>').join("")
    : '<div class="rowItem"><div class="rowLeft"><strong>Todo hecho üòÆ‚Äçüí®</strong><small>No hay pendientes.</small></div><div class="cost">0‚Ç¨</div></div>';

  $("#listDone").innerHTML = done.length
    ? done.map(o => '<div class="rowItem"><div class="rowLeft"><strong>' + escapeHTML(o.titulo) + '</strong><small>' + escapeHTML(o.cat) + (o.place?" ¬∑ "+escapeHTML(o.place):"") + '</small></div><div class="cost">' + eur(o.coste||0) + '</div></div>').join("")
    : '<div class="rowItem"><div class="rowLeft"><strong>A√∫n ninguno cumplido</strong><small>Se empieza por uno.</small></div><div class="cost">' + eur(costDone) + '</div></div>';
}

/* ================================================================
   LIGHTBOX
================================================================ */
const lightbox  = $("#lightbox");
const lbImg     = $("#lbImg");
const lbCounter = $("#lbCounter");
const lbStage   = $("#lbStage");
let galleryImgs = [], galleryIdx = 0;

function openLightbox(imgs, idx){
  galleryImgs = (imgs||[]).filter(Boolean);
  if(!galleryImgs.length) return;
  galleryIdx = Math.max(0, Math.min(idx||0, galleryImgs.length-1));
  renderLB();
  lightbox.classList.add("show");
}
function closeLightbox(){ lightbox.classList.remove("show"); }
function renderLB(){
  lbImg.src = galleryImgs[galleryIdx];
  lbCounter.textContent = (galleryIdx+1) + "/" + galleryImgs.length;
  $("#lbPrev").style.visibility = galleryImgs.length>1?"visible":"hidden";
  $("#lbNext").style.visibility = galleryImgs.length>1?"visible":"hidden";
}
function prevImg(){ galleryIdx=(galleryIdx-1+galleryImgs.length)%galleryImgs.length; renderLB(); }
function nextImg(){ galleryIdx=(galleryIdx+1)%galleryImgs.length; renderLB(); }

$("#lbClose").addEventListener("click", closeLightbox);
$("#lbPrev").addEventListener("click", prevImg);
$("#lbNext").addEventListener("click", nextImg);
lightbox.addEventListener("click", e => { if(!e.target.closest(".lbStage") && !e.target.closest(".lbNav") && !e.target.closest(".lbTop")) closeLightbox(); });
window.addEventListener("keydown", e => {
  if(!lightbox.classList.contains("show")) return;
  if(e.key==="Escape") closeLightbox();
  if(e.key==="ArrowLeft") prevImg();
  if(e.key==="ArrowRight") nextImg();
});
let lbStartX = null;
lbStage.addEventListener("touchstart", e => { lbStartX = e.touches[0].clientX; },{passive:true});
lbStage.addEventListener("touchend", e => {
  if(lbStartX===null) return;
  const dx = e.changedTouches[0].clientX - lbStartX; lbStartX=null;
  if(Math.abs(dx)<40) return;
  dx>0 ? prevImg() : nextImg();
},{passive:true});

/* ================================================================
   DETALLE
================================================================ */
let selectedId = null;

function openDetail(id){
  selectedId = id;
  const o = objetivos.find(x => x.id===id);
  if(!o) return;
  $("#detailHero").style.backgroundImage = "url('" + firstImg(o) + "')";
  $("#detailTitle").textContent = o.titulo;
  const place = o.place ? " ¬∑ " + o.place : "";
  $("#detailSub").textContent = o.cat + " ¬∑ " + (o.done?"Cumplido":"Pendiente") + place;
  $("#chipCat").textContent   = o.cat;
  $("#chipState").textContent = o.done?"Cumplido":"Pendiente";
  $("#chipCost").textContent  = eur(o.coste);
  $("#detailPrice").textContent = eur(o.coste);
  $("#detailDesc").textContent  = o.desc || "A√±ade una descripci√≥n en Ajustes.";
  $("#toggleDoneTop").textContent = o.done?"‚ô•":"‚ô°";
  const imgs = o.imgs||[];
  $("#detailThumbs").innerHTML = imgs.slice(0,4).map((src,i) =>
    '<div class="thumb '+(i===0?"":"dim")+'" data-idx="'+i+'" style="background-image:url(\''+src+'\')"></div>'
  ).join("");
  screenApp.classList.remove("active");
  screenDetail.classList.add("active");
}

function closeDetail(){
  screenDetail.classList.remove("active");
  screenApp.classList.add("active");
}

function toggleDone(){
  const o = objetivos.find(x => x.id===selectedId);
  if(!o) return;
  o.done = !o.done;
  saveObjetivos();
  const place = o.place ? " ¬∑ "+o.place : "";
  $("#chipState").textContent = o.done?"Cumplido":"Pendiente";
  $("#detailSub").textContent = o.cat+" ¬∑ "+(o.done?"Cumplido":"Pendiente")+place;
  $("#toggleDoneTop").textContent = o.done?"‚ô•":"‚ô°";
  renderHome(currentCat);
  if(viewProfile.style.display!=="none") renderProfile();
  if(map) renderMapMarkers();
}

$("#backBtn").addEventListener("click", closeDetail);
$("#toggleDoneBtn").addEventListener("click", toggleDone);
$("#toggleDoneTop").addEventListener("click", toggleDone);
$("#detailHero").addEventListener("click", () => {
  const o = objetivos.find(x => x.id===selectedId);
  if(o) openLightbox(o.imgs||[], 0);
});
$("#detailThumbs").addEventListener("click", e => {
  const t = e.target.closest(".thumb");
  if(!t) return;
  const o = objetivos.find(x => x.id===selectedId);
  if(o) openLightbox(o.imgs||[], Number(t.dataset.idx));
});

/* ================================================================
   MAPA
================================================================ */
let map = null, markersLayer = null;

function initMapIfNeeded(){
  if(map) return;
  map = L.map("map",{zoomControl:true}).setView([20,0],2);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19,attribution:"&copy; OpenStreetMap"}).addTo(map);
  markersLayer = L.layerGroup().addTo(map);
}

function renderMapMarkers(){
  if(!map||!markersLayer) return;
  markersLayer.clearLayers();
  const points = [];
  objetivos.forEach(o => {
    const lat = typeof o.lat==="number"?o.lat:(o.lat===""?null:Number(o.lat));
    const lng = typeof o.lng==="number"?o.lng:(o.lng===""?null:Number(o.lng));
    if(!Number.isFinite(lat)||!Number.isFinite(lng)) return;
    points.push([lat,lng]);
    const marker = L.marker([lat,lng]).addTo(markersLayer);
    marker.bindPopup(
      '<div style="display:flex;gap:10px;align-items:center;min-width:220px">'
      +'<div style="width:46px;height:46px;border-radius:12px;background:#ddd center/cover no-repeat;flex:0 0 auto;background-image:url(\''+firstImg(o)+'\')"></div>'
      +'<div><div style="font-weight:900">'+escapeHTML(o.titulo)+'</div>'
      +'<div style="opacity:.75;font-size:12px;margin-top:4px">'+escapeHTML(o.cat)+' ¬∑ '+(o.done?"Cumplido":"Pendiente")+'</div>'
      +(o.place?'<div style="opacity:.75;font-size:12px;margin-top:2px">'+escapeHTML(o.place)+'</div>':'')
      +'</div></div>'
      +'<div style="margin-top:10px;display:flex;justify-content:flex-end">'
      +'<button data-open-id="'+o.id+'" style="border:none;padding:10px 12px;border-radius:12px;background:#0b1022;color:#fff;font-weight:900;cursor:pointer">Ver detalle ‚Üí</button>'
      +'</div>'
    );
  });
  if(points.length) map.fitBounds(L.latLngBounds(points),{padding:[30,30]});
  else map.setView([20,0],2);
}

document.addEventListener("click", e => {
  const btn = e.target.closest("[data-open-id]");
  if(!btn) return;
  const id = Number(btn.dataset.openId);
  if(!Number.isFinite(id)) return;
  if(map) map.closePopup();
  openDetail(id);
});

/* ================================================================
   AJUSTES (CRUD)
================================================================ */
let editingId = null, pendingLocalImgs = [];

function updateLocalCount(){ $("#localCount").textContent = pendingLocalImgs.length + " seleccionadas"; }

function openSettings(){
  editingId = null; pendingLocalImgs = []; updateLocalCount();
  showSettingsList();
  $("#settingsBack").classList.add("show");
}
function closeSettings(){ $("#settingsBack").classList.remove("show"); }

$("#gearBtn").addEventListener("click", openSettings);
$("#settingsClose").addEventListener("click", closeSettings);
$("#btnCloseList").addEventListener("click", closeSettings);
$("#settingsBack").addEventListener("click", e => { if(e.target===$("#settingsBack")) closeSettings(); });

function showSettingsList(){
  $("#settingsListView").style.display = "block";
  $("#settingsFormView").style.display = "none";
  $("#settingsActionsList").style.display = "flex";
  $("#settingsActionsForm").style.display = "none";
  $("#settingsList").innerHTML = objetivos
    .slice().sort((a,b) => a.done===b.done ? a.id-b.id : (a.done?1:-1))
    .map(o =>
      '<div class="miniItem '+(o.done?"done":"") +'" data-id="'+o.id+'">'
      +'<div class="miniImg" style="background-image:url(\''+firstImg(o)+'\')"></div>'
      +'<div class="miniText"><b>'+escapeHTML(o.titulo)+'</b>'
      +'<span>'+escapeHTML(o.cat)+' ¬∑ '+eur(o.coste)+(o.place?" ¬∑ "+escapeHTML(o.place):"")+' </span></div>'
      +'<div class="tag '+(o.done?"done":"") +'">'+(o.done?"Cumplido":"Pendiente")+'</div></div>'
    ).join("") || '<div class="smallNote">No hay objetivos. A√±ada el primero.</div>';
}

function showSettingsForm(mode){
  $("#settingsListView").style.display = "none";
  $("#settingsFormView").style.display = "block";
  $("#settingsActionsList").style.display = "none";
  $("#settingsActionsForm").style.display = "flex";
  $("#formModeNote").textContent = mode==="new" ? "Nuevo objetivo" : "Editar objetivo";
}

function fillForm(o){
  $("#fTitle").value = o?.titulo ?? "";
  $("#fCat").value   = o?.cat ?? "Viajes";
  $("#fCost").value  = o?.coste ?? 0;
  $("#fDone").checked = !!o?.done;
  $("#fDesc").value  = o?.desc ?? "";
  const imgs = (o?.imgs && o.imgs.length) ? o.imgs : ["","","",""];
  $("#fImg0").value = imgs[0]?.startsWith("data:") ? "" : (imgs[0]||"");
  $("#fImg1").value = imgs[1]?.startsWith("data:") ? "" : (imgs[1]||"");
  $("#fImg2").value = imgs[2]?.startsWith("data:") ? "" : (imgs[2]||"");
  $("#fImg3").value = imgs[3]?.startsWith("data:") ? "" : (imgs[3]||"");
  $("#fPlace").value = o?.place ?? "";
  $("#fLat").value   = o?.lat != null ? o.lat : "";
  $("#fLng").value   = o?.lng != null ? o.lng : "";
  pendingLocalImgs = []; updateLocalCount();
  $("#localFiles").value = "";
}

async function filesToDataUrls(files){
  const result = [];
  for(const file of Array.from(files||[])){
    if(!file.type.startsWith("image/")) continue;
    const url = await new Promise((res,rej) => {
      const r = new FileReader();
      r.onload = () => res(r.result);
      r.onerror = rej;
      r.readAsDataURL(file);
    });
    result.push(url);
  }
  return result;
}

$("#pickLocalBtn").addEventListener("click", () => $("#localFiles").click());
$("#localFiles").addEventListener("change", async () => {
  if(!$("#localFiles").files?.length) return;
  try{ const d = await filesToDataUrls($("#localFiles").files); pendingLocalImgs.push(...d); updateLocalCount(); }
  catch(e){ alert("No se pudieron cargar fotos."); }
  finally{ $("#localFiles").value = ""; }
});

$("#btnAdd").addEventListener("click", () => { editingId=null; fillForm(null); showSettingsForm("new"); $("#btnDelete").style.display="none"; });

$("#settingsList").addEventListener("click", e => {
  const item = e.target.closest(".miniItem");
  if(!item) return;
  const o = objetivos.find(x => x.id===Number(item.dataset.id));
  if(!o) return;
  editingId = o.id; fillForm(o); showSettingsForm("edit"); $("#btnDelete").style.display="block";
});

$("#btnBackToList").addEventListener("click", () => { editingId=null; pendingLocalImgs=[]; updateLocalCount(); showSettingsList(); });

function refreshEverywhere(){
  saveObjetivos();
  renderHome(currentCat);
  if(viewProfile.style.display!=="none") renderProfile();
  if(map) renderMapMarkers();
  if(selectedId && screenDetail.classList.contains("active")){
    if(objetivos.some(o => o.id===selectedId)) openDetail(selectedId);
  }
}

$("#btnSave").addEventListener("click", () => {
  const titulo = $("#fTitle").value.trim();
  const cat    = $("#fCat").value;
  const coste  = Number($("#fCost").value||0);
  const done   = !!$("#fDone").checked;
  const desc   = $("#fDesc").value.trim();
  const place  = $("#fPlace").value.trim();
  const latRaw = $("#fLat").value.trim();
  const lngRaw = $("#fLng").value.trim();
  const lat = latRaw===""?null:Number(latRaw);
  const lng = lngRaw===""?null:Number(lngRaw);

  if(!titulo){ alert("Ponga un t√≠tulo üôÇ"); return; }
  if((lat!==null&&!Number.isFinite(lat))||(lng!==null&&!Number.isFinite(lng))){ alert("Lat/Lng no son v√°lidos."); return; }

  const urlImgs = [$("#fImg0").value,$("#fImg1").value,$("#fImg2").value,$("#fImg3").value].map(s=>(s||"").trim()).filter(Boolean);
  let finalImgs = [];
  if(pendingLocalImgs.length) finalImgs.push(pendingLocalImgs[0]);
  finalImgs.push(...urlImgs);
  if(editingId!=null){
    const prev = objetivos.find(o => o.id===editingId);
    const keepLocal = (prev?.imgs||[]).filter(s => s.startsWith("data:"));
    finalImgs.push(...keepLocal);
  }
  if(pendingLocalImgs.length>1) finalImgs.push(...pendingLocalImgs.slice(1));
  finalImgs = [...new Set(finalImgs)].filter(Boolean);
  if(!finalImgs.length){ alert("A√±ada al menos una imagen."); return; }

  if(editingId==null){
    const nextId = objetivos.reduce((m,o) => Math.max(m,Number(o.id)||0),0)+1;
    objetivos.unshift({id:nextId,titulo,cat,coste,done,desc,imgs:finalImgs,place,lat,lng});
  } else {
    const idx = objetivos.findIndex(x => x.id===editingId);
    if(idx>=0) objetivos[idx] = {...objetivos[idx],titulo,cat,coste,done,desc,imgs:finalImgs,place,lat,lng};
  }
  pendingLocalImgs=[]; updateLocalCount();
  refreshEverywhere(); showSettingsList();
});

$("#btnDelete").addEventListener("click", () => {
  if(editingId==null) return;
  const o = objetivos.find(x => x.id===editingId);
  if(!confirm('¬øBorrar "' + (o?.titulo||"objetivo") + '"?')) return;
  objetivos = objetivos.filter(x => x.id!==editingId);
  if(selectedId===editingId && screenDetail.classList.contains("active")) closeDetail();
  editingId=null; pendingLocalImgs=[]; updateLocalCount();
  refreshEverywhere(); showSettingsList();
});

/* ================================================================
   IDEAS
================================================================ */
const ideasCatalogo = {
  Viajes:["Torre Eiffel","Museo del Louvre","Mont Saint-Michel","Costa Azul","Provenza","Coliseo de Roma","Venecia","Torre de Pisa","Costa Amalfitana","Florencia","Sagrada Familia","Londres y Big Ben","Berl√≠n","Viena","Fiordos noruegos","Gran Ca√±√≥n","Times Square","Golden Gate","Las Vegas","Yellowstone","Chich√©n Itz√°","Machu Picchu","Cristo Redentor","Amazonas","Buenos Aires","Gran Muralla China","Tokio","Monte Fuji","Kioto (Fushimi Inari)","Shangh√°i","Bangkok","Taj Mahal","Burj Khalifa","Islas de Tailandia","Desierto de Dub√°i","Pir√°mides de Giza","Sahara","Marrakech","Safari Serengeti","Cataratas Victoria","Auroras en Islandia","Patagonia","Gran Barrera de Coral","Volc√°n activo","Alpes","Ruta 66","Transiberiano","Himalaya","Igl√∫ de cristal","Avistamiento de ballenas","Maldivas","Bora Bora","Santorini","Bali","Haw√°i","Seychelles","Filipinas","Mauricio","Ibiza","Islas Feroe","Nueva York en Navidad","Dub√°i","Singapur","Hong Kong","Estambul","Praga","√Åmsterdam","Budapest","Edimburgo","Chicago","Globo en Capadocia","Carnaval de R√≠o","Oktoberfest","A√±o Nuevo en S√≠dney","Ruta gastron√≥mica por Jap√≥n","Crucero Caribe","Ryokan en Jap√≥n","Viaje solo","5 continentes","50 pa√≠ses antes de los 50","Interrail","Vivir 6 meses fuera","Mochilero por Sudam√©rica","N√≥mada digital","Roadtrip 30 d√≠as","Camino de Santiago","Dormir en el desierto","7 maravillas modernas","10 Patrimonios UNESCO","Viaje con padres","Disney con hijos","Viaje sorpresa","Viaje √©pico de jubilaci√≥n"],
  Familia:["Tener mi primer hijo/a antes de los 35","Crear tradiciones familiares propias","Gran viaje familiar cada verano","Dise√±ar la casa de mis sue√±os","Llegar a la vejez rodeado de hijos y nietos","Comidas familiares todos los domingos","Cita mensual obligatoria con mi pareja","Renovar votos a los 10 a√±os","Vivir un a√±o en el extranjero en familia","Transmitir recetas familiares","√Ålbum f√≠sico familiar cada a√±o","Crear fondo familiar de emergencia","Dejar herencia s√≥lida","Celebrar todos los cumplea√±os juntos","Gran reuni√≥n familiar cada 5 a√±os","Cuidar de mis padres cuando lo necesiten","Viaje individual con cada hijo","Ense√±ar educaci√≥n financiera a mis hijos","Construir negocio familiar","Superar juntos una crisis econ√≥mica"],
  Trabajo:["Conseguir primer ascenso antes de los 30","Alcanzar puesto directivo antes de los 40","Liderar equipo de m√°s de 20 personas","Ser referente en mi sector","Cambiar de sector con √©xito","Trabajar en empresa internacional","Lograr puesto 100% remoto","Negociar aumento del 20%","Superar 50.000‚Ç¨ anuales antes de los 35","Alcanzar 100.000‚Ç¨ anuales antes de los 45","Crear negocio propio antes de los 35","Lanzar producto digital rentable","Automatizar 50% de procesos","Abrir segunda l√≠nea de negocio","Delegar completamente la operativa","Monetizar un hobby","Construir marca personal s√≥lida","Hablar en evento profesional","Independencia financiera antes de los 55","Jubilarme antes de la edad legal"]
};

function openIdeas(cat){
  cat = cat||"Viajes";
  $$(".ideaTab").forEach(b => b.classList.remove("active"));
  document.querySelector('.ideaTab[data-idea-cat="'+cat+'"]')?.classList.add("active");
  renderIdeas(cat);
  $("#ideasBack").classList.add("show");
}
function closeIdeas(){ $("#ideasBack").classList.remove("show"); }
function renderIdeas(cat){
  const list = ideasCatalogo[cat]||[];
  $("#ideasList").innerHTML = list.map(t =>
    '<div class="miniItem"><div class="miniText"><b>'+escapeHTML(t)+'</b><span>'+escapeHTML(cat)+'</span></div>'
    +'<div class="tag" data-idea-add="1" data-idea-title="'+escapeHTML(t)+'" data-idea-cat="'+escapeHTML(cat)+'">A√±adir</div></div>'
  ).join("") || '<div class="smallNote">No hay ideas aqu√≠ todav√≠a.</div>';
}

$("#searchBtn").addEventListener("click", () => openIdeas("Viajes"));
$("#ideasClose").addEventListener("click", closeIdeas);
$("#ideasClose2").addEventListener("click", closeIdeas);
$("#ideasBack").addEventListener("click", e => { if(e.target===$("#ideasBack")) closeIdeas(); });
$$(".ideaTab").forEach(btn => btn.addEventListener("click", () => {
  $$(".ideaTab").forEach(b => b.classList.remove("active"));
  btn.classList.add("active");
  renderIdeas(btn.dataset.ideaCat);
}));

document.addEventListener("click", e => {
  const add = e.target.closest("[data-idea-add]");
  if(!add) return;
  closeIdeas();
  openWizard({titulo: add.dataset.ideaTitle||"", cat: add.dataset.ideaCat||"Viajes"});
});

/* ================================================================
   WIZARD
================================================================ */
let wStep=0, wLocalImgs=[], wCoverChoice=null, wFetchedImages=[];

function wizardStepEls(){ return Array.from($$(".wizardStep")); }

function setWizardStep(n){
  const steps = wizardStepEls();
  wStep = Math.max(0, Math.min(n, steps.length-1));
  steps.forEach(s => s.classList.remove("active"));
  steps[wStep].classList.add("active");
  $("#wizardDots").innerHTML = steps.map((_,i) => '<div class="dot '+(i===wStep?"active":"")+'"></div>').join("");
  $("#wPrev").style.visibility = wStep===0 ? "hidden" : "visible";
  $("#wNext").textContent = wStep===steps.length-1 ? "Crear" : "Siguiente";
  if(wStep===4){
    const q = ($("#wTitle").value||"").trim();
    if(q){ $("#wSearchQuery").value=q; triggerImageSearch(q); }
    else checkApiKeyNotice();
  }
}

function resetWizard(){
  ["wTitle","wCost","wDesc","wPlace","wLat","wLng","wImgUrl","wSearchQuery"].forEach(id => {
    const el = $("#"+id); if(el) el.value="";
  });
  $("#wCat").value = "Viajes";
  wLocalImgs=[]; wCoverChoice=null; wFetchedImages=[];
  $("#wLocalCount").textContent = "0 seleccionadas";
  $("#wLocalFiles").value = "";
  $("#coverGrid").innerHTML = "";
  $("#pexelsCredit").style.display = "none";
  $("#pexelsApiNotice").style.display = "none";
  setWizardStep(0);
}

function checkApiKeyNotice(){
  const hasKey = PEXELS_API_KEY && PEXELS_API_KEY !== "TU_API_KEY_AQUI";
  $("#pexelsApiNotice").style.display = hasKey ? "none" : "block";
}
function renderCoverLoading(){
  $("#coverGrid").innerHTML = [0,1,2].map(() =>
    '<div class="coverOpt"><div class="coverSkeleton"></div><div class="cap">Buscando‚Ä¶</div></div>'
  ).join("");
  $("#pexelsCredit").style.display = "none";
}
function renderCoverResults(photos, hasKey){
  wFetchedImages = photos;
  if(!wCoverChoice && photos.length) wCoverChoice = photos[0].url;
  if(!photos.length){
    $("#coverGrid").innerHTML = '<div class="smallNote" style="grid-column:1/-1">Sin resultados. Prueba otra b√∫squeda.</div>';
    $("#pexelsCredit").style.display = "none";
    return;
  }
  $("#coverGrid").innerHTML = photos.map((img,idx) =>
    '<div class="coverOpt '+(img.url===wCoverChoice?"selected":"")+'" data-cover-url="'+escapeHTML(img.url)+'">'
    +'<img src="'+escapeHTML(img.thumb)+'" alt="Portada '+(idx+1)+'" loading="lazy">'
    +'<div class="cap">Opci√≥n '+(idx+1)+'</div></div>'
  ).join("");
  $("#pexelsCredit").style.display = hasKey ? "block" : "none";
}
async function triggerImageSearch(query){
  if(!query) return;
  checkApiKeyNotice();
  renderCoverLoading();
  const result = await fetchPexelsImages(query, 3);
  wCoverChoice = null;
  renderCoverResults(result.photos, result.hasKey);
}

$("#wSearchBtn").addEventListener("click", () => {
  const q = $("#wSearchQuery").value.trim();
  if(!q){ alert("Escribe algo para buscar üôÇ"); return; }
  triggerImageSearch(q);
});
$("#wSearchQuery").addEventListener("keydown", e => {
  if(e.key==="Enter"){ e.preventDefault(); const q=$("#wSearchQuery").value.trim(); if(q) triggerImageSearch(q); }
});
document.addEventListener("click", e => {
  const opt = e.target.closest(".coverOpt");
  if(!opt) return;
  const url = opt.dataset.coverUrl;
  if(!url) return;
  wCoverChoice = url;
  $$(".coverOpt").forEach(o => o.classList.toggle("selected", o.dataset.coverUrl===url));
});

function openWizard(prefill){
  prefill = prefill||{};
  resetWizard();
  if(prefill.titulo) $("#wTitle").value = prefill.titulo;
  if(prefill.cat)    $("#wCat").value   = prefill.cat;
  $("#wizardBack").classList.add("show");
}
function closeWizard(){ $("#wizardBack").classList.remove("show"); }

$("#wizardClose").addEventListener("click", closeWizard);
$("#wizardBack").addEventListener("click", e => { if(e.target===$("#wizardBack")) closeWizard(); });
$("#wPickLocalBtn").addEventListener("click", () => $("#wLocalFiles").click());
$("#wLocalFiles").addEventListener("change", async () => {
  if(!$("#wLocalFiles").files?.length) return;
  try{ const d=await filesToDataUrls($("#wLocalFiles").files); wLocalImgs.push(...d); $("#wLocalCount").textContent=wLocalImgs.length+" seleccionadas"; }
  catch(e){ alert("No se pudieron cargar fotos."); }
  finally{ $("#wLocalFiles").value=""; }
});

$("#wPrev").addEventListener("click", () => setWizardStep(wStep-1));
$("#wNext").addEventListener("click", () => {
  const stepsCount = wizardStepEls().length;
  if(wStep===0){
    if(!$("#wTitle").value.trim()){ alert("Ponga un t√≠tulo üôÇ"); return; }
    setWizardStep(1); return;
  }
  if(wStep < stepsCount-1){ setWizardStep(wStep+1); return; }

  // CREAR
  const titulo = $("#wTitle").value.trim();
  const cat    = $("#wCat").value;
  const coste  = Number($("#wCost").value||0);
  const desc   = $("#wDesc").value.trim();
  const place  = $("#wPlace").value.trim();
  const latRaw = $("#wLat").value.trim();
  const lngRaw = $("#wLng").value.trim();
  const lat = latRaw===""?null:Number(latRaw);
  const lng = lngRaw===""?null:Number(lngRaw);

  if((lat!==null&&!Number.isFinite(lat))||(lng!==null&&!Number.isFinite(lng))){ alert("Lat/Lng no v√°lidos."); return; }

  let imgs = [];
  if(wLocalImgs.length){
    imgs.push(wLocalImgs[0]);
  } else {
    const manual = ($("#wImgUrl").value||"").trim();
    if(manual) imgs.push(manual);
    else if(wCoverChoice) imgs.push(wCoverChoice);
  }
  if(wLocalImgs.length>1) imgs.push(...wLocalImgs.slice(1));
  imgs = [...new Set(imgs)].filter(Boolean);

  if(!imgs.length){ alert("A√±ade al menos una imagen: b√∫squeda, URL o foto del m√≥vil."); return; }

  const nextId = objetivos.reduce((m,o) => Math.max(m,Number(o.id)||0),0)+1;
  objetivos.unshift({id:nextId,titulo,cat,coste,done:false,desc,imgs,place,lat,lng});

  refreshEverywhere();
  closeWizard();
  showView("home");
  renderHome(currentCat);
});

$("#addWizardBtn").addEventListener("click", () => openWizard());

</script>
</body>
</html>