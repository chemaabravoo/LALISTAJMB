<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>La Lista</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    :root{
      --text:#f3f4f6;
      --muted:rgba(243,244,246,.72);
      --card:#ffffff;
      --ink:#0b1022;
      --inkMuted:rgba(11,16,34,.55);
      --pill:rgba(0,0,0,.06);
      --pillActive:rgba(0,0,0,.12);
      --navBg:#ffffff;
      --stroke:rgba(0,0,0,.10);
      --cta:#23c7b6;
      --cta2:#1aa99c;
      --shadow:0 18px 60px rgba(0,0,0,.22);
      --shadow2:0 14px 34px rgba(0,0,0,.12);
    }

    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%}
    body{
      font-family:system-ui,-apple-system,Segoe UI,Roboto;
      background:#0f172a;
      color:var(--text);
    }

    .frame{
      width:min(430px,100%);
      height:min(920px,100vh);
      margin:0 auto;
      border-radius:28px;
      overflow:hidden;
      position:relative;
      background:#000;
    }

    .screen{position:absolute;inset:0;display:none}
    .screen.active{display:block}

    /* ================= ONBOARDING ================= */
    .onboarding{
      height:100%;
      padding:18px;
      display:flex;
      align-items:flex-end;
      justify-content:center;
      background:
        linear-gradient(180deg,rgba(0,0,0,.2),rgba(0,0,0,.85)),
        url("https://images.unsplash.com/photo-1507525428034-b723cf961d3e?auto=format&fit=crop&w=1400&q=60")
        center/cover no-repeat;
    }

    .logo{
      position:absolute;
      top:calc(env(safe-area-inset-top,0px) + 18px);
      left:0;right:0;
      text-align:center;
      font-weight:800;
      letter-spacing:.35em;
      font-size:28px;
      user-select:none;
    }

    .hero{
      position:absolute;
      top:45%;
      left:18px;
      right:18px;
      transform:translateY(-50%);
    }

    .title{
      font-size:40px;
      font-weight:850;
      line-height:1.05;
    }

    .subtitle{
      margin-top:22px;
      font-size:14px;
      line-height:1.55;
      color:var(--muted);
      text-align:center;
      max-width:36ch;
      margin-inline:auto;
    }

    .ctaWrap{
      width:100%;
      padding-bottom:calc(env(safe-area-inset-bottom,0px) + 6px);
    }

    .btn{
      width:100%;
      border:none;
      border-radius:999px;
      padding:16px;
      font-size:16px;
      font-weight:750;
      background:linear-gradient(180deg,var(--cta),var(--cta2));
      color:#0f172a;
      cursor:pointer;
    }
    .btn:active{transform:translateY(1px)}

    /* ================= APP SHELL ================= */
    .app{
      height:100%;
      background:#0f172a;
      display:flex;
    }

    .appShell{
      flex:1;
      margin:14px;
      background:#f6f7fb;
      border-radius:22px;
      overflow:hidden;
      display:flex;
      flex-direction:column;
      box-shadow:var(--shadow);
      position:relative;
    }

    .topbar{
      padding:calc(env(safe-area-inset-top,0px) + 16px) 16px 12px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      background:#f6f7fb;
      z-index:2;
    }
    .topbar h1{
      font-size:22px;
      color:var(--ink);
      font-weight:850;
    }
    .gear{
      width:40px;height:40px;
      border-radius:14px;
      border:1px solid var(--stroke);
      background:#fff;
      cursor:pointer;
    }
    .gear:active{transform:translateY(1px)}

    .tabs{
      display:flex;
      gap:10px;
      padding:0 16px 12px;
      background:#f6f7fb;
      z-index:2;
    }
    .tab{
      padding:10px 14px;
      border-radius:999px;
      background:var(--pill);
      border:none;
      font-weight:750;
      font-size:13px;
      color:rgba(11,16,34,.75);
      cursor:pointer;
    }
    .tab.active{background:var(--pillActive); color:var(--ink);}

    .ideaTabs{display:flex;gap:10px;margin-bottom:12px;}
    .ideaTab{
      padding:10px 14px;
      border-radius:999px;
      background:var(--pill);
      border:none;
      font-weight:750;
      font-size:13px;
      color:rgba(11,16,34,.75);
      cursor:pointer;
    }
    .ideaTab.active{background:var(--pillActive); color:var(--ink);}

    .content{flex:1; overflow:hidden; background:#f6f7fb;}

    /* HOME carousel */
    .carousel{
      height:100%;
      display:flex;
      gap:14px;
      overflow-x:auto;
      scroll-snap-type:x mandatory;
      -webkit-overflow-scrolling:touch;
      padding:6px 16px 92px;
    }
    .carousel::-webkit-scrollbar{display:none}

    .objCard{
      flex:0 0 calc(100% - 32px);
      height:100%;
      scroll-snap-align:start;
      background:var(--card);
      border-radius:20px;
      overflow:hidden;
      display:flex;
      flex-direction:column;
      box-shadow:var(--shadow2);
      border:1px solid rgba(0,0,0,.06);
      cursor:pointer;
      transition: opacity .18s ease;
    }

    .objCard.done{ opacity:.62; }
    .objCard.done .objImg{ filter:saturate(.85) contrast(.95); }
    .objCard.done .objTitle,
    .objCard.done .objMeta{ color: rgba(11,16,34,.55); }

    .objImg{flex:1; background:center/cover no-repeat;}
    .objBody{
      padding:16px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
    }
    .objTitle{
      font-size:16px;
      font-weight:850;
      color:var(--ink);
      line-height:1.15;
    }
    .objMeta{
      margin-top:6px;
      font-size:13px;
      color:var(--inkMuted);
      font-weight:650;
    }
    .badge{
      flex:0 0 auto;
      font-size:11px;
      font-weight:850;
      padding:8px 10px;
      border-radius:999px;
      background:rgba(0,0,0,.06);
      color:rgba(11,16,34,.75);
      border:1px solid rgba(0,0,0,.06);
      white-space:nowrap;
    }
    .badge.done{
      background:rgba(35,199,182,.18);
      border-color:rgba(35,199,182,.30);
      color:#0a3a34;
    }

    /* MAP */
    #map{height:100%; width:100%;}
    .leaflet-container{ background:#f6f7fb; }

    /* PROFILE */
    .profileWrap{
      height:100%;
      overflow:auto;
      padding:8px 16px 92px;
      -webkit-overflow-scrolling:touch;
    }
    .sectionTitle{
      margin:10px 2px 10px;
      font-size:14px;
      font-weight:900;
      color:rgba(11,16,34,.78);
    }
    .kpiGrid{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:12px;
      margin-bottom:12px;
    }
    .kpi{
      background:#fff;
      border-radius:18px;
      border:1px solid rgba(0,0,0,.06);
      box-shadow:var(--shadow2);
      padding:14px;
    }
    .kpi .label{font-size:12px;color:rgba(11,16,34,.55);font-weight:800;}
    .kpi .value{margin-top:8px;font-size:22px;color:var(--ink);font-weight:950;letter-spacing:-.4px;}
    .kpi .sub{margin-top:6px;font-size:12px;color:rgba(11,16,34,.55);font-weight:700;}

    .list{
      background:#fff;
      border-radius:18px;
      border:1px solid rgba(0,0,0,.06);
      box-shadow:var(--shadow2);
      overflow:hidden;
    }
    .rowItem{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      padding:14px;
      border-top:1px solid rgba(0,0,0,.06);
    }
    .rowItem:first-child{border-top:none}
    .rowLeft{min-width:0;}
    .rowItem strong{display:block;color:var(--ink);font-size:13px;line-height:1.2;}
    .rowItem small{display:block;margin-top:6px;color:rgba(11,16,34,.55);font-weight:700;font-size:12px;}
    .cost{font-weight:950;color:rgba(11,16,34,.78);font-size:13px;white-space:nowrap;}

    /* ================= DETALLE ================= */
    .detail{
      height:100%;
      background:#123d1f;
      display:flex;
      padding:14px;
    }
    .detailShell{
      flex:1;
      border-radius:22px;
      overflow:hidden;
      box-shadow:var(--shadow);
      position:relative;
      background:#000;
    }
    .detailHero{
      position:absolute; inset:0;
      background:#000 center/cover no-repeat;
      cursor:pointer;
    }
    .detailOverlay{
      position:absolute; inset:0;
      background:linear-gradient(180deg,rgba(0,0,0,.15) 0%,rgba(0,0,0,.55) 55%,rgba(0,0,0,.90) 100%);
    }
    .detailTopBtns{
      position:absolute;
      top:calc(env(safe-area-inset-top,0px) + 14px);
      left:14px; right:14px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      z-index:5;
    }
    .iconBtn{
      width:42px;height:42px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.22);
      background:rgba(255,255,255,.18);
      color:#fff;
      cursor:pointer;
      backdrop-filter:blur(10px);
      -webkit-backdrop-filter:blur(10px);
    }
    .iconBtn:active{transform:translateY(1px)}

    .detailThumbs{
      position:absolute;
      top:120px;
      right:14px;
      z-index:5;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .thumb{
      width:54px;height:54px;
      border-radius:14px;
      border:2px solid rgba(255,255,255,.88);
      background:center/cover no-repeat;
      cursor:pointer;
      box-shadow:0 10px 25px rgba(0,0,0,.35);
    }
    .thumb.dim{border-color:rgba(255,255,255,.45);opacity:.9;}

    .detailTitleBlock{
      position:absolute;
      left:18px; right:88px;
      bottom:300px;
      z-index:5;
      color:#fff;
    }
    .detailTitleBlock h2{
      font-size:28px;
      font-weight:950;
      letter-spacing:-.4px;
      line-height:1.05;
    }
    .detailTitleBlock .subline{
      margin-top:10px;
      font-size:13px;
      color:rgba(255,255,255,.78);
      font-weight:700;
    }

    .sheet{
      position:absolute;
      left:0; right:0; bottom:0;
      background:#f6f7fb;
      border-radius:22px 22px 0 0;
      padding:14px 14px 18px;
      z-index:6;
      min-height:46%;
    }
    .chips{
      display:flex; gap:10px; flex-wrap:wrap;
      padding:4px 4px 10px;
    }
    .chip{
      display:flex; flex-direction:column; gap:2px;
      background:#fff;
      border:1px solid rgba(0,0,0,.06);
      box-shadow:var(--shadow2);
      border-radius:16px;
      padding:10px 12px;
      min-width:92px;
    }
    .chip .k{font-size:11px;color:rgba(11,16,34,.55);font-weight:900;}
    .chip .v{font-size:14px;color:var(--ink);font-weight:950;}

    .descTitle{padding:6px;font-size:14px;font-weight:950;color:rgba(11,16,34,.78);}
    .desc{
      padding:0 6px 12px;
      font-size:13px;
      line-height:1.55;
      color:rgba(11,16,34,.60);
      max-height:120px;
      overflow:auto;
      -webkit-overflow-scrolling:touch;
    }
    .sheetBottom{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding:6px;
      padding-bottom:calc(env(safe-area-inset-bottom,0px) + 8px);
    }
    .price{font-weight:950;color:var(--ink);font-size:22px;letter-spacing:-.4px;}
    .action{
      width:56px;height:56px;
      border-radius:18px;
      border:none;
      background:#0b1022;
      color:#fff;
      font-size:20px;
      cursor:pointer;
      box-shadow:var(--shadow2);
    }
    .action:active{transform:translateY(1px)}

    /* NAV */
    .nav{
      position:absolute;
      left:14px; right:14px; bottom:14px;
      pointer-events:none;
    }
    .navInner{
      pointer-events:auto;
      height:64px;
      background:var(--navBg);
      border-radius:18px;
      display:flex;
      justify-content:space-around;
      align-items:center;
      box-shadow:var(--shadow2);
      border:1px solid rgba(0,0,0,.08);
    }
    .navBtn{
      width:46px;height:46px;
      border-radius:16px;
      border:none;
      font-size:20px;
      background:transparent;
      color:rgba(11,16,34,.45);
      cursor:pointer;
    }
    .navBtn.active{background:#0b1022;color:#fff;}
    .navBtn:active{transform:translateY(1px)}

    /* MODALES */
    .modalBack{
      position:absolute; inset:0;
      background:rgba(0,0,0,.45);
      display:none;
      align-items:flex-end;
      justify-content:center;
      padding:14px;
      z-index:80;
    }
    .modalBack.show{display:flex;}
    .modal{
      width:100%;
      background:#fff;
      border-radius:20px;
      box-shadow:var(--shadow);
      border:1px solid rgba(0,0,0,.08);
      overflow:hidden;
    }
    .modalHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:12px 12px 10px;
      border-bottom:1px solid rgba(0,0,0,.08);
    }
    .modalHead strong{color:var(--ink); font-size:14px;}
    .close{
      border:none;
      width:40px;height:40px;
      border-radius:14px;
      background:rgba(0,0,0,.06);
      cursor:pointer;
      color:var(--ink);
      font-size:18px;
    }
    .modalBody{
      padding:12px;
      max-height:min(72vh, 600px);
      overflow:auto;
      -webkit-overflow-scrolling:touch;
    }
    .modalActions{
      display:flex;
      gap:10px;
      padding:12px;
      border-top:1px solid rgba(0,0,0,.08);
    }
    .primary,.ghost,.danger{
      flex:1;
      border-radius:14px;
      padding:12px;
      font-weight:900;
      border:1px solid rgba(0,0,0,.10);
      cursor:pointer;
      font-size:13px;
    }
    .ghost{background:#fff;color:var(--ink);}
    .primary{background:#0b1022;color:#fff;border-color:#0b1022;}
    .danger{background:#fff;color:#b91c1c;border-color:rgba(185,28,28,.35);}

    .miniList{display:grid; gap:10px;}
    .miniItem{
      background:#fff;
      border:1px solid rgba(0,0,0,.08);
      box-shadow:var(--shadow2);
      border-radius:16px;
      overflow:hidden;
      display:flex;
      gap:10px;
      cursor:pointer;
      transition: opacity .18s ease;
    }
    .miniItem.done{ opacity:.62; }
    .miniImg{width:72px;height:72px;background:center/cover no-repeat;flex:0 0 auto;}
    .miniText{padding:10px 10px 10px 0;min-width:0;flex:1;}
    .miniText b{display:block;color:var(--ink);font-size:13px;line-height:1.2;}
    .miniText span{display:block;margin-top:6px;color:rgba(11,16,34,.55);font-weight:700;font-size:12px;}
    .tag{
      align-self:center;
      margin-right:10px;
      font-size:11px;
      font-weight:900;
      padding:7px 10px;
      border-radius:999px;
      background:rgba(0,0,0,.06);
      color:rgba(11,16,34,.75);
      border:1px solid rgba(0,0,0,.06);
      white-space:nowrap;
    }
    .tag.done{
      background:rgba(35,199,182,.18);
      border-color:rgba(35,199,182,.30);
      color:#0a3a34;
    }

    .form{display:grid;gap:10px;}
    .field label{
      display:block;
      font-size:12px;
      font-weight:900;
      color:rgba(11,16,34,.65);
      margin:2px 2px 6px;
    }
    .field input,.field select,.field textarea{
      width:100%;
      border-radius:14px;
      border:1px solid rgba(0,0,0,.10);
      padding:12px;
      font-size:14px;
      outline:none;
    }
    .field textarea{min-height:96px;resize:none;}
    .inline{display:flex;gap:10px;}
    .inline .field{flex:1;}
    .switchRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:10px 12px;
      border:1px solid rgba(0,0,0,.10);
      border-radius:14px;
    }
    .switchRow span{font-size:13px;color:rgba(11,16,34,.70);font-weight:900;}
    .smallNote{font-size:12px;color:rgba(11,16,34,.55);font-weight:700;padding:2px 2px 8px;}

    .fileRow{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      padding:10px 12px;
      border:1px solid rgba(0,0,0,.10);
      border-radius:14px;
      background:rgba(0,0,0,.02);
    }
    .fileRow button{
      border:none;
      border-radius:12px;
      padding:10px 12px;
      background:#0b1022;
      color:#fff;
      font-weight:900;
      cursor:pointer;
      font-size:12px;
    }
    .fileRow button:active{transform:translateY(1px)}
    .fileRow span{font-size:12px;font-weight:800;color:rgba(11,16,34,.65);}
    .hiddenInput{display:none}

    /* LIGHTBOX */
    .lightbox{
      position:absolute; inset:0;
      background:rgba(0,0,0,.92);
      display:none;
      z-index:120;
      padding:14px;
    }
    .lightbox.show{display:block;}
    .lbTop{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding-top:calc(env(safe-area-inset-top,0px) + 6px);
      margin-bottom:12px;
    }
    .lbBtn{
      width:42px;height:42px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(255,255,255,.10);
      color:#fff;
      cursor:pointer;
      backdrop-filter:blur(10px);
      -webkit-backdrop-filter:blur(10px);
    }
    .lbBtn:active{transform:translateY(1px)}
    .lbCounter{color:rgba(255,255,255,.85);font-weight:900;font-size:13px;}
    .lbStage{
      height:calc(100% - 120px);
      display:flex;
      align-items:center;
      justify-content:center;
      user-select:none;
      touch-action:pan-y;
    }
    .lbImg{
      max-width:100%;
      max-height:100%;
      border-radius:18px;
      box-shadow:0 20px 70px rgba(0,0,0,.55);
      object-fit:contain;
      background:#111;
    }
    .lbNav{
      position:absolute;
      left:14px; right:14px;
      top:50%;
      transform:translateY(-50%);
      display:flex;
      justify-content:space-between;
      pointer-events:none;
    }
    .lbNav .lbBtn{pointer-events:auto;}
    .lbHint{
      position:absolute;
      left:14px; right:14px;
      bottom:calc(env(safe-area-inset-bottom,0px) + 18px);
      text-align:center;
      color:rgba(255,255,255,.6);
      font-size:12px;
      font-weight:800;
    }

    /* ================= WIZARD ================= */
    .wizardStep{display:none;}
    .wizardStep.active{display:block;}
    .wizardDots{display:flex;gap:8px;justify-content:center;margin:8px 0 10px;}
    .dot{width:8px;height:8px;border-radius:999px;background:rgba(11,16,34,.18);}
    .dot.active{background:rgba(11,16,34,.75);}

    /* COVER GRID */
    .coverGrid{
      display:grid;
      grid-template-columns:1fr 1fr 1fr;
      gap:10px;
      margin-top:10px;
      margin-bottom:10px;
    }
    .coverOpt{
      border-radius:14px;
      border:2px solid rgba(0,0,0,.10);
      overflow:hidden;
      cursor:pointer;
      background:#f0f0f0;
      box-shadow:var(--shadow2);
      transition: transform .12s ease, border-color .12s ease;
      position:relative;
    }
    .coverOpt:active{transform:translateY(1px)}
    .coverOpt img{
      width:100%;
      height:78px;
      object-fit:cover;
      display:block;
    }
    .coverOpt.selected{
      border-color:rgba(35,199,182,.85);
    }
    .coverOpt .cap{
      padding:6px 8px;
      font-size:11px;
      font-weight:900;
      color:rgba(11,16,34,.70);
    }
    .coverOpt.loading img{
      opacity:0;
    }
    .coverSkeleton{
      width:100%;
      height:78px;
      background:linear-gradient(90deg,#e8e8e8 25%,#f5f5f5 50%,#e8e8e8 75%);
      background-size:200% 100%;
      animation:shimmer 1.4s infinite;
      border-radius:12px 12px 0 0;
    }
    @keyframes shimmer{
      0%{background-position:200% 0}
      100%{background-position:-200% 0}
    }

    /* PEXELS CREDIT */
    .pexelsCredit{
      font-size:10px;
      color:rgba(11,16,34,.40);
      font-weight:700;
      text-align:right;
      padding:2px 2px 6px;
    }
    .pexelsCredit a{
      color:rgba(11,16,34,.55);
      text-decoration:none;
    }

    /* API KEY NOTICE */
    .apiNotice{
      background:rgba(255,193,7,.12);
      border:1px solid rgba(255,193,7,.40);
      border-radius:12px;
      padding:10px 12px;
      font-size:12px;
      color:rgba(11,16,34,.75);
      font-weight:700;
      margin-bottom:10px;
    }
    .apiNotice a{
      color:#0b1022;
      text-decoration:underline;
    }
  </style>
</head>

<body>
<div class="frame">

  <!-- LIGHTBOX -->
  <div class="lightbox" id="lightbox">
    <div class="lbTop">
      <button class="lbBtn" id="lbClose" aria-label="Cerrar">‚úï</button>
      <div class="lbCounter" id="lbCounter">1/1</div>
      <div style="width:42px;height:42px;"></div>
    </div>
    <div class="lbStage" id="lbStage">
      <img class="lbImg" id="lbImg" alt="Foto" />
    </div>
    <div class="lbNav">
      <button class="lbBtn" id="lbPrev" aria-label="Anterior">‚Äπ</button>
      <button class="lbBtn" id="lbNext" aria-label="Siguiente">‚Ä∫</button>
    </div>
    <div class="lbHint">Deslice ‚óÄ ‚ñ∂ para cambiar ¬∑ toque fuera para cerrar</div>
  </div>

  <!-- ONBOARDING -->
  <div class="screen active" id="screen-onboarding">
    <section class="onboarding">
      <div class="logo">LA LISTA</div>
      <div class="hero">
        <div class="title">Tus objetivos.<br>Tu historia.</div>
        <div class="subtitle">
          Hola. Bienvenido a <b>La Lista</b>.<br>
          Aqu√≠ guardas lo que quieres hacer, vivir y cumplir,
          para no perder el foco en lo que de verdad importa.
          No es una app m√°s. Es un recordatorio.
        </div>
      </div>
      <div class="ctaWrap">
        <button class="btn" id="start">Empezar ‚Üí</button>
      </div>
    </section>
  </div>

  <!-- APP -->
  <div class="screen" id="screen-app">
    <section class="app">
      <div class="appShell">

        <div class="topbar">
          <h1 id="pageTitle">Mis objetivos</h1>
          <div style="display:flex;gap:8px;">
            <button class="gear" id="searchBtn" aria-label="Ideas">üîç</button>
            <button class="gear" id="gearBtn" aria-label="Ajustes">‚öôÔ∏è</button>
          </div>
        </div>

        <div id="homeHeader">
          <div class="tabs">
            <button class="tab active" data-cat="Todos">Todos</button>
            <button class="tab" data-cat="Viajes">Viajes</button>
            <button class="tab" data-cat="Experiencias">Experiencias</button>
          </div>
          <div style="padding:0 16px 12px;">
            <button class="btn" id="addWizardBtn">A√±adir objetivo</button>
          </div>
        </div>

        <!-- HOME -->
        <div class="content" id="view-home">
          <div class="carousel" id="carousel"></div>
        </div>

        <!-- MAPA -->
        <div class="content" id="view-compass" style="display:none;">
          <div id="map"></div>
        </div>

        <!-- PERFIL -->
        <div class="content" id="view-profile" style="display:none;">
          <div class="profileWrap">
            <div class="sectionTitle">Resumen</div>
            <div class="kpiGrid">
              <div class="kpi">
                <div class="label">Pendientes</div>
                <div class="value" id="kpiPend">0</div>
                <div class="sub">Objetivos por cumplir</div>
              </div>
              <div class="kpi">
                <div class="label">Cumplidos</div>
                <div class="value" id="kpiDone">0</div>
                <div class="sub">Objetivos completados</div>
              </div>
              <div class="kpi">
                <div class="label">Coste total</div>
                <div class="value" id="kpiCostTotal">0‚Ç¨</div>
                <div class="sub">Suma de todos</div>
              </div>
              <div class="kpi">
                <div class="label">Coste pendiente</div>
                <div class="value" id="kpiCostPend">0‚Ç¨</div>
                <div class="sub">Lo que queda</div>
              </div>
            </div>
            <div class="sectionTitle">Pendientes</div>
            <div class="list" id="listPend"></div>
            <div class="sectionTitle" style="margin-top:14px;">Cumplidos</div>
            <div class="list" id="listDone"></div>
          </div>
        </div>

        <!-- AJUSTES MODAL -->
        <div class="modalBack" id="settingsBack">
          <div class="modal" role="dialog" aria-modal="true">
            <div class="modalHead">
              <strong>Ajustes ¬∑ Objetivos</strong>
              <button class="close" id="settingsClose" aria-label="Cerrar">‚úï</button>
            </div>
            <div class="modalBody">
              <div id="settingsListView">
                <div class="smallNote">Toque un objetivo para editarlo. O cree uno nuevo.</div>
                <div class="miniList" id="settingsList"></div>
              </div>
              <div id="settingsFormView" style="display:none;">
                <div class="smallNote" id="formModeNote">Editar objetivo</div>
                <form class="form" id="objForm" onsubmit="return false;">
                  <div class="field">
                    <label>T√≠tulo</label>
                    <input id="fTitle" type="text" placeholder="Ej: Ver auroras boreales" />
                  </div>
                  <div class="inline">
                    <div class="field">
                      <label>Categor√≠a</label>
                      <select id="fCat">
                        <option>Viajes</option>
                        <option>Experiencias</option>
                        <option>Familia</option>
                        <option>Trabajo</option>
                      </select>
                    </div>
                    <div class="field">
                      <label>Coste (‚Ç¨)</label>
                      <input id="fCost" type="number" min="0" step="1" placeholder="0" />
                    </div>
                  </div>
                  <div class="switchRow">
                    <span>¬øCumplido?</span>
                    <input id="fDone" type="checkbox" />
                  </div>
                  <div class="field">
                    <label>Descripci√≥n</label>
                    <textarea id="fDesc" placeholder="Escriba el por qu√©, el plan, el detalle‚Ä¶"></textarea>
                  </div>
                  <div class="field">
                    <label>Imagen principal (URL)</label>
                    <input id="fImg0" type="url" placeholder="https://‚Ä¶" />
                  </div>
                  <div class="inline">
                    <div class="field">
                      <label>Miniatura 1 (URL)</label>
                      <input id="fImg1" type="url" placeholder="https://‚Ä¶" />
                    </div>
                    <div class="field">
                      <label>Miniatura 2 (URL)</label>
                      <input id="fImg2" type="url" placeholder="https://‚Ä¶" />
                    </div>
                  </div>
                  <div class="field">
                    <label>Miniatura 3 (URL)</label>
                    <input id="fImg3" type="url" placeholder="https://‚Ä¶" />
                  </div>
                  <div class="field">
                    <label>Fotos del m√≥vil (local) ‚Äî la primera ser√° portada</label>
                    <div class="fileRow">
                      <button type="button" id="pickLocalBtn">A√±adir fotos</button>
                      <span id="localCount">0 seleccionadas</span>
                    </div>
                    <input class="hiddenInput" id="localFiles" type="file" accept="image/*" multiple />
                    <div class="smallNote">Se guardan en localStorage. Muchas fotos grandes puede agotar el l√≠mite.</div>
                  </div>
                  <div class="field">
                    <label>Lugar (texto)</label>
                    <input id="fPlace" type="text" placeholder="Ej: Troms√∏, Noruega" />
                  </div>
                  <div class="inline">
                    <div class="field">
                      <label>Latitud</label>
                      <input id="fLat" type="number" step="0.000001" placeholder="Ej: 69.6492" />
                    </div>
                    <div class="field">
                      <label>Longitud</label>
                      <input id="fLng" type="number" step="0.000001" placeholder="Ej: 18.9553" />
                    </div>
                  </div>
                  <div class="smallNote">Si no pone lat/lng, el objetivo no aparece en el mapa.</div>
                </form>
              </div>
            </div>
            <div class="modalActions" id="settingsActionsList">
              <button class="ghost" id="btnAdd">A√±adir</button>
              <button class="primary" id="btnCloseList">Cerrar</button>
            </div>
            <div class="modalActions" id="settingsActionsForm" style="display:none;">
              <button class="danger" id="btnDelete">Borrar</button>
              <button class="ghost" id="btnBackToList">Volver</button>
              <button class="primary" id="btnSave">Guardar</button>
            </div>
          </div>
        </div>

        <!-- IDEAS MODAL -->
        <div class="modalBack" id="ideasBack">
          <div class="modal" role="dialog" aria-modal="true">
            <div class="modalHead">
              <strong>Explorar ideas</strong>
              <button class="close" id="ideasClose" aria-label="Cerrar">‚úï</button>
            </div>
            <div class="modalBody">
              <div class="ideaTabs">
                <button class="ideaTab active" data-idea-cat="Viajes">Viajes</button>
                <button class="ideaTab" data-idea-cat="Familia">Familia</button>
                <button class="ideaTab" data-idea-cat="Trabajo">Trabajo</button>
              </div>
              <div class="smallNote">Toque "A√±adir" y lo montamos r√°pido paso a paso.</div>
              <div class="miniList" id="ideasList"></div>
            </div>
            <div class="modalActions">
              <button class="primary" id="ideasClose2">Cerrar</button>
            </div>
          </div>
        </div>

        <!-- WIZARD MODAL -->
        <div class="modalBack" id="wizardBack">
          <div class="modal" role="dialog" aria-modal="true">
            <div class="modalHead">
              <strong>Nuevo objetivo</strong>
              <button class="close" id="wizardClose" aria-label="Cerrar">‚úï</button>
            </div>
            <div class="modalBody">
              <div class="wizardDots" id="wizardDots"></div>

              <div class="wizardStep active" data-step="0">
                <div class="smallNote">Paso 1 ¬∑ T√≠tulo</div>
                <div class="field">
                  <label>T√≠tulo</label>
                  <input id="wTitle" type="text" placeholder="Ej: Dormir en un igl√∫" />
                </div>
              </div>

              <div class="wizardStep" data-step="1">
                <div class="smallNote">Paso 2 ¬∑ Categor√≠a + Coste</div>
                <div class="field">
                  <label>Categor√≠a</label>
                  <select id="wCat">
                    <option>Viajes</option>
                    <option>Experiencias</option>
                    <option>Familia</option>
                    <option>Trabajo</option>
                  </select>
                </div>
                <div class="field">
                  <label>Coste (‚Ç¨)</label>
                  <input id="wCost" type="number" min="0" step="1" placeholder="0" />
                </div>
              </div>

              <div class="wizardStep" data-step="2">
                <div class="smallNote">Paso 3 ¬∑ Descripci√≥n</div>
                <div class="field">
                  <label>Descripci√≥n</label>
                  <textarea id="wDesc" placeholder="¬øPor qu√© lo quieres hacer? ¬øC√≥mo te lo imaginas?"></textarea>
                </div>
              </div>

              <div class="wizardStep" data-step="3">
                <div class="smallNote">Paso 4 ¬∑ Lugar + Coordenadas (opcional)</div>
                <div class="field">
                  <label>Lugar</label>
                  <input id="wPlace" type="text" placeholder="Ej: Troms√∏, Noruega" />
                </div>
                <div class="inline">
                  <div class="field">
                    <label>Lat</label>
                    <input id="wLat" type="number" step="0.000001" placeholder="Ej: 69.6492" />
                  </div>
                  <div class="field">
                    <label>Lng</label>
                    <input id="wLng" type="number" step="0.000001" placeholder="Ej: 18.9553" />
                  </div>
                </div>
              </div>

              <div class="wizardStep" data-step="4">
                <div class="smallNote">Paso 5 ¬∑ Foto ¬∑ la primera foto local ser√° portada</div>

                <!-- Buscador Pexels -->
                <div class="field">
                  <label>Buscar im√°genes (Pexels)</label>
                  <div style="display:flex;gap:8px;">
                    <input id="wSearchQuery" type="text" placeholder="Ej: aurora boreal noruega" style="flex:1;" />
                    <button type="button" id="wSearchBtn" style="border:none;border-radius:14px;padding:12px 14px;background:#0b1022;color:#fff;font-weight:900;cursor:pointer;font-size:13px;white-space:nowrap;">Buscar</button>
                  </div>
                </div>

                <div id="pexelsApiNotice" class="apiNotice" style="display:none;">
                  ‚ö†Ô∏è A√±ade tu API key de <a href="https://www.pexels.com/api/" target="_blank">Pexels (gratis)</a> en el c√≥digo para activar la b√∫squeda de im√°genes.
                </div>

                <div class="coverGrid" id="coverGrid"></div>
                <div class="pexelsCredit" id="pexelsCredit" style="display:none;">
                  Fotos de <a href="https://www.pexels.com" target="_blank">Pexels</a>
                </div>

                <div class="field" style="margin-top:8px;">
                  <label>O pega una URL directamente</label>
                  <input id="wImgUrl" type="url" placeholder="https://‚Ä¶" />
                </div>

                <div class="field">
                  <label>Fotos del m√≥vil (local)</label>
                  <div class="fileRow">
                    <button type="button" id="wPickLocalBtn">A√±adir fotos</button>
                    <span id="wLocalCount">0 seleccionadas</span>
                  </div>
                  <input class="hiddenInput" id="wLocalFiles" type="file" accept="image/*" multiple />
                  <div class="smallNote">Muchas fotos grandes pueden llenar el l√≠mite de storage local.</div>
                </div>
              </div>
            </div>

            <div class="modalActions">
              <button class="ghost" id="wPrev">Atr√°s</button>
              <button class="primary" id="wNext">Siguiente</button>
            </div>
          </div>
        </div>

      </div>

      <!-- NAV -->
      <div class="nav">
        <div class="navInner">
          <button class="navBtn active" data-nav="home" aria-label="Inicio">‚åÇ</button>
          <button class="navBtn" data-nav="compass" aria-label="Mapa">üß≠</button>
          <button class="navBtn" data-nav="profile" aria-label="Perfil">üë§</button>
        </div>
      </div>

    </section>
  </div>

  <!-- DETALLE -->
  <div class="screen" id="screen-detail">
    <section class="detail">
      <div class="detailShell">
        <div class="detailHero" id="detailHero" title="Toque para ver fotos"></div>
        <div class="detailOverlay"></div>
        <div class="detailTopBtns">
          <button class="iconBtn" id="backBtn" aria-label="Volver">‚Üê</button>
          <button class="iconBtn" id="toggleDoneTop" aria-label="Marcar">‚ô°</button>
        </div>
        <div class="detailThumbs" id="detailThumbs"></div>
        <div class="detailTitleBlock">
          <h2 id="detailTitle">‚Äî</h2>
          <div class="subline" id="detailSub">‚Äî</div>
        </div>
        <div class="sheet">
          <div class="chips">
            <div class="chip">
              <div class="k">Categor√≠a</div>
              <div class="v" id="chipCat">‚Äî</div>
            </div>
            <div class="chip">
              <div class="k">Estado</div>
              <div class="v" id="chipState">‚Äî</div>
            </div>
            <div class="chip">
              <div class="k">Coste</div>
              <div class="v" id="chipCost">‚Äî</div>
            </div>
          </div>
          <div class="descTitle">Descripci√≥n</div>
          <div class="desc" id="detailDesc">‚Äî</div>
          <div class="sheetBottom">
            <div>
              <div style="font-size:12px;color:rgba(11,16,34,.55);font-weight:900;">Coste total</div>
              <div class="price" id="detailPrice">‚Äî</div>
            </div>
            <button class="action" id="toggleDoneBtn" aria-label="Cambiar estado">‚Ä∫</button>
          </div>
        </div>
      </div>
    </section>
  </div>

</div>

<script>
/* ================== PEXELS API ================== */
// ‚ö†Ô∏è IMPORTANTE: Reemplaza con tu API key gratuita de https://www.pexels.com/api/
const PEXELS_API_KEY = "TU_API_KEY_AQUI";

async function fetchPexelsImages(query, perPage){
  perPage = perPage || 3;
  const hasKey = PEXELS_API_KEY && PEXELS_API_KEY !== "TU_API_KEY_AQUI";

  if(!hasKey){
    return { photos: getFallbackImages(query), hasKey: false };
  }

  try{
    const url = "https://api.pexels.com/v1/search?query="
      + encodeURIComponent(query)
      + "&per_page=" + perPage
      + "&orientation=landscape";

    const res = await fetch(url, {
      headers: { "Authorization": PEXELS_API_KEY }
    });

    if(!res.ok) throw new Error("Pexels error " + res.status);

    const data = await res.json();

    if(!data.photos || !data.photos.length){
      return { photos: getFallbackImages(query), hasKey: true };
    }

    const photos = data.photos.map(function(p){
      return {
        url: p.src.large2x || p.src.large,
        thumb: p.src.medium,
        photographer: p.photographer,
        photographerUrl: p.photographer_url
      };
    });

    return { photos: photos, hasKey: true };
  }catch(err){
    console.warn("Pexels fetch error:", err);
    return { photos: getFallbackImages(query), hasKey: false };
  }
}

function getFallbackImages(query){
  // Fallback con seeds fijos para que sean consistentes
  var topics = ["travel","nature","landscape","adventure","sky"];
  return [0,1,2].map(function(i){
    var topic = topics[i % topics.length];
    return {
      url: "https://picsum.photos/seed/" + encodeURIComponent(query + i) + "/800/500",
      thumb: "https://picsum.photos/seed/" + encodeURIComponent(query + i) + "/400/250",
      photographer: "Lorem Picsum",
      photographerUrl: "https://picsum.photos"
    };
  });
}

/* ================== STORAGE ================== */
var STORAGE_KEY = "lalista_objetivos_v6_clean";

function loadObjetivos(){
  try{
    var raw = localStorage.getItem(STORAGE_KEY);
    if(!raw) return [];
    var data = JSON.parse(raw);
    if(!Array.isArray(data)) return [];
    return data;
  }catch(e){
    return [];
  }
}

function saveObjetivos(){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(objetivos));
}

var objetivos = loadObjetivos();

/* ================== HELPERS ================== */
var $ = function(q){ return document.querySelector(q); };
var $$ = function(q){ return document.querySelectorAll(q); };

function eur(n){
  return (Math.round((Number(n)||0) * 100) / 100).toLocaleString("es-ES") + "‚Ç¨";
}

function escapeHTML(str){
  return String(str).replace(/[&<>"']/g, function(s){
    return {"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"}[s];
  });
}

function firstImg(o){
  return (o.imgs && o.imgs.length) ? o.imgs[0] : "";
}

/* ================== SCREENS ================== */
var screenOnboarding = $("#screen-onboarding");
var screenApp = $("#screen-app");
var screenDetail = $("#screen-detail");
var pageTitle = $("#pageTitle");
var homeHeader = $("#homeHeader");
var viewHome = $("#view-home");
var viewCompass = $("#view-compass");
var viewProfile = $("#view-profile");

function showOnly(view){
  viewHome.style.display = (view === "home") ? "block" : "none";
  viewCompass.style.display = (view === "compass") ? "block" : "none";
  viewProfile.style.display = (view === "profile") ? "block" : "none";
}

function setNavActive(which){
  $$(".navBtn").forEach(function(b){ b.classList.remove("active"); });
  var btn = document.querySelector('.navBtn[data-nav="' + which + '"]');
  if(btn) btn.classList.add("active");
}

function showView(which){
  setNavActive(which);
  if(which === "home"){
    pageTitle.textContent = "Mis objetivos";
    homeHeader.style.display = "block";
    showOnly("home");
    return;
  }
  if(which === "compass"){
    pageTitle.textContent = "Mapa";
    homeHeader.style.display = "none";
    showOnly("compass");
    initMapIfNeeded();
    setTimeout(function(){
      if(map){ map.invalidateSize(); renderMapMarkers(); }
    }, 60);
    return;
  }
  if(which === "profile"){
    pageTitle.textContent = "Perfil";
    homeHeader.style.display = "none";
    showOnly("profile");
    renderProfile();
    return;
  }
}

$$(".navBtn").forEach(function(btn){
  btn.addEventListener("click", function(){ showView(btn.dataset.nav); });
});

/* ================== HOME ================== */
var carousel = $("#carousel");
var currentCat = "Todos";

function renderHome(cat){
  cat = cat || "Todos";
  currentCat = cat;
  var list = objetivos.filter(function(o){ return cat === "Todos" || o.cat === cat; });

  carousel.innerHTML = list.map(function(o){
    return '<article class="objCard ' + (o.done ? "done" : "") + '" data-id="' + o.id + '">'
      + '<div class="objImg" style="background-image:url(\'' + firstImg(o) + '\')"></div>'
      + '<div class="objBody">'
      + '<div>'
      + '<div class="objTitle">' + escapeHTML(o.titulo) + '</div>'
      + '<div class="objMeta">' + escapeHTML(o.cat) + ' ¬∑ ' + eur(o.coste) + (o.place ? " ¬∑ " + escapeHTML(o.place) : "") + '</div>'
      + '</div>'
      + '<div class="badge ' + (o.done ? "done" : "") + '">' + (o.done ? "Cumplido" : o.cat) + '</div>'
      + '</div>'
      + '</article>';
  }).join("");

  carousel.scrollTo({left:0, behavior:"auto"});
}

$$(".tab").forEach(function(t){
  t.addEventListener("click", function(){
    $$(".tab").forEach(function(x){ x.classList.remove("active"); });
    t.classList.add("active");
    renderHome(t.dataset.cat);
  });
});

carousel.addEventListener("click", function(e){
  var card = e.target.closest(".objCard");
  if(!card) return;
  openDetail(Number(card.dataset.id));
});

/* ================== PROFILE ================== */
function renderProfile(){
  var pend = objetivos.filter(function(o){ return !o.done; });
  var done = objetivos.filter(function(o){ return o.done; });
  var costTotal = objetivos.reduce(function(a,o){ return a+(Number(o.coste)||0); }, 0);
  var costPend = pend.reduce(function(a,o){ return a+(Number(o.coste)||0); }, 0);
  var costDone = done.reduce(function(a,o){ return a+(Number(o.coste)||0); }, 0);

  $("#kpiPend").textContent = pend.length;
  $("#kpiDone").textContent = done.length;
  $("#kpiCostTotal").textContent = eur(costTotal);
  $("#kpiCostPend").textContent = eur(costPend);

  $("#listPend").innerHTML = pend.length
    ? pend.map(function(o){
        return '<div class="rowItem"><div class="rowLeft"><strong>' + escapeHTML(o.titulo) + '</strong><small>' + escapeHTML(o.cat) + (o.place ? " ¬∑ " + escapeHTML(o.place) : "") + '</small></div><div class="cost">' + eur(o.coste||0) + '</div></div>';
      }).join("")
    : '<div class="rowItem"><div class="rowLeft"><strong>Todo hecho üòÆ‚Äçüí®</strong><small>No hay pendientes.</small></div><div class="cost">0‚Ç¨</div></div>';

  $("#listDone").innerHTML = done.length
    ? done.map(function(o){
        return '<div class="rowItem"><div class="rowLeft"><strong>' + escapeHTML(o.titulo) + '</strong><small>' + escapeHTML(o.cat) + (o.place ? " ¬∑ " + escapeHTML(o.place) : "") + '</small></div><div class="cost">' + eur(o.coste||0) + '</div></div>';
      }).join("")
    : '<div class="rowItem"><div class="rowLeft"><strong>A√∫n ninguno cumplido</strong><small>Se empieza por uno.</small></div><div class="cost">' + eur(costDone) + '</div></div>';
}

/* ================== LIGHTBOX ================== */
var lightbox = $("#lightbox");
var lbImg = $("#lbImg");
var lbCounter = $("#lbCounter");
var lbClose = $("#lbClose");
var lbPrev = $("#lbPrev");
var lbNext = $("#lbNext");
var lbStage = $("#lbStage");
var galleryImgs = [];
var galleryIdx = 0;

function openLightbox(imgs, startIndex){
  startIndex = startIndex || 0;
  galleryImgs = Array.isArray(imgs) ? imgs.filter(Boolean) : [];
  if(!galleryImgs.length) return;
  galleryIdx = Math.max(0, Math.min(startIndex, galleryImgs.length-1));
  renderLightbox();
  lightbox.classList.add("show");
}
function closeLightbox(){ lightbox.classList.remove("show"); }
function renderLightbox(){
  lbImg.src = galleryImgs[galleryIdx];
  lbCounter.textContent = (galleryIdx+1) + "/" + galleryImgs.length;
  lbPrev.style.visibility = galleryImgs.length > 1 ? "visible" : "hidden";
  lbNext.style.visibility = galleryImgs.length > 1 ? "visible" : "hidden";
}
function prevImg(){
  if(!galleryImgs.length) return;
  galleryIdx = (galleryIdx - 1 + galleryImgs.length) % galleryImgs.length;
  renderLightbox();
}
function nextImg(){
  if(!galleryImgs.length) return;
  galleryIdx = (galleryIdx + 1) % galleryImgs.length;
  renderLightbox();
}

lbClose.addEventListener("click", closeLightbox);
lbPrev.addEventListener("click", prevImg);
lbNext.addEventListener("click", nextImg);
lightbox.addEventListener("click", function(e){
  var keep = (e.target === lbImg) || e.target.closest(".lbNav") || e.target.closest(".lbTop");
  if(!keep) closeLightbox();
});
window.addEventListener("keydown", function(e){
  if(!lightbox.classList.contains("show")) return;
  if(e.key === "Escape") closeLightbox();
  if(e.key === "ArrowLeft") prevImg();
  if(e.key === "ArrowRight") nextImg();
});

var lbStartX = null;
lbStage.addEventListener("touchstart", function(e){
  if(!lightbox.classList.contains("show")) return;
  lbStartX = e.touches[0].clientX;
}, {passive:true});
lbStage.addEventListener("touchend", function(e){
  if(lbStartX === null) return;
  var dx = e.changedTouches[0].clientX - lbStartX;
  lbStartX = null;
  if(Math.abs(dx) < 40) return;
  if(dx > 0) prevImg(); else nextImg();
}, {passive:true});

/* ================== DETALLE ================== */
var selectedId = null;

function openDetail(id){
  selectedId = id;
  var o = objetivos.find(function(x){ return x.id === id; });
  if(!o) return;

  $("#detailHero").style.backgroundImage = "url('" + firstImg(o) + "')";
  $("#detailTitle").textContent = o.titulo;
  var place = o.place ? " ¬∑ " + o.place : "";
  $("#detailSub").textContent = o.cat + " ¬∑ " + (o.done ? "Cumplido" : "Pendiente") + place;
  $("#chipCat").textContent = o.cat;
  $("#chipState").textContent = o.done ? "Cumplido" : "Pendiente";
  $("#chipCost").textContent = eur(o.coste);
  $("#detailPrice").textContent = eur(o.coste);
  $("#detailDesc").textContent = o.desc || "A√±ada una descripci√≥n en Ajustes.";
  $("#toggleDoneTop").textContent = o.done ? "‚ô•" : "‚ô°";

  var imgs = (o.imgs && o.imgs.length) ? o.imgs : [];
  $("#detailThumbs").innerHTML = imgs.slice(0,4).map(function(src, idx){
    return '<div class="thumb ' + (idx===0 ? "" : "dim") + '" data-idx="' + idx + '" style="background-image:url(\'' + src + '\')"></div>';
  }).join("");

  screenApp.classList.remove("active");
  screenDetail.classList.add("active");
}

function closeDetail(){
  screenDetail.classList.remove("active");
  screenApp.classList.add("active");
}

function toggleDone(){
  var o = objetivos.find(function(x){ return x.id === selectedId; });
  if(!o) return;
  o.done = !o.done;
  saveObjetivos();
  var place = o.place ? " ¬∑ " + o.place : "";
  $("#chipState").textContent = o.done ? "Cumplido" : "Pendiente";
  $("#detailSub").textContent = o.cat + " ¬∑ " + (o.done ? "Cumplido" : "Pendiente") + place;
  $("#toggleDoneTop").textContent = o.done ? "‚ô•" : "‚ô°";
  renderHome(currentCat);
  if(viewProfile.style.display !== "none") renderProfile();
  if(map) renderMapMarkers();
}

$("#backBtn").addEventListener("click", closeDetail);
$("#toggleDoneBtn").addEventListener("click", toggleDone);
$("#toggleDoneTop").addEventListener("click", toggleDone);
$("#detailHero").addEventListener("click", function(){
  var o = objetivos.find(function(x){ return x.id === selectedId; });
  if(!o) return;
  openLightbox(o.imgs || [], 0);
});
$("#detailThumbs").addEventListener("click", function(e){
  var t = e.target.closest(".thumb");
  if(!t) return;
  var o = objetivos.find(function(x){ return x.id === selectedId; });
  if(!o) return;
  openLightbox(o.imgs || [], Number(t.dataset.idx));
});

/* ================== MAPA ================== */
var map = null;
var markersLayer = null;

function initMapIfNeeded(){
  if(map) return;
  map = L.map("map", {zoomControl:true}).setView([20,0],2);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom:19, attribution:"&copy; OpenStreetMap"
  }).addTo(map);
  markersLayer = L.layerGroup().addTo(map);
}

function renderMapMarkers(){
  if(!map || !markersLayer) return;
  markersLayer.clearLayers();
  var points = [];

  objetivos.forEach(function(o){
    var lat = typeof o.lat === "number" ? o.lat : (o.lat === "" ? null : Number(o.lat));
    var lng = typeof o.lng === "number" ? o.lng : (o.lng === "" ? null : Number(o.lng));
    if(!Number.isFinite(lat) || !Number.isFinite(lng)) return;

    points.push([lat,lng]);
    var marker = L.marker([lat,lng]).addTo(markersLayer);
    var placeHtml = o.place ? '<div style="opacity:.75;font-size:12px;margin-top:4px">' + escapeHTML(o.place) + '</div>' : "";
    var status = o.done ? "Cumplido" : "Pendiente";

    marker.bindPopup(
      '<div style="display:flex;gap:10px;align-items:center;min-width:220px">'
      + '<div style="width:46px;height:46px;border-radius:12px;background:#ddd center/cover no-repeat;flex:0 0 auto;background-image:url(\'' + firstImg(o) + '\')"></div>'
      + '<div style="min-width:0"><div style="font-weight:900;line-height:1.15">' + escapeHTML(o.titulo) + '</div>'
      + '<div style="opacity:.75;font-size:12px;margin-top:4px">' + escapeHTML(o.cat) + ' ¬∑ ' + escapeHTML(status) + '</div>'
      + placeHtml + '</div></div>'
      + '<div style="margin-top:10px;display:flex;justify-content:flex-end">'
      + '<button data-open-id="' + o.id + '" style="border:none;padding:10px 12px;border-radius:12px;background:#0b1022;color:#fff;font-weight:900;cursor:pointer">Ver detalle ‚Üí</button>'
      + '</div>'
    );
  });

  if(points.length){
    map.fitBounds(L.latLngBounds(points), {padding:[30,30]});
  }else{
    map.setView([20,0],2);
  }
}

document.addEventListener("click", function(e){
  var btn = e.target.closest("[data-open-id]");
  if(!btn) return;
  var id = Number(btn.dataset.openId);
  if(!Number.isFinite(id)) return;
  if(map) map.closePopup();
  openDetail(id);
});

/* ================== AJUSTES (CRUD) ================== */
var settingsBack = $("#settingsBack");
var settingsClose = $("#settingsClose");
var btnCloseList = $("#btnCloseList");
var btnAdd = $("#btnAdd");
var settingsListView = $("#settingsListView");
var settingsFormView = $("#settingsFormView");
var settingsList = $("#settingsList");
var settingsActionsList = $("#settingsActionsList");
var settingsActionsForm = $("#settingsActionsForm");
var btnBackToList = $("#btnBackToList");
var btnSave = $("#btnSave");
var btnDelete = $("#btnDelete");
var formModeNote = $("#formModeNote");
var fTitle = $("#fTitle");
var fCat = $("#fCat");
var fCost = $("#fCost");
var fDone = $("#fDone");
var fDesc = $("#fDesc");
var fImg0 = $("#fImg0");
var fImg1 = $("#fImg1");
var fImg2 = $("#fImg2");
var fImg3 = $("#fImg3");
var fPlace = $("#fPlace");
var fLat = $("#fLat");
var fLng = $("#fLng");
var pickLocalBtn = $("#pickLocalBtn");
var localFiles = $("#localFiles");
var localCount = $("#localCount");
var editingId = null;
var pendingLocalImgs = [];

function openSettings(){
  editingId = null;
  pendingLocalImgs = [];
  updateLocalCount();
  showSettingsList();
  settingsBack.classList.add("show");
}
function closeSettings(){ settingsBack.classList.remove("show"); }

$("#gearBtn").addEventListener("click", openSettings);
settingsClose.addEventListener("click", closeSettings);
btnCloseList.addEventListener("click", closeSettings);
settingsBack.addEventListener("click", function(e){ if(e.target===settingsBack) closeSettings(); });

function showSettingsList(){
  settingsListView.style.display = "block";
  settingsFormView.style.display = "none";
  settingsActionsList.style.display = "flex";
  settingsActionsForm.style.display = "none";

  settingsList.innerHTML = objetivos
    .slice()
    .sort(function(a,b){ return a.done===b.done ? a.id-b.id : (a.done ? 1 : -1); })
    .map(function(o){
      return '<div class="miniItem ' + (o.done ? "done" : "") + '" data-id="' + o.id + '">'
        + '<div class="miniImg" style="background-image:url(\'' + firstImg(o) + '\')"></div>'
        + '<div class="miniText"><b>' + escapeHTML(o.titulo) + '</b>'
        + '<span>' + escapeHTML(o.cat) + ' ¬∑ ' + eur(o.coste) + (o.place ? " ¬∑ " + escapeHTML(o.place) : "") + '</span></div>'
        + '<div class="tag ' + (o.done ? "done" : "") + '">' + (o.done ? "Cumplido" : "Pendiente") + '</div>'
        + '</div>';
    }).join("") || '<div class="smallNote">No hay objetivos. A√±ada el primero.</div>';
}

function showSettingsForm(mode){
  settingsListView.style.display = "none";
  settingsFormView.style.display = "block";
  settingsActionsList.style.display = "none";
  settingsActionsForm.style.display = "flex";
  formModeNote.textContent = mode === "new" ? "Nuevo objetivo" : "Editar objetivo";
}

function fillForm(o){
  fTitle.value = o ? (o.titulo || "") : "";
  fCat.value = o ? (o.cat || "Viajes") : "Viajes";
  fCost.value = o ? (o.coste || 0) : 0;
  fDone.checked = o ? !!o.done : false;
  fDesc.value = o ? (o.desc || "") : "";
  var imgs = (o && o.imgs && o.imgs.length) ? o.imgs : ["","","",""];
  fImg0.value = imgs[0] && imgs[0].startsWith("data:") ? "" : (imgs[0] || "");
  fImg1.value = imgs[1] && imgs[1].startsWith("data:") ? "" : (imgs[1] || "");
  fImg2.value = imgs[2] && imgs[2].startsWith("data:") ? "" : (imgs[2] || "");
  fImg3.value = imgs[3] && imgs[3].startsWith("data:") ? "" : (imgs[3] || "");
  fPlace.value = o ? (o.place || "") : "";
  fLat.value = o ? (o.lat != null ? o.lat : "") : "";
  fLng.value = o ? (o.lng != null ? o.lng : "") : "";
  pendingLocalImgs = [];
  updateLocalCount();
  localFiles.value = "";
}

function updateLocalCount(){
  localCount.textContent = pendingLocalImgs.length + " seleccionadas";
}

function readFormUrls(){
  return [fImg0.value, fImg1.value, fImg2.value, fImg3.value]
    .map(function(s){ return (s||"").trim(); })
    .filter(Boolean);
}

function readForm(){
  var titulo = fTitle.value.trim();
  var cat = fCat.value;
  var coste = Number(fCost.value || 0);
  var done = !!fDone.checked;
  var desc = fDesc.value.trim();
  var place = fPlace.value.trim();
  var latRaw = (fLat.value || "").trim();
  var lngRaw = (fLng.value || "").trim();
  var lat = latRaw === "" ? null : Number(latRaw);
  var lng = lngRaw === "" ? null : Number(lngRaw);
  var urlImgs = readFormUrls();
  return {titulo:titulo, cat:cat, coste:coste, done:done, desc:desc, place:place, lat:lat, lng:lng, urlImgs:urlImgs};
}

async function filesToDataUrls(files){
  var arr = Array.from(files || []);
  var results = [];
  for(var i=0; i<arr.length; i++){
    var file = arr[i];
    if(!file.type.startsWith("image/")) continue;
    var dataUrl = await new Promise(function(resolve, reject){
      var r = new FileReader();
      r.onload = function(){ resolve(r.result); };
      r.onerror = reject;
      r.readAsDataURL(file);
    });
    results.push(dataUrl);
  }
  return results;
}

pickLocalBtn.addEventListener("click", function(){ localFiles.click(); });
localFiles.addEventListener("change", async function(){
  if(!localFiles.files || !localFiles.files.length) return;
  try{
    var dataUrls = await filesToDataUrls(localFiles.files);
    pendingLocalImgs.push.apply(pendingLocalImgs, dataUrls);
    updateLocalCount();
  }catch(e){
    alert("No se han podido cargar una o m√°s fotos.");
  }finally{
    localFiles.value = "";
  }
});

btnAdd.addEventListener("click", function(){
  editingId = null;
  fillForm(null);
  showSettingsForm("new");
  btnDelete.style.display = "none";
});

settingsList.addEventListener("click", function(e){
  var item = e.target.closest(".miniItem");
  if(!item) return;
  var id = Number(item.dataset.id);
  var o = objetivos.find(function(x){ return x.id === id; });
  if(!o) return;
  editingId = id;
  fillForm(o);
  showSettingsForm("edit");
  btnDelete.style.display = "block";
});

btnBackToList.addEventListener("click", function(){
  editingId = null;
  pendingLocalImgs = [];
  updateLocalCount();
  showSettingsList();
});

function refreshEverywhere(){
  saveObjetivos();
  renderHome(currentCat);
  if(viewProfile.style.display !== "none") renderProfile();
  if(map) renderMapMarkers();
  if(selectedId && screenDetail.classList.contains("active")){
    var exists = objetivos.some(function(o){ return o.id === selectedId; });
    if(exists) openDetail(selectedId);
  }
}

btnSave.addEventListener("click", function(){
  var data = readForm();
  if(!data.titulo){ alert("Ponga un t√≠tulo, por favor üôÇ"); return; }
  if((data.lat !== null && !Number.isFinite(data.lat)) || (data.lng !== null && !Number.isFinite(data.lng))){
    alert("Lat/Lng deben ser n√∫meros v√°lidos (o d√©jelos vac√≠os)."); return;
  }

  var finalImgs = [];
  if(pendingLocalImgs.length) finalImgs.push(pendingLocalImgs[0]);
  finalImgs.push.apply(finalImgs, data.urlImgs);

  if(editingId != null){
    var prev = objetivos.find(function(o){ return o.id === editingId; });
    var keepLocal = (prev && prev.imgs ? prev.imgs : []).filter(function(src){ return typeof src === "string" && src.startsWith("data:"); });
    finalImgs.push.apply(finalImgs, keepLocal);
  }

  if(pendingLocalImgs.length > 1) finalImgs.push.apply(finalImgs, pendingLocalImgs.slice(1));

  finalImgs = Array.from(new Set(finalImgs)).filter(Boolean);

  if(!finalImgs.length){ alert("A√±ada al menos una imagen (URL o foto del m√≥vil)."); return; }

  if(editingId == null){
    var nextId = objetivos.reduce(function(m,o){ return Math.max(m, Number(o.id)||0); }, 0) + 1;
    objetivos.unshift({id:nextId, titulo:data.titulo, cat:data.cat, coste:data.coste, done:data.done, desc:data.desc, imgs:finalImgs, place:data.place, lat:data.lat, lng:data.lng});
  }else{
    var idx = objetivos.findIndex(function(x){ return x.id === editingId; });
    if(idx >= 0){
      objetivos[idx] = Object.assign({}, objetivos[idx], {titulo:data.titulo, cat:data.cat, coste:data.coste, done:data.done, desc:data.desc, imgs:finalImgs, place:data.place, lat:data.lat, lng:data.lng});
    }
  }

  pendingLocalImgs = [];
  updateLocalCount();
  refreshEverywhere();
  showSettingsList();
});

btnDelete.addEventListener("click", function(){
  if(editingId == null) return;
  var o = objetivos.find(function(x){ return x.id === editingId; });
  if(!confirm('¬øBorrar "' + (o ? o.titulo : "objetivo") + '"?')) return;
  objetivos = objetivos.filter(function(x){ return x.id !== editingId; });
  if(selectedId === editingId && screenDetail.classList.contains("active")) closeDetail();
  editingId = null;
  pendingLocalImgs = [];
  updateLocalCount();
  refreshEverywhere();
  showSettingsList();
});

/* ================== IDEAS ================== */
var ideasBack = $("#ideasBack");
var ideasList = $("#ideasList");
var ideasClose = $("#ideasClose");
var ideasClose2 = $("#ideasClose2");

var ideasCatalogo = {
  Viajes:[
    "Torre Eiffel","Museo del Louvre","Mont Saint-Michel","Costa Azul","Provenza",
    "Coliseo de Roma","Venecia","Torre de Pisa","Costa Amalfitana","Florencia",
    "Sagrada Familia","Londres y Big Ben","Berl√≠n","Viena","Fiordos noruegos",
    "Gran Ca√±√≥n","Times Square","Golden Gate","Las Vegas","Yellowstone",
    "Chich√©n Itz√°","Machu Picchu","Cristo Redentor","Amazonas","Buenos Aires",
    "Gran Muralla China","Tokio","Monte Fuji","Kioto (Fushimi Inari)","Shangh√°i",
    "Bangkok","Taj Mahal","Burj Khalifa","Islas de Tailandia","Desierto de Dub√°i",
    "Pir√°mides de Giza","Sahara","Marrakech","Safari Serengeti","Cataratas Victoria",
    "Auroras en Islandia","Patagonia","Gran Barrera de Coral","Volc√°n activo","Alpes",
    "Ruta 66","Transiberiano","Himalaya","Igl√∫ de cristal","Avistamiento de ballenas",
    "Maldivas","Bora Bora","Santorini","Bali","Haw√°i",
    "Seychelles","Filipinas","Mauricio","Ibiza","Islas Feroe",
    "Nueva York en Navidad","Dub√°i","Singapur","Hong Kong","Estambul",
    "Praga","√Åmsterdam","Budapest","Edimburgo","Chicago",
    "Globo en Capadocia","Carnaval de R√≠o","Oktoberfest","A√±o Nuevo en S√≠dney",
    "Ruta gastron√≥mica por Jap√≥n","Crucero Caribe","Ryokan en Jap√≥n","Viaje solo",
    "5 continentes","50 pa√≠ses antes de los 50","Interrail","Vivir 6 meses fuera",
    "Mochilero por Sudam√©rica","N√≥mada digital","Roadtrip 30 d√≠as",
    "Camino de Santiago","Dormir en el desierto",
    "7 maravillas modernas","10 Patrimonios UNESCO",
    "Viaje con padres","Disney con hijos","Viaje sorpresa","Viaje √©pico de jubilaci√≥n"
  ],
  Familia:[
    "Tener mi primer hijo/a antes de los 35","Crear tradiciones familiares propias",
    "Gran viaje familiar cada verano","Dise√±ar la casa de mis sue√±os",
    "Llegar a la vejez rodeado de hijos y nietos","Comidas familiares todos los domingos",
    "Cita mensual obligatoria con mi pareja","Renovar votos a los 10 a√±os",
    "Vivir un a√±o en el extranjero en familia","Transmitir recetas familiares",
    "√Ålbum f√≠sico familiar cada a√±o","Crear fondo familiar de emergencia",
    "Dejar herencia s√≥lida","Celebrar todos los cumplea√±os juntos",
    "Gran reuni√≥n familiar cada 5 a√±os","Cuidar de mis padres cuando lo necesiten",
    "Viaje individual con cada hijo","Ense√±ar educaci√≥n financiera a mis hijos",
    "Construir negocio familiar","Superar juntos una crisis econ√≥mica"
  ],
  Trabajo:[
    "Conseguir primer ascenso antes de los 30","Alcanzar puesto directivo antes de los 40",
    "Liderar equipo de m√°s de 20 personas","Ser referente en mi sector",
    "Cambiar de sector con √©xito","Trabajar en empresa internacional",
    "Lograr puesto 100% remoto","Negociar aumento del 20%",
    "Superar 50.000‚Ç¨ anuales antes de los 35","Alcanzar 100.000‚Ç¨ anuales antes de los 45",
    "Crear negocio propio antes de los 35","Lanzar producto digital rentable",
    "Automatizar 50% de procesos","Abrir segunda l√≠nea de negocio",
    "Delegar completamente la operativa","Monetizar un hobby",
    "Construir marca personal s√≥lida","Hablar en evento profesional",
    "Independencia financiera antes de los 55","Jubilarme antes de la edad legal"
  ]
};

function openIdeas(cat){
  cat = cat || "Viajes";
  $$(".ideaTab").forEach(function(b){ b.classList.remove("active"); });
  var activeTab = document.querySelector('.ideaTab[data-idea-cat="' + cat + '"]');
  if(activeTab) activeTab.classList.add("active");
  renderIdeas(cat);
  ideasBack.classList.add("show");
}
function closeIdeas(){ ideasBack.classList.remove("show"); }

function renderIdeas(cat){
  var list = ideasCatalogo[cat] || [];
  ideasList.innerHTML = list.map(function(t){
    return '<div class="miniItem">'
      + '<div class="miniText"><b>' + escapeHTML(t) + '</b><span>' + escapeHTML(cat) + '</span></div>'
      + '<div class="tag" data-idea-add="1" data-idea-title="' + escapeHTML(t) + '" data-idea-cat="' + escapeHTML(cat) + '">A√±adir</div>'
      + '</div>';
  }).join("") || '<div class="smallNote">No hay ideas aqu√≠ (todav√≠a).</div>';
}

$("#searchBtn").addEventListener("click", function(){ openIdeas("Viajes"); });
ideasClose.addEventListener("click", closeIdeas);
ideasClose2.addEventListener("click", closeIdeas);
ideasBack.addEventListener("click", function(e){ if(e.target===ideasBack) closeIdeas(); });

$$(".ideaTab").forEach(function(btn){
  btn.addEventListener("click", function(){
    $$(".ideaTab").forEach(function(b){ b.classList.remove("active"); });
    btn.classList.add("active");
    renderIdeas(btn.dataset.ideaCat);
  });
});

document.addEventListener("click", function(e){
  var add = e.target.closest("[data-idea-add]");
  if(!add) return;
  var title = add.dataset.ideaTitle || "";
  var cat = add.dataset.ideaCat || "Viajes";
  closeIdeas();
  openWizard({titulo: title, cat: cat});
});

/* ================== WIZARD ================== */
var wizardBack = $("#wizardBack");
var wizardClose = $("#wizardClose");
var wPrev = $("#wPrev");
var wNext = $("#wNext");
var wizardDots = $("#wizardDots");
var wTitle = $("#wTitle");
var wCat = $("#wCat");
var wCost = $("#wCost");
var wDesc = $("#wDesc");
var wPlace = $("#wPlace");
var wLat = $("#wLat");
var wLng = $("#wLng");
var wImgUrl = $("#wImgUrl");
var coverGrid = $("#coverGrid");
var pexelsCredit = $("#pexelsCredit");
var pexelsApiNotice = $("#pexelsApiNotice");
var wSearchQuery = $("#wSearchQuery");
var wSearchBtn = $("#wSearchBtn");
var wPickLocalBtn = $("#wPickLocalBtn");
var wLocalFiles = $("#wLocalFiles");
var wLocalCount = $("#wLocalCount");

var wStep = 0;
var wLocalImgs = [];
var wCoverChoice = null;
var wFetchedImages = [];

function wizardStepEls(){
  return Array.from($$(".wizardStep"));
}

function setWizardStep(n){
  var steps = wizardStepEls();
  wStep = Math.max(0, Math.min(n, steps.length-1));
  steps.forEach(function(s){ s.classList.remove("active"); });
  steps[wStep].classList.add("active");

  wizardDots.innerHTML = steps.map(function(_,i){
    return '<div class="dot ' + (i===wStep ? "active" : "") + '"></div>';
  }).join("");

  wPrev.style.visibility = (wStep === 0) ? "hidden" : "visible";
  wNext.textContent = (wStep === steps.length-1) ? "Crear" : "Siguiente";

  if(wStep === 4){
    // Al llegar al paso 5, buscar autom√°ticamente con el t√≠tulo
    var query = (wTitle.value || "").trim();
    if(query){
      wSearchQuery.value = query;
      triggerImageSearch(query);
    } else {
      // Mostrar aviso de API key si no est√° configurada
      checkApiKeyNotice();
    }
  }
}

function resetWizard(){
  wTitle.value = "";
  wCat.value = "Viajes";
  wCost.value = "";
  wDesc.value = "";
  wPlace.value = "";
  wLat.value = "";
  wLng.value = "";
  wImgUrl.value = "";
  wSearchQuery.value = "";
  wLocalImgs = [];
  wCoverChoice = null;
  wFetchedImages = [];
  wLocalCount.textContent = "0 seleccionadas";
  wLocalFiles.value = "";
  coverGrid.innerHTML = "";
  pexelsCredit.style.display = "none";
  pexelsApiNotice.style.display = "none";
  setWizardStep(0);
}

function checkApiKeyNotice(){
  var hasKey = PEXELS_API_KEY && PEXELS_API_KEY !== "TU_API_KEY_AQUI";
  pexelsApiNotice.style.display = hasKey ? "none" : "block";
}

function renderCoverLoading(){
  coverGrid.innerHTML = [0,1,2].map(function(){
    return '<div class="coverOpt loading">'
      + '<div class="coverSkeleton"></div>'
      + '<div class="cap">Buscando...</div>'
      + '</div>';
  }).join("");
  pexelsCredit.style.display = "none";
}

function renderCoverResults(photos, hasKey){
  wFetchedImages = photos;

  if(!wCoverChoice && photos.length){
    wCoverChoice = photos[0].url;
  }

  if(!photos.length){
    coverGrid.innerHTML = '<div class="smallNote" style="grid-column:1/-1">No se encontraron im√°genes. Prueba otra b√∫squeda o pega una URL.</div>';
    pexelsCredit.style.display = "none";
    return;
  }

  coverGrid.innerHTML = photos.map(function(img, idx){
    var isSelected = img.url === wCoverChoice;
    return '<div class="coverOpt ' + (isSelected ? "selected" : "") + '" data-cover-url="' + escapeHTML(img.url) + '">'
      + '<img src="' + escapeHTML(img.thumb) + '" alt="Portada ' + (idx+1) + '" loading="lazy">'
      + '<div class="cap">Opci√≥n ' + (idx+1) + '</div>'
      + '</div>';
  }).join("");

  pexelsCredit.style.display = hasKey ? "block" : "none";
}

async function triggerImageSearch(query){
  if(!query || !query.trim()) return;
  checkApiKeyNotice();
  renderCoverLoading();

  var result = await fetchPexelsImages(query.trim(), 3);
  wCoverChoice = null; // reset para elegir la primera del nuevo resultado
  renderCoverResults(result.photos, result.hasKey);
}

// Evento del bot√≥n buscar
wSearchBtn.addEventListener("click", function(){
  var q = wSearchQuery.value.trim();
  if(!q){ alert("Escribe algo para buscar üôÇ"); return; }
  triggerImageSearch(q);
});

// Buscar tambi√©n al pulsar Enter en el campo
wSearchQuery.addEventListener("keydown", function(e){
  if(e.key === "Enter"){
    e.preventDefault();
    var q = wSearchQuery.value.trim();
    if(q) triggerImageSearch(q);
  }
});

// Selecci√≥n de portada
document.addEventListener("click", function(e){
  var opt = e.target.closest(".coverOpt");
  if(!opt) return;
  var url = opt.dataset.coverUrl;
  if(!url) return;
  wCoverChoice = url;
  $$(".coverOpt").forEach(function(o){
    o.classList.toggle("selected", o.dataset.coverUrl === url);
  });
});

function openWizard(prefill){
  prefill = prefill || {};
  resetWizard();
  if(prefill.titulo) wTitle.value = prefill.titulo;
  if(prefill.cat) wCat.value = prefill.cat;
  wizardBack.classList.add("show");
}
function closeWizard(){ wizardBack.classList.remove("show"); }

wizardClose.addEventListener("click", closeWizard);
wizardBack.addEventListener("click", function(e){ if(e.target===wizardBack) closeWizard(); });

wPickLocalBtn.addEventListener("click", function(){ wLocalFiles.click(); });
wLocalFiles.addEventListener("change", async function(){
  if(!wLocalFiles.files || !wLocalFiles.files.length) return;
  try{
    var dataUrls = await filesToDataUrls(wLocalFiles.files);
    wLocalImgs.push.apply(wLocalImgs, dataUrls);
    wLocalCount.textContent = wLocalImgs.length + " seleccionadas";
  }catch(e){
    alert("No se han podido cargar una o m√°s fotos.");
  }finally{
    wLocalFiles.value = "";
  }
});

wPrev.addEventListener("click", function(){ setWizardStep(wStep-1); });

wNext.addEventListener("click", function(){
  var steps = wizardStepEls();
  var stepsCount = steps.length;

  if(wStep === 0){
    if(!wTitle.value.trim()){ alert("Ponga un t√≠tulo üôÇ"); return; }
    setWizardStep(wStep+1);
    return;
  }

  if(wStep < stepsCount-1){
    setWizardStep(wStep+1);
    return;
  }

  // CREAR OBJETIVO
  var titulo = wTitle.value.trim();
  var cat = wCat.value;
  var coste = Number(wCost.value || 0);
  var desc = wDesc.value.trim();
  var place = wPlace.value.trim();
  var latRaw = (wLat.value || "").trim();
  var lngRaw = (wLng.value || "").trim();
  var lat = latRaw === "" ? null : Number(latRaw);
  var lng = lngRaw === "" ? null : Number(lngRaw);

  if((lat !== null && !Number.isFinite(lat)) || (lng !== null && !Number.isFinite(lng))){
    alert("Lat/Lng deben ser n√∫meros v√°lidos (o d√©jelos vac√≠os).");
    return;
  }

  var imgs = [];

  // PRIORIDAD 1: foto local ‚Üí portada
  if(wLocalImgs.length){
    imgs.push(wLocalImgs[0]);
  } else {
    // PRIORIDAD 2: URL manual
    var manualUrl = (wImgUrl.value || "").trim();
    if(manualUrl){
      imgs.push(manualUrl);
    } else {
      // PRIORIDAD 3: portada de Pexels elegida
      if(wCoverChoice) imgs.push(wCoverChoice);
    }
  }

  // resto de fotos locales
  if(wLocalImgs.length > 1) imgs.push.apply(imgs, wLocalImgs.slice(1));

  // limpiar duplicados y vac√≠os
  imgs = Array.from(new Set(imgs)).filter(Boolean);

  if(!imgs.length){
    alert("A√±ada al menos una imagen: b√∫squeda, URL o foto del m√≥vil.");
    return;
  }

  var nextId = objetivos.reduce(function(m,o){ return Math.max(m, Number(o.id)||0); }, 0) + 1;

  objetivos.unshift({
    id: nextId,
    titulo: titulo,
    cat: cat,
    coste: coste,
    done: false,
    desc: desc,
    imgs: imgs,
    place: place,
    lat: lat,
    lng: lng
  });

  refreshEverywhere();
  closeWizard();
  showView("home");
  renderHome(currentCat);
});

$("#addWizardBtn").addEventListener("click", function(){ openWizard(); });

/* ================== START ================== */
$("#start").addEventListener("click", function(){
  screenOnboarding.classList.remove("active");
  screenApp.classList.add("active");
  renderHome("Todos");
  showView("home");
});

/* ================== INIT ================== */
renderHome("Todos");
showView("home");

</script>
</body>
</html>