<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>La Lista</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getAuth, onAuthStateChanged, signInWithEmailAndPassword,
      createUserWithEmailAndPassword, signInWithPopup, GoogleAuthProvider,
      sendPasswordResetEmail, signOut, updateProfile
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import {
      getFirestore, doc, getDoc, setDoc, updateDoc, deleteDoc,
      collection, getDocs, query, where, arrayUnion, arrayRemove
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBBS_h2F_gm8pYo4w3iM4Ac-ibr9DfcwLU",
      authDomain: "lalista-ed7d4.firebaseapp.com",
      projectId: "lalista-ed7d4",
      storageBucket: "lalista-ed7d4.firebasestorage.app",
      messagingSenderId: "842332318376",
      appId: "1:842332318376:web:cfa9cfe4b639ea3924709d",
      measurementId: "G-45QYFHG3VS"
    };

    const app  = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);
    const googleProvider = new GoogleAuthProvider();

    window._fbAuth        = auth;
    window._fbSignInEmail = (e,p) => signInWithEmailAndPassword(auth,e,p);
    window._fbRegister    = (e,p) => createUserWithEmailAndPassword(auth,e,p);
    window._fbGoogleLogin = ()    => signInWithPopup(auth, googleProvider);
    window._fbResetPassword = (e) => sendPasswordResetEmail(auth,e);
    window._fbSignOut     = ()    => signOut(auth);
    window._fbUpdateProfile = (d) => updateProfile(auth.currentUser, d);
    window._fbOnAuthStateChanged = (cb) => onAuthStateChanged(auth, cb);

    window._db = db;

    window._fsGetUser = async (uid) => {
      const snap = await getDoc(doc(db,"users",uid));
      return snap.exists() ? snap.data() : null;
    };

    window._fsSetUser = async (uid, data) => {
      await setDoc(doc(db,"users",uid), data, { merge: true });
    };

    window._fsSearchByCode = async (code) => {
      const q = query(collection(db,"users"), where("code","==",code.toUpperCase().trim()));
      const snap = await getDocs(q);
      if(snap.empty) return null;
      return { uid: snap.docs[0].id, ...snap.docs[0].data() };
    };

    window._fsGetUsersByUids = async (uids) => {
      if(!uids || !uids.length) return [];
      const results = [];
      for(const uid of uids){
        try{
          const snap = await getDoc(doc(db,"users",uid));
          if(snap.exists()) results.push({ uid: snap.id, ...snap.data() });
        }catch(e){}
      }
      return results;
    };

    window._fsFollow = async (myUid, targetUid) => {
      await updateDoc(doc(db,"users",myUid),   { following: arrayUnion(targetUid) });
      await updateDoc(doc(db,"users",targetUid), { followers: arrayUnion(myUid) });
    };

    window._fsUnfollow = async (myUid, targetUid) => {
      await updateDoc(doc(db,"users",myUid),   { following: arrayRemove(targetUid) });
      await updateDoc(doc(db,"users",targetUid), { followers: arrayRemove(myUid) });
    };

    window._fsGetPublicObjectives = async (uid) => {
      const snap = await getDocs(collection(db,"objectives",uid,"items"));
      return snap.docs.map(d=>({...d.data()})).filter(o => o.isPublic !== false);
    };

    window._fsSaveObjective = async (uid, obj) => {
      if(obj.isPublic !== false){
        // Strip data: URIs ‚Äî too large for Firestore
        const toSave = { ...obj };
        if(toSave.imgs) toSave.imgs = toSave.imgs.filter(s => !s.startsWith("data:"));
        if(!toSave.imgs || !toSave.imgs.length) return; // skip if no public imgs
        await setDoc(doc(db,"objectives",uid,"items",String(obj.id)), toSave);
      } else {
        try{ await deleteDoc(doc(db,"objectives",uid,"items",String(obj.id))); }catch(e){}
      }
    };

    window._fsDeleteObjective = async (uid, id) => {
      try{ await deleteDoc(doc(db,"objectives",uid,"items",String(id))); }catch(e){}
    };

    window.dispatchEvent(new Event("firebaseReady"));
  </script>

  <style>
    :root{
      --text:#f3f4f6;
      --muted:rgba(243,244,246,.72);
      --card:#ffffff;
      --ink:#0b1022;
      --inkMuted:rgba(11,16,34,.55);
      --pill:rgba(0,0,0,.06);
      --pillActive:rgba(0,0,0,.12);
      --navBg:#ffffff;
      --stroke:rgba(0,0,0,.10);
      --cta:#23c7b6;
      --cta2:#1aa99c;
      --shadow:0 18px 60px rgba(0,0,0,.22);
      --shadow2:0 14px 34px rgba(0,0,0,.12);
      --red:#ef4444;
    }

    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%}
    body{
      font-family:system-ui,-apple-system,Segoe UI,Roboto;
      background:#000;
      color:var(--text);
    }

    .frame{
      width:min(430px,100%);
      height:min(920px,100vh);
      margin:0 auto;
      border-radius:28px;
      overflow:hidden;
      position:relative;
      background:#000;
    }

    .screen{position:absolute;inset:0;display:none;overflow:auto;}
    .screen.active{display:block;}

    /* =============== ONBOARDING / AUTH SCREEN =============== */
    .onboarding{
      height:100%;padding:18px;
      display:flex;align-items:flex-end;justify-content:center;
      background:
        linear-gradient(180deg,rgba(0,0,0,.2),rgba(0,0,0,.85)),
        url("https://images.unsplash.com/photo-1507525428034-b723cf961d3e?auto=format&fit=crop&w=1400&q=60")
        center/cover no-repeat;
    }
    .obLogo{
      position:absolute;
      top:calc(env(safe-area-inset-top,0px) + 18px);
      left:0;right:0;text-align:center;
      font-weight:800;letter-spacing:.35em;font-size:28px;
      user-select:none;color:#fff;
    }
    .obHero{
      position:absolute;top:45%;left:18px;right:18px;
      transform:translateY(-50%);
    }
    .obTitle{font-size:40px;font-weight:850;line-height:1.05;color:#fff;}
    .obSubtitle{
      margin-top:22px;font-size:14px;line-height:1.55;
      color:var(--muted);text-align:center;max-width:36ch;margin-inline:auto;
    }
    .obButtons{
      width:100%;padding-bottom:calc(env(safe-area-inset-bottom,0px) + 6px);
      display:flex;flex-direction:column;gap:12px;
    }
    .btnEntrar{
      width:100%;border:none;border-radius:999px;padding:16px;
      font-size:16px;font-weight:750;background:#0000FF;color:#fff;cursor:pointer;
    }
    .btnEntrar:active{transform:translateY(1px)}
    .btnRegistrar{
      width:100%;border:1.5px solid rgba(255,255,255,.55);
      border-radius:999px;padding:15px;font-size:16px;font-weight:750;
      background:rgba(255,255,255,.12);color:#fff;cursor:pointer;
      backdrop-filter:blur(8px);
    }
    .btnRegistrar:active{transform:translateY(1px)}

    /* =============== AUTH POPUP MODAL =============== */
    .authModalBack{
      position:absolute;inset:0;background:rgba(0,0,0,.55);
      display:none;align-items:flex-end;justify-content:center;
      padding:14px;z-index:200;
      backdrop-filter:blur(4px);-webkit-backdrop-filter:blur(4px);
    }
    .authModalBack.show{display:flex;}
    .authCard{
      width:100%;background:#fff;border-radius:24px;
      padding:24px 20px 20px;box-shadow:var(--shadow);
      position:relative;max-height:92vh;overflow-y:auto;
    }
    .authModalClose{
      position:absolute;top:14px;right:14px;
      width:36px;height:36px;border-radius:50%;border:none;
      background:rgba(11,16,34,.07);cursor:pointer;font-size:16px;
      color:rgba(11,16,34,.55);display:flex;align-items:center;justify-content:center;
    }
    .authModalClose:active{background:rgba(11,16,34,.12);}
    .authTabs{
      display:flex;gap:0;background:rgba(11,16,34,.07);
      border-radius:14px;padding:4px;margin-bottom:22px;
    }
    .authTab{
      flex:1;border:none;background:transparent;
      padding:10px;border-radius:11px;font-size:14px;font-weight:800;
      color:rgba(11,16,34,.50);cursor:pointer;transition:all .18s ease;
    }
    .authTab.active{background:#fff;color:var(--ink);box-shadow:0 2px 12px rgba(0,0,0,.12);}
    .authForm{display:none;}
    .authForm.active{display:block;}
    .authField{margin-bottom:12px;}
    .authField label{display:block;font-size:12px;font-weight:800;color:rgba(11,16,34,.60);margin-bottom:6px;}
    .authField input{
      width:100%;border-radius:14px;border:1.5px solid rgba(11,16,34,.12);
      padding:13px 14px;font-size:15px;color:var(--ink);outline:none;
      transition:border-color .15s;background:#fff;
    }
    .authField input:focus{border-color:var(--cta);}
    .authError{
      display:none;background:rgba(239,68,68,.08);border:1px solid rgba(239,68,68,.25);
      border-radius:12px;padding:10px 12px;font-size:13px;font-weight:700;
      color:#b91c1c;margin-bottom:12px;
    }
    .authError.show{display:block;}
    .authSuccess{
      display:none;background:rgba(35,199,182,.08);border:1px solid rgba(35,199,182,.30);
      border-radius:12px;padding:10px 12px;font-size:13px;font-weight:700;
      color:#0a3a34;margin-bottom:12px;
    }
    .authSuccess.show{display:block;}
    .btnPrimary{
      width:100%;border:none;border-radius:14px;padding:15px;
      font-size:15px;font-weight:800;
      background:linear-gradient(180deg,#0b1022,#1a2340);
      color:#fff;cursor:pointer;margin-bottom:10px;transition:opacity .15s;
    }
    .btnPrimary:active{opacity:.85;}
    .btnPrimary:disabled{opacity:.55;cursor:not-allowed;}
    .btnGoogle{
      width:100%;border:1.5px solid rgba(11,16,34,.14);
      border-radius:14px;padding:14px;font-size:15px;font-weight:800;
      background:#fff;color:var(--ink);cursor:pointer;
      display:flex;align-items:center;justify-content:center;
      gap:10px;transition:background .15s;
    }
    .btnGoogle:active{background:#f5f5f5;}
    .btnGoogle svg{flex:0 0 20px;}
    .authDivider{display:flex;align-items:center;gap:10px;margin:14px 0;}
    .authDivider::before,.authDivider::after{content:"";flex:1;height:1px;background:rgba(11,16,34,.10);}
    .authDivider span{font-size:12px;font-weight:700;color:rgba(11,16,34,.40);}
    .forgotLink{
      display:block;text-align:right;font-size:12px;font-weight:700;
      color:rgba(11,16,34,.50);cursor:pointer;
      margin-top:-4px;margin-bottom:14px;background:none;border:none;padding:0;
    }
    .forgotLink:hover{color:var(--ink);}
    .authSpinner{
      display:none;position:absolute;inset:0;background:rgba(255,255,255,.70);
      border-radius:24px;align-items:center;justify-content:center;z-index:10;
    }
    .authSpinner.show{display:flex;}
    .spinner{
      width:32px;height:32px;border:3px solid rgba(11,16,34,.15);
      border-top-color:var(--cta);border-radius:50%;
      animation:spin .7s linear infinite;
    }
    @keyframes spin{to{transform:rotate(360deg)}}

    /* =============== APP SHELL =============== */
    .app{height:100%;background:#000;display:flex;}
    .appShell{
      flex:1;margin:14px;background:#f6f7fb;border-radius:22px;
      overflow:hidden;display:flex;flex-direction:column;
      box-shadow:var(--shadow);position:relative;
    }
    .topbar{
      padding:calc(env(safe-area-inset-top,0px) + 16px) 16px 12px;
      display:flex;justify-content:space-between;align-items:center;gap:12px;
      background:#f6f7fb;z-index:2;
    }
    .topbar h1{font-size:22px;color:var(--ink);font-weight:850;}
    .gear{
      width:40px;height:40px;border-radius:14px;border:1px solid var(--stroke);
      background:#fff;cursor:pointer;
    }
    .gear:active{transform:translateY(1px)}
    .tabs{
      display:flex;gap:10px;padding:0 16px 12px;background:#f6f7fb;z-index:2;
      overflow-x:auto;-webkit-overflow-scrolling:touch;scrollbar-width:none;
    }
    .tabs::-webkit-scrollbar{display:none;}
    .tab{
      padding:10px 14px;border-radius:999px;background:var(--pill);border:none;
      font-weight:750;font-size:13px;color:rgba(11,16,34,.75);cursor:pointer;
      white-space:nowrap;flex:0 0 auto;
    }
    .tab.active{background:var(--pillActive);color:var(--ink);}
    .viewToggleBtn{
      width:40px;height:40px;flex:0 0 auto;border-radius:14px;
      border:1px solid rgba(0,0,0,.10);background:#fff;cursor:pointer;font-size:16px;
      display:flex;align-items:center;justify-content:center;
      box-shadow:0 2px 8px rgba(0,0,0,.06);
    }
    .viewToggleBtn:active{transform:translateY(1px)}
    .listView{
      height:100%;overflow-y:auto;padding:6px 16px 92px;
      -webkit-overflow-scrolling:touch;display:none;
    }
    .listView.active{display:block;}
    .carousel.hidden{display:none;}
    .listObjCard{
      background:#fff;border-radius:16px;border:1px solid rgba(0,0,0,.06);
      box-shadow:0 4px 16px rgba(0,0,0,.08);display:flex;gap:0;overflow:hidden;
      cursor:pointer;margin-bottom:12px;transition:opacity .18s;
    }
    .listObjCard.done{opacity:.62;}
    .listObjImg{width:90px;flex:0 0 90px;background:center/cover no-repeat;}
    .listObjBody{flex:1;padding:12px;display:flex;flex-direction:column;justify-content:center;gap:4px;min-width:0;}
    .listObjTitle{font-size:14px;font-weight:850;color:var(--ink);line-height:1.2;}
    .listObjMeta{font-size:12px;color:var(--inkMuted);font-weight:650;}
    .listObjBadge{
      align-self:flex-start;font-size:10px;font-weight:850;
      padding:5px 8px;border-radius:999px;background:rgba(0,0,0,.06);
      color:rgba(11,16,34,.75);border:1px solid rgba(0,0,0,.06);white-space:nowrap;margin-top:4px;
    }
    .listObjBadge.done{background:rgba(0,0,255,.10);border-color:rgba(0,0,255,.20);color:#00008b;}
    .ideaTabs{display:flex;gap:10px;margin-bottom:12px;}
    .ideaTab{
      padding:10px 14px;border-radius:999px;background:var(--pill);border:none;
      font-weight:750;font-size:13px;color:rgba(11,16,34,.75);cursor:pointer;
    }
    .ideaTab.active{background:var(--pillActive);color:var(--ink);}
    .content{flex:1;overflow:hidden;background:#f6f7fb;}
    .carousel{
      height:100%;display:flex;gap:14px;overflow-x:auto;scroll-snap-type:x mandatory;
      -webkit-overflow-scrolling:touch;padding:6px 16px 92px;
    }
    .carousel::-webkit-scrollbar{display:none}
    .objCard{
      flex:0 0 calc(100% - 32px);height:100%;scroll-snap-align:start;
      background:var(--card);border-radius:20px;overflow:hidden;
      display:flex;flex-direction:column;box-shadow:var(--shadow2);
      border:1px solid rgba(0,0,0,.06);cursor:pointer;transition:opacity .18s ease;
    }
    .objCard.done{opacity:.62;}
    .objCard.done .objImg{filter:saturate(.85) contrast(.95);}
    .objCard.done .objTitle,.objCard.done .objMeta{color:rgba(11,16,34,.55);}
    .objImg{flex:1;background:center/cover no-repeat;}
    .objBody{padding:16px;display:flex;align-items:flex-start;justify-content:space-between;gap:12px;}
    .objTitle{font-size:16px;font-weight:850;color:var(--ink);line-height:1.15;}
    .objMeta{margin-top:6px;font-size:13px;color:var(--inkMuted);font-weight:650;}
    .badge{
      flex:0 0 auto;font-size:11px;font-weight:850;padding:8px 10px;border-radius:999px;
      background:rgba(0,0,0,.06);color:rgba(11,16,34,.75);
      border:1px solid rgba(0,0,0,.06);white-space:nowrap;
    }
    .badge.done{background:rgba(35,199,182,.18);border-color:rgba(35,199,182,.30);color:#0a3a34;}

    #map{height:100%;width:100%;position:relative;z-index:1;}
    .leaflet-container{background:#f6f7fb;}
    .leaflet-pane,.leaflet-map-pane{z-index:1 !important;}
    .leaflet-top,.leaflet-bottom{z-index:2 !important;}

    .profileWrap{height:100%;overflow:auto;padding:8px 16px 92px;-webkit-overflow-scrolling:touch;}
    .sectionTitle{margin:10px 2px 10px;font-size:14px;font-weight:900;color:rgba(11,16,34,.78);}
    .kpiGrid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px;}
    .kpi{background:#fff;border-radius:18px;border:1px solid rgba(0,0,0,.06);box-shadow:var(--shadow2);padding:14px;}
    .kpi .label{font-size:12px;color:rgba(11,16,34,.55);font-weight:800;}
    .kpi .value{margin-top:8px;font-size:22px;color:var(--ink);font-weight:950;letter-spacing:-.4px;}
    .kpi .sub{margin-top:6px;font-size:12px;color:rgba(11,16,34,.55);font-weight:700;}
    .userCard{
      background:#fff;border-radius:18px;border:1px solid rgba(0,0,0,.06);
      box-shadow:var(--shadow2);padding:16px;margin-bottom:12px;
      display:flex;align-items:center;gap:14px;cursor:pointer;
    }
    .userCard:active{opacity:.85;}
    .userAvatar{
      width:48px;height:48px;border-radius:50%;
      background:linear-gradient(135deg,#0000FF,#4444ff);
      display:flex;align-items:center;justify-content:center;
      font-size:20px;font-weight:900;color:#fff;flex:0 0 auto;overflow:hidden;
    }
    .userAvatar img{width:100%;height:100%;object-fit:cover;}
    .userName{font-size:14px;font-weight:900;color:var(--ink);}
    .userEmail{font-size:12px;color:rgba(11,16,34,.55);font-weight:700;margin-top:3px;}
    .btnSignOut{
      width:100%;border:1.5px solid rgba(185,28,28,.30);background:#fff;
      border-radius:14px;padding:13px;font-size:14px;font-weight:800;
      color:#b91c1c;cursor:pointer;margin-top:16px;
    }
    .btnSignOut:active{background:#fff5f5;}
    .list{background:#fff;border-radius:18px;border:1px solid rgba(0,0,0,.06);box-shadow:var(--shadow2);overflow:hidden;}
    .rowItem{
      display:flex;align-items:flex-start;justify-content:space-between;gap:10px;
      padding:14px;border-top:1px solid rgba(0,0,0,.06);
    }
    .rowItem:first-child{border-top:none}
    .rowLeft{min-width:0;}
    .rowItem strong{display:block;color:var(--ink);font-size:13px;line-height:1.2;}
    .rowItem small{display:block;margin-top:6px;color:rgba(11,16,34,.55);font-weight:700;font-size:12px;}
    .cost{font-weight:950;color:rgba(11,16,34,.78);font-size:13px;white-space:nowrap;}

    /* DETALLE */
    .detail{height:100%;background:#000;display:flex;padding:14px;}
    .detailShell{flex:1;border-radius:22px;overflow:hidden;box-shadow:var(--shadow);position:relative;background:#000;}
    .detailHero{position:absolute;inset:0;background:#000 center/cover no-repeat;cursor:pointer;}
    .detailOverlay{position:absolute;inset:0;background:linear-gradient(180deg,rgba(0,0,0,.15) 0%,rgba(0,0,0,.55) 55%,rgba(0,0,0,.90) 100%);}
    .detailTopBtns{
      position:absolute;top:calc(env(safe-area-inset-top,0px) + 14px);
      left:14px;right:14px;display:flex;justify-content:space-between;align-items:center;z-index:5;
    }
    .iconBtn{
      width:42px;height:42px;border-radius:14px;border:1px solid rgba(255,255,255,.22);
      background:rgba(255,255,255,.18);color:#fff;cursor:pointer;
      backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);
    }
    .iconBtn:active{transform:translateY(1px)}
    .detailThumbs{position:absolute;top:120px;right:14px;z-index:5;display:flex;flex-direction:column;gap:10px;}
    .thumb{
      width:54px;height:54px;border-radius:14px;border:2px solid rgba(255,255,255,.88);
      background:center/cover no-repeat;cursor:pointer;box-shadow:0 10px 25px rgba(0,0,0,.35);
    }
    .thumb.dim{border-color:rgba(255,255,255,.45);opacity:.9;}
    .detailTitleBlock{position:absolute;left:18px;right:88px;bottom:300px;z-index:5;color:#fff;}
    .detailTitleBlock h2{font-size:28px;font-weight:950;letter-spacing:-.4px;line-height:1.05;}
    .detailTitleBlock .subline{margin-top:10px;font-size:13px;color:rgba(255,255,255,.78);font-weight:700;}
    .sheet{
      position:absolute;left:0;right:0;bottom:0;background:#f6f7fb;
      border-radius:22px 22px 0 0;padding:14px 14px 18px;z-index:6;min-height:46%;
    }
    .chips{display:flex;gap:10px;flex-wrap:wrap;padding:4px 4px 10px;}
    .chip{
      display:flex;flex-direction:column;gap:2px;background:#fff;
      border:1px solid rgba(0,0,0,.06);box-shadow:var(--shadow2);
      border-radius:16px;padding:10px 12px;min-width:92px;
    }
    .chip .k{font-size:11px;color:rgba(11,16,34,.55);font-weight:900;}
    .chip .v{font-size:14px;color:var(--ink);font-weight:950;}
    .descTitle{padding:6px;font-size:14px;font-weight:950;color:rgba(11,16,34,.78);}
    .desc{padding:0 6px 12px;font-size:13px;line-height:1.55;color:rgba(11,16,34,.60);max-height:120px;overflow:auto;}
    .sheetBottom{
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      padding:6px;padding-bottom:calc(env(safe-area-inset-bottom,0px) + 8px);
    }
    .price{font-weight:950;color:var(--ink);font-size:22px;letter-spacing:-.4px;}
    .action{width:56px;height:56px;border-radius:18px;border:none;background:#0b1022;color:#fff;font-size:20px;cursor:pointer;box-shadow:var(--shadow2);}
    .action:active{transform:translateY(1px)}

    /* NAV */
    .nav{position:absolute;left:14px;right:14px;bottom:14px;pointer-events:none;}
    .navInner{
      pointer-events:auto;height:64px;background:var(--navBg);border-radius:18px;
      display:flex;justify-content:space-around;align-items:center;
      box-shadow:var(--shadow2);border:1px solid rgba(0,0,0,.08);
    }
    .navBtn{width:46px;height:46px;border-radius:16px;border:none;font-size:20px;background:transparent;color:rgba(11,16,34,.45);cursor:pointer;}
    .navBtn.active{background:#0b1022;color:#fff;}
    .navBtn:active{transform:translateY(1px)}

    /* MODALES */
    .modalBack{
      position:absolute;inset:0;background:rgba(0,0,0,.45);
      display:none;align-items:flex-end;justify-content:center;padding:14px;z-index:80;
    }
    .modalBack.show{display:flex;}
    .modal{width:100%;background:#fff;border-radius:20px;box-shadow:var(--shadow);border:1px solid rgba(0,0,0,.08);overflow:hidden;}
    .modalHead{display:flex;align-items:center;justify-content:space-between;padding:12px 12px 10px;border-bottom:1px solid rgba(0,0,0,.08);}
    .modalHead strong{color:var(--ink);font-size:14px;}
    .close{border:none;width:40px;height:40px;border-radius:14px;background:rgba(0,0,0,.06);cursor:pointer;color:var(--ink);font-size:18px;}
    .modalBody{padding:12px;max-height:min(72vh,600px);overflow:auto;-webkit-overflow-scrolling:touch;}
    .modalActions{display:flex;gap:10px;padding:12px;border-top:1px solid rgba(0,0,0,.08);}
    .primary,.ghost,.danger{flex:1;border-radius:14px;padding:12px;font-weight:900;border:1px solid rgba(0,0,0,.10);cursor:pointer;font-size:13px;}
    .ghost{background:#fff;color:var(--ink);}
    .primary{background:#0b1022;color:#fff;border-color:#0b1022;}
    .danger{background:#fff;color:#b91c1c;border-color:rgba(185,28,28,.35);}
    .miniList{display:grid;gap:10px;}
    .miniItem{
      background:#fff;border:1px solid rgba(0,0,0,.08);box-shadow:var(--shadow2);
      border-radius:16px;overflow:hidden;display:flex;gap:10px;cursor:pointer;transition:opacity .18s ease;
    }
    .miniItem.done{opacity:.62;}
    .miniImg{width:72px;height:72px;background:center/cover no-repeat;flex:0 0 auto;}
    .miniText{padding:10px 10px 10px 0;min-width:0;flex:1;}
    .miniText b{display:block;color:var(--ink);font-size:13px;line-height:1.2;}
    .miniText span{display:block;margin-top:6px;color:rgba(11,16,34,.55);font-weight:700;font-size:12px;}
    .tag{
      align-self:center;margin-right:10px;font-size:11px;font-weight:900;
      padding:7px 10px;border-radius:999px;background:rgba(0,0,0,.06);
      color:rgba(11,16,34,.75);border:1px solid rgba(0,0,0,.06);white-space:nowrap;
    }
    .tag.done{background:rgba(35,199,182,.18);border-color:rgba(35,199,182,.30);color:#0a3a34;}
    .form{display:grid;gap:10px;}
    .field label{display:block;font-size:12px;font-weight:900;color:rgba(11,16,34,.65);margin:2px 2px 6px;}
    .field input,.field select,.field textarea{width:100%;border-radius:14px;border:1px solid rgba(0,0,0,.10);padding:12px;font-size:14px;outline:none;}
    .field textarea{min-height:96px;resize:none;}
    .inline{display:flex;gap:10px;}
    .inline .field{flex:1;}
    .switchRow{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:10px 12px;border:1px solid rgba(0,0,0,.10);border-radius:14px;}
    .switchRow span{font-size:13px;color:rgba(11,16,34,.70);font-weight:900;}
    .smallNote{font-size:12px;color:rgba(11,16,34,.55);font-weight:700;padding:2px 2px 8px;}
    .fileRow{display:flex;gap:10px;align-items:center;flex-wrap:wrap;padding:10px 12px;border:1px solid rgba(0,0,0,.10);border-radius:14px;background:rgba(0,0,0,.02);}
    .fileRow button{border:none;border-radius:12px;padding:10px 12px;background:#0b1022;color:#fff;font-weight:900;cursor:pointer;font-size:12px;}
    .fileRow button:active{transform:translateY(1px)}
    .fileRow span{font-size:12px;font-weight:800;color:rgba(11,16,34,.65);}
    .hiddenInput{display:none}

    /* LIGHTBOX */
    .lightbox{position:absolute;inset:0;background:rgba(0,0,0,.92);display:none;z-index:120;padding:14px;}
    .lightbox.show{display:block;}
    .lbTop{display:flex;justify-content:space-between;align-items:center;padding-top:calc(env(safe-area-inset-top,0px) + 6px);margin-bottom:12px;}
    .lbBtn{width:42px;height:42px;border-radius:14px;border:1px solid rgba(255,255,255,.18);background:rgba(255,255,255,.10);color:#fff;cursor:pointer;backdrop-filter:blur(10px);}
    .lbBtn:active{transform:translateY(1px)}
    .lbCounter{color:rgba(255,255,255,.85);font-weight:900;font-size:13px;}
    .lbStage{height:calc(100% - 120px);display:flex;align-items:center;justify-content:center;user-select:none;touch-action:pan-y;}
    .lbImg{max-width:100%;max-height:100%;border-radius:18px;box-shadow:0 20px 70px rgba(0,0,0,.55);object-fit:contain;background:#111;}
    .lbNav{position:absolute;left:14px;right:14px;top:50%;transform:translateY(-50%);display:flex;justify-content:space-between;pointer-events:none;}
    .lbNav .lbBtn{pointer-events:auto;}
    .lbHint{position:absolute;left:14px;right:14px;bottom:calc(env(safe-area-inset-bottom,0px) + 18px);text-align:center;color:rgba(255,255,255,.6);font-size:12px;font-weight:800;}

    /* WIZARD */
    .wizardStep{display:none;}
    .wizardStep.active{display:block;}
    .wizardDots{display:flex;gap:8px;justify-content:center;margin:8px 0 10px;}
    .dot{width:8px;height:8px;border-radius:999px;background:rgba(11,16,34,.18);}
    .dot.active{background:rgba(11,16,34,.75);}

    /* MAPA */
    .mapTopBar{position:absolute;top:calc(env(safe-area-inset-top,0px) + 12px);left:12px;z-index:10;}
    .mapBackBtn{
      display:flex;align-items:center;gap:8px;background:#fff;border:none;border-radius:14px;
      padding:10px 14px;font-size:13px;font-weight:800;color:var(--ink);cursor:pointer;
      box-shadow:0 4px 16px rgba(0,0,0,.18);
    }
    .mapBackBtn:active{transform:translateY(1px);}

    /* SOCIAL */
    .socialGrid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px;}
    .socialCard{
      background:#fff;border-radius:18px;border:1px solid rgba(0,0,0,.06);
      box-shadow:var(--shadow2);padding:14px;text-align:center;cursor:pointer;
    }
    .socialCard:active{transform:translateY(1px);}
    .socialCard .sNum{font-size:26px;font-weight:950;color:#0000FF;letter-spacing:-.5px;}
    .socialCard .sLbl{font-size:12px;color:rgba(11,16,34,.55);font-weight:800;margin-top:4px;}

    /* Perfil edit avatar */
    .profileEditAvatar{
      width:80px;height:80px;border-radius:50%;
      background:linear-gradient(135deg,#0000FF,#4444ff);
      display:flex;align-items:center;justify-content:center;
      font-size:32px;font-weight:900;color:#fff;
      margin:0 auto 16px;overflow:hidden;cursor:pointer;position:relative;
      border:3px solid rgba(0,0,255,.2);
    }
    .profileEditAvatar img{width:100%;height:100%;object-fit:cover;}
    .profileEditAvatar .avatarOverlay{
      position:absolute;inset:0;background:rgba(0,0,0,.38);
      display:flex;align-items:center;justify-content:center;
      border-radius:50%;opacity:0;transition:opacity .15s;font-size:22px;
    }
    .profileEditAvatar:hover .avatarOverlay{opacity:1;}
    .userHandle{font-size:13px;color:#0000FF;font-weight:800;text-align:center;margin-bottom:16px;letter-spacing:.02em;}

    /* Comunidad */
    .communityFeed{height:100%;overflow-y:auto;padding:6px 16px 92px;-webkit-overflow-scrolling:touch;}
    .feedCard{
      background:#fff;border-radius:16px;border:1px solid rgba(0,0,0,.06);
      box-shadow:0 4px 16px rgba(0,0,0,.08);overflow:hidden;margin-bottom:14px;
    }
    .feedCardHero{height:160px;background:center/cover no-repeat;}
    .feedCardBody{padding:12px;}
    .feedCardAuthor{display:flex;align-items:center;gap:8px;margin-bottom:8px;cursor:pointer;}
    .feedCardAuthor:hover .feedAuthorName{color:#0000FF;}
    .feedAvatar{
      width:28px;height:28px;border-radius:50%;
      background:linear-gradient(135deg,#0000FF,#4444ff);
      display:flex;align-items:center;justify-content:center;
      font-size:11px;font-weight:900;color:#fff;flex:0 0 auto;overflow:hidden;
    }
    .feedAvatar img{width:100%;height:100%;object-fit:cover;}
    .feedAuthorName{font-size:12px;font-weight:800;color:rgba(11,16,34,.55);transition:color .15s;}
    .feedTitle{font-size:15px;font-weight:850;color:var(--ink);line-height:1.2;}
    .feedMeta{font-size:12px;color:var(--inkMuted);font-weight:650;margin-top:4px;}

    /* Buscar usuarios */
    .searchUserInput{
      width:100%;border-radius:14px;border:1.5px solid rgba(11,16,34,.12);
      padding:13px 14px;font-size:15px;color:var(--ink);outline:none;
      transition:border-color .15s;margin-bottom:14px;
    }
    .searchUserInput:focus{border-color:#0000FF;}
    .userResult{display:flex;align-items:center;gap:12px;padding:12px;border-radius:14px;background:#f6f7fb;margin-bottom:8px;}
    .userResultAvatar{
      width:40px;height:40px;border-radius:50%;
      background:linear-gradient(135deg,#0000FF,#4444ff);
      display:flex;align-items:center;justify-content:center;
      font-size:16px;font-weight:900;color:#fff;flex:0 0 auto;overflow:hidden;
    }
    .userResultAvatar img{width:100%;height:100%;object-fit:cover;}
    .userResultInfo{flex:1;min-width:0;cursor:pointer;}
    .userResultName{font-size:13px;font-weight:900;color:var(--ink);}
    .userResultHandle{font-size:11px;color:#0000FF;font-weight:800;margin-top:2px;}
    .btnFollow{
      border:none;border-radius:12px;padding:9px 14px;
      font-size:12px;font-weight:800;cursor:pointer;
      background:#0000FF;color:#fff;flex:0 0 auto;
    }
    .btnFollow.following{background:#f6f7fb;color:rgba(11,16,34,.65);border:1px solid rgba(0,0,0,.12);}
    .btnFollow:active{transform:translateY(1px);}
    .myCode{
      background:rgba(0,0,255,.06);border:1px solid rgba(0,0,255,.15);
      border-radius:14px;padding:12px 14px;margin-bottom:14px;
      font-size:13px;color:var(--ink);font-weight:700;
    }
    .myCode strong{color:#0000FF;font-size:15px;letter-spacing:.04em;}
    .copyCodeBtn{
      display:inline-block;margin-top:6px;background:none;border:none;
      cursor:pointer;font-size:11px;font-weight:800;color:#0000FF;padding:0;
    }
    .btn{width:100%;border:none;border-radius:999px;padding:16px;font-size:16px;font-weight:750;background:#0000FF;color:#fff;cursor:pointer;}
    .btn:active{transform:translateY(1px)}

    /* ===== MODAL PERFIL DE OTRO USUARIO ===== */
    .userProfileBack{
      position:absolute;inset:0;background:rgba(0,0,0,.55);
      display:none;align-items:flex-end;justify-content:center;
      padding:14px;z-index:90;
      backdrop-filter:blur(4px);-webkit-backdrop-filter:blur(4px);
    }
    .userProfileBack.show{display:flex;}
    .userProfileCard{
      width:100%;background:#fff;border-radius:24px;
      padding:0 0 0;box-shadow:var(--shadow);
      max-height:88vh;overflow-y:auto;
    }
    .userProfileHeader{
      padding:22px 20px 16px;
      border-bottom:1px solid rgba(0,0,0,.08);
      display:flex;justify-content:space-between;align-items:flex-start;
    }
    .userProfileHeaderInfo{display:flex;align-items:center;gap:14px;}
    .userProfileBigAvatar{
      width:64px;height:64px;border-radius:50%;
      background:linear-gradient(135deg,#0000FF,#4444ff);
      display:flex;align-items:center;justify-content:center;
      font-size:26px;font-weight:900;color:#fff;flex:0 0 auto;overflow:hidden;
      border:3px solid rgba(0,0,255,.15);
    }
    .userProfileBigAvatar img{width:100%;height:100%;object-fit:cover;}
    .userProfileName{font-size:17px;font-weight:900;color:var(--ink);}
    .userProfileHandle{font-size:12px;color:#0000FF;font-weight:800;margin-top:3px;}
    .userProfileClose{
      border:none;width:36px;height:36px;border-radius:50%;
      background:rgba(0,0,0,.06);cursor:pointer;font-size:16px;color:var(--ink);
      flex:0 0 auto;
    }
    .userProfileStatsRow{
      display:flex;gap:0;padding:12px 20px;border-bottom:1px solid rgba(0,0,0,.06);
    }
    .userProfileStat{flex:1;text-align:center;}
    .userProfileStat .statNum{font-size:20px;font-weight:950;color:#0000FF;letter-spacing:-.4px;}
    .userProfileStat .statLbl{font-size:11px;color:rgba(11,16,34,.55);font-weight:800;margin-top:3px;}
    .userProfileActions{padding:12px 20px;display:flex;gap:10px;border-bottom:1px solid rgba(0,0,0,.06);}
    .btnFollowFull{
      flex:1;border:none;border-radius:14px;padding:12px;
      font-size:14px;font-weight:800;cursor:pointer;background:#0000FF;color:#fff;
    }
    .btnFollowFull.following{background:#f6f7fb;color:rgba(11,16,34,.65);border:1px solid rgba(0,0,0,.12);}
    .btnFollowFull:active{opacity:.85;}
    .userProfileObjsTitle{padding:12px 20px 6px;font-size:13px;font-weight:900;color:rgba(11,16,34,.78);}
    .userProfileObjsList{padding:0 12px 12px;display:grid;gap:10px;}
    .userObjMini{
      background:#f6f7fb;border-radius:14px;display:flex;gap:0;overflow:hidden;
      border:1px solid rgba(0,0,0,.06);
    }
    .userObjMiniImg{width:64px;height:64px;background:center/cover no-repeat;flex:0 0 auto;}
    .userObjMiniBody{padding:10px;flex:1;min-width:0;}
    .userObjMiniTitle{font-size:13px;font-weight:850;color:var(--ink);line-height:1.2;}
    .userObjMiniMeta{font-size:11px;color:rgba(11,16,34,.55);font-weight:700;margin-top:4px;}

    /* Spinner inline */
    .miniSpinner{
      display:flex;align-items:center;justify-content:center;padding:24px;
    }
    .miniSpinner::after{
      content:"";width:24px;height:24px;border:3px solid rgba(11,16,34,.12);
      border-top-color:#0000FF;border-radius:50%;animation:spin .7s linear infinite;
    }
  </style>
</head>

<body>
<div class="frame">

  <!-- LIGHTBOX -->
  <div class="lightbox" id="lightbox">
    <div class="lbTop">
      <button class="lbBtn" id="lbClose">‚úï</button>
      <div class="lbCounter" id="lbCounter">1/1</div>
      <div style="width:42px;height:42px;"></div>
    </div>
    <div class="lbStage" id="lbStage">
      <img class="lbImg" id="lbImg" alt="Foto" />
    </div>
    <div class="lbNav">
      <button class="lbBtn" id="lbPrev">‚Äπ</button>
      <button class="lbBtn" id="lbNext">‚Ä∫</button>
    </div>
    <div class="lbHint">Deslice ‚óÄ ‚ñ∂ para cambiar ¬∑ toque fuera para cerrar</div>
  </div>

  <!-- =============== PANTALLA ONBOARDING + AUTH =============== -->
  <div class="screen active" id="screen-auth">
    <section class="onboarding">
      <div class="obLogo">LA LISTA</div>
      <div class="obHero">
        <div class="obTitle">Tus objetivos.<br>Tu historia.</div>
        <div class="obSubtitle">
          Hola. Bienvenido a <b>La Lista</b>.<br>
          Aqu√≠ guardas lo que quieres hacer, vivir y cumplir,
          para no perder el foco en lo que de verdad importa.
          No es una app m√°s. Es un recordatorio.
        </div>
      </div>
      <div class="obButtons">
        <button class="btnEntrar" id="openLoginBtn">Entrar ‚Üí</button>
        <button class="btnRegistrar" id="openRegisterBtn">Crear una cuenta</button>
      </div>
    </section>

    <!-- POPUP AUTH MODAL -->
    <div class="authModalBack" id="authModalBack">
      <div class="authCard">
        <button class="authModalClose" id="authModalClose">‚úï</button>
        <div class="authSpinner" id="authSpinner"><div class="spinner"></div></div>
        <div class="authTabs">
          <button class="authTab active" id="tabLogin">Entrar</button>
          <button class="authTab" id="tabRegister">Registrarse</button>
        </div>

        <!-- FORM LOGIN -->
        <div class="authForm active" id="formLogin">
          <div class="authError" id="loginError"></div>
          <div class="authField">
            <label>Correo electr√≥nico</label>
            <input id="loginEmail" type="email" placeholder="tu@correo.com" autocomplete="email" />
          </div>
          <div class="authField">
            <label>Contrase√±a</label>
            <input id="loginPass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password" />
          </div>
          <button class="forgotLink" id="forgotBtn">¬øOlvidaste tu contrase√±a?</button>
          <button class="btnPrimary" id="loginBtn">Entrar ‚Üí</button>
          <div class="authDivider"><span>o contin√∫a con</span></div>
          <button class="btnGoogle" id="loginGoogleBtn">
            <svg viewBox="0 0 48 48"><path fill="#FFC107" d="M43.6 20H24v8h11.3C33.7 33.6 29.3 36 24 36c-6.6 0-12-5.4-12-12s5.4-12 12-12c3 0 5.7 1.1 7.8 2.9l6-6C34.5 6.4 29.5 4 24 4 12.9 4 4 12.9 4 24s8.9 20 20 20c11 0 19.7-8 19.7-20 0-1.3-.1-2.7-.1-4z"/><path fill="#FF3D00" d="M6.3 14.7l6.9 5.1C15 16 19.2 13 24 13c3 0 5.7 1.1 7.8 2.9l6-6C34.5 6.4 29.5 4 24 4 16.3 4 9.7 8.4 6.3 14.7z"/><path fill="#4CAF50" d="M24 44c5.2 0 9.9-1.9 13.5-5l-6.2-5.2C29.4 35.6 26.8 36.5 24 36.5c-5.2 0-9.6-3.4-11.2-8l-6.9 5.3C9.6 39.5 16.3 44 24 44z"/><path fill="#1976D2" d="M43.6 20H24v8h11.3c-.8 2.3-2.3 4.3-4.3 5.8l6.2 5.2c3.6-3.4 5.8-8.4 5.8-13.9 0-1.3-.1-2.7-.1-4-.1 0 0-.1 0-.1z"/></svg>
            Continuar con Google
          </button>
        </div>

        <!-- FORM REGISTRO -->
        <div class="authForm" id="formRegister">
          <div class="authError" id="registerError"></div>
          <div class="authSuccess" id="registerSuccess"></div>
          <div class="authField">
            <label>Nombre</label>
            <input id="registerName" type="text" placeholder="Tu nombre" autocomplete="name" />
          </div>
          <div class="authField">
            <label>Correo electr√≥nico</label>
            <input id="registerEmail" type="email" placeholder="tu@correo.com" autocomplete="email" />
          </div>
          <div class="authField">
            <label>Contrase√±a (m√≠n. 6 caracteres)</label>
            <input id="registerPass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="new-password" />
          </div>
          <button class="btnPrimary" id="registerBtn">Crear cuenta ‚Üí</button>
          <div class="authDivider"><span>o contin√∫a con</span></div>
          <button class="btnGoogle" id="registerGoogleBtn">
            <svg viewBox="0 0 48 48"><path fill="#FFC107" d="M43.6 20H24v8h11.3C33.7 33.6 29.3 36 24 36c-6.6 0-12-5.4-12-12s5.4-12 12-12c3 0 5.7 1.1 7.8 2.9l6-6C34.5 6.4 29.5 4 24 4 12.9 4 4 12.9 4 24s8.9 20 20 20c11 0 19.7-8 19.7-20 0-1.3-.1-2.7-.1-4z"/><path fill="#FF3D00" d="M6.3 14.7l6.9 5.1C15 16 19.2 13 24 13c3 0 5.7 1.1 7.8 2.9l6-6C34.5 6.4 29.5 4 24 4 16.3 4 9.7 8.4 6.3 14.7z"/><path fill="#4CAF50" d="M24 44c5.2 0 9.9-1.9 13.5-5l-6.2-5.2C29.4 35.6 26.8 36.5 24 36.5c-5.2 0-9.6-3.4-11.2-8l-6.9 5.3C9.6 39.5 16.3 44 24 44z"/><path fill="#1976D2" d="M43.6 20H24v8h11.3c-.8 2.3-2.3 4.3-4.3 5.8l6.2 5.2c3.6-3.4 5.8-8.4 5.8-13.9 0-1.3-.1-2.7-.1-4-.1 0 0-.1 0-.1z"/></svg>
            Continuar con Google
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- =============== APP =============== -->
  <div class="screen" id="screen-app">
    <section class="app">
      <div class="appShell">

        <div class="topbar">
          <h1 id="pageTitle">Mis objetivos</h1>
          <div style="display:flex;gap:8px;">
            <button class="gear" id="searchBtn">üîç</button>
            <button class="gear" id="gearBtn">‚öôÔ∏è</button>
          </div>
        </div>

        <div id="homeHeader">
          <div class="tabs">
            <button class="tab active" data-cat="Todos">Todos</button>
            <button class="tab" data-cat="Viajes">Viajes</button>
            <button class="tab" data-cat="Experiencias">Experiencias</button>
            <button class="tab" data-cat="Familia">Familia</button>
            <button class="tab" data-cat="Trabajo">Trabajo</button>
            <button class="tab" data-cat="Comunidad">üë• Comunidad</button>
          </div>
          <div id="homeActionsBar" style="padding:0 16px 12px;display:flex;gap:10px;align-items:center;">
            <button class="btn" id="addWizardBtn" style="flex:1;">A√±adir objetivo</button>
            <button class="viewToggleBtn" id="viewToggleBtn" title="Cambiar vista">‚ò∞</button>
          </div>
        </div>

        <div class="content" id="view-home">
          <div class="carousel" id="carousel"></div>
          <div class="listView" id="listViewContainer"></div>
          <div class="communityFeed" id="communityFeed" style="display:none;"></div>
        </div>
        <div class="content" id="view-compass" style="display:none;">
          <div style="position:relative;height:100%;">
            <div id="map"></div>
            <div class="mapTopBar">
              <button class="mapBackBtn" id="mapBackBtn">‚Üê Inicio</button>
            </div>
          </div>
        </div>
        <div class="content" id="view-profile" style="display:none;">
          <div class="profileWrap">
            <div class="userCard" id="userCard">
              <div class="userAvatar" id="userAvatar">?</div>
              <div style="flex:1;">
                <div class="userName" id="userName">‚Äî</div>
                <div class="userEmail" id="userEmail">‚Äî</div>
                <div style="font-size:11px;color:#0000FF;font-weight:800;margin-top:2px;" id="userHandleDisplay"></div>
              </div>
              <div style="font-size:18px;color:rgba(11,16,34,.30);">‚úèÔ∏è</div>
            </div>

            <div class="socialGrid">
              <div class="socialCard" id="followersCard">
                <div class="sNum" id="followersCount">0</div>
                <div class="sLbl">Seguidores</div>
              </div>
              <div class="socialCard" id="followingCard">
                <div class="sNum" id="followingCount">0</div>
                <div class="sLbl">Siguiendo</div>
              </div>
            </div>

            <div class="sectionTitle">Resumen</div>
            <div class="kpiGrid">
              <div class="kpi"><div class="label">Pendientes</div><div class="value" id="kpiPend">0</div><div class="sub">Por cumplir</div></div>
              <div class="kpi"><div class="label">Cumplidos</div><div class="value" id="kpiDone">0</div><div class="sub">Completados</div></div>
              <div class="kpi"><div class="label">Coste total</div><div class="value" id="kpiCostTotal">0‚Ç¨</div><div class="sub">Suma de todos</div></div>
              <div class="kpi"><div class="label">Coste pendiente</div><div class="value" id="kpiCostPend">0‚Ç¨</div><div class="sub">Lo que queda</div></div>
            </div>
            <div class="sectionTitle">Pendientes</div>
            <div class="list" id="listPend"></div>
            <div class="sectionTitle" style="margin-top:14px;">Cumplidos</div>
            <div class="list" id="listDone"></div>
            <button class="btnSignOut" id="signOutBtn">Cerrar sesi√≥n</button>
          </div>
        </div>

        <!-- AJUSTES MODAL -->
        <div class="modalBack" id="settingsBack">
          <div class="modal">
            <div class="modalHead">
              <strong>Ajustes ¬∑ Objetivos</strong>
              <button class="close" id="settingsClose">‚úï</button>
            </div>
            <div class="modalBody">
              <div id="settingsListView">
                <div class="smallNote">Toque un objetivo para editarlo.</div>
                <div class="miniList" id="settingsList"></div>
              </div>
              <div id="settingsFormView" style="display:none;">
                <div class="smallNote" id="formModeNote">Editar objetivo</div>
                <form class="form" id="objForm" onsubmit="return false;">
                  <div class="field"><label>T√≠tulo</label><input id="fTitle" type="text" placeholder="Ej: Ver auroras boreales" /></div>
                  <div class="inline">
                    <div class="field"><label>Categor√≠a</label><select id="fCat"><option>Viajes</option><option>Experiencias</option><option>Familia</option><option>Trabajo</option></select></div>
                    <div class="field"><label>Coste (‚Ç¨)</label><input id="fCost" type="number" min="0" step="1" placeholder="0" /></div>
                  </div>
                  <div class="switchRow"><span>¬øCumplido?</span><input id="fDone" type="checkbox" /></div>
                  <div class="switchRow"><span>üåç Objetivo p√∫blico (visible para seguidores)</span><input id="fPublic" type="checkbox" checked /></div>
                  <div class="field"><label>Descripci√≥n</label><textarea id="fDesc" placeholder="Escriba el por qu√©‚Ä¶"></textarea></div>
                  <div class="field"><label>Imagen principal (URL)</label><input id="fImg0" type="url" placeholder="https://‚Ä¶" /></div>
                  <div class="inline">
                    <div class="field"><label>Miniatura 1 (URL)</label><input id="fImg1" type="url" placeholder="https://‚Ä¶" /></div>
                    <div class="field"><label>Miniatura 2 (URL)</label><input id="fImg2" type="url" placeholder="https://‚Ä¶" /></div>
                  </div>
                  <div class="field"><label>Miniatura 3 (URL)</label><input id="fImg3" type="url" placeholder="https://‚Ä¶" /></div>
                  <div class="field">
                    <label>Fotos del m√≥vil (la primera ser√° portada)</label>
                    <div class="fileRow"><button type="button" id="pickLocalBtn">A√±adir fotos</button><span id="localCount">0 seleccionadas</span></div>
                    <input class="hiddenInput" id="localFiles" type="file" accept="image/*" multiple />
                  </div>
                  <div class="field"><label>Lugar</label><input id="fPlace" type="text" placeholder="Ej: Troms√∏, Noruega" /></div>
                  <div class="inline">
                    <div class="field"><label>Latitud</label><input id="fLat" type="number" step="0.000001" placeholder="69.6492" /></div>
                    <div class="field"><label>Longitud</label><input id="fLng" type="number" step="0.000001" placeholder="18.9553" /></div>
                  </div>
                  <div class="smallNote">Sin lat/lng no aparece en el mapa.</div>
                </form>
              </div>
            </div>
            <div class="modalActions" id="settingsActionsList">
              <button class="ghost" id="btnAdd">A√±adir</button>
              <button class="primary" id="btnCloseList">Cerrar</button>
            </div>
            <div class="modalActions" id="settingsActionsForm" style="display:none;">
              <button class="danger" id="btnDelete">Borrar</button>
              <button class="ghost" id="btnBackToList">Volver</button>
              <button class="primary" id="btnSave">Guardar</button>
            </div>
          </div>
        </div>

        <!-- IDEAS MODAL -->
        <div class="modalBack" id="ideasBack">
          <div class="modal">
            <div class="modalHead"><strong>Explorar ideas</strong><button class="close" id="ideasClose">‚úï</button></div>
            <div class="modalBody">
              <div class="ideaTabs">
                <button class="ideaTab active" data-idea-cat="Viajes">Viajes</button>
                <button class="ideaTab" data-idea-cat="Familia">Familia</button>
                <button class="ideaTab" data-idea-cat="Trabajo">Trabajo</button>
              </div>
              <div class="smallNote">Toque "A√±adir" para a√±adirlo paso a paso.</div>
              <div class="miniList" id="ideasList"></div>
            </div>
            <div class="modalActions"><button class="primary" id="ideasClose2">Cerrar</button></div>
          </div>
        </div>

        <!-- WIZARD MODAL -->
        <div class="modalBack" id="wizardBack">
          <div class="modal">
            <div class="modalHead"><strong>Nuevo objetivo</strong><button class="close" id="wizardClose">‚úï</button></div>
            <div class="modalBody">
              <div class="wizardDots" id="wizardDots"></div>
              <div class="wizardStep active" data-step="0">
                <div class="smallNote">Paso 1 ¬∑ T√≠tulo</div>
                <div class="field"><label>T√≠tulo</label><input id="wTitle" type="text" placeholder="Ej: Dormir en un igl√∫" /></div>
              </div>
              <div class="wizardStep" data-step="1">
                <div class="smallNote">Paso 2 ¬∑ Categor√≠a + Coste</div>
                <div class="field"><label>Categor√≠a</label><select id="wCat"><option>Viajes</option><option>Experiencias</option><option>Familia</option><option>Trabajo</option></select></div>
                <div class="field"><label>Coste (‚Ç¨)</label><input id="wCost" type="number" min="0" step="1" placeholder="0" /></div>
              </div>
              <div class="wizardStep" data-step="2">
                <div class="smallNote">Paso 3 ¬∑ Descripci√≥n</div>
                <div class="field"><label>Descripci√≥n</label><textarea id="wDesc" placeholder="¬øPor qu√© lo quieres hacer?"></textarea></div>
              </div>
              <div class="wizardStep" data-step="3">
                <div class="smallNote">Paso 4 ¬∑ Lugar + Coordenadas (opcional)</div>
                <div class="field"><label>Lugar</label><input id="wPlace" type="text" placeholder="Ej: Troms√∏, Noruega" /></div>
                <div class="inline">
                  <div class="field"><label>Lat</label><input id="wLat" type="number" step="0.000001" placeholder="69.6492" /></div>
                  <div class="field"><label>Lng</label><input id="wLng" type="number" step="0.000001" placeholder="18.9553" /></div>
                </div>
              </div>
              <div class="wizardStep" data-step="4">
                <div class="smallNote">Paso 5 ¬∑ Visibilidad</div>
                <div class="switchRow" style="margin-bottom:12px;"><span>üåç Objetivo p√∫blico (lo ver√°n tus seguidores)</span><input id="wPublic" type="checkbox" checked /></div>
                <div class="smallNote">Los objetivos privados solo los ves t√∫.</div>
              </div>
              <div class="wizardStep" data-step="5">
                <div class="smallNote">Paso 6 ¬∑ Foto de portada</div>
                <div class="field">
                  <label>URL de imagen</label>
                  <input id="wImgUrl" type="url" placeholder="https://‚Ä¶" />
                </div>
                <div class="field">
                  <label>O sube fotos del m√≥vil (la primera ser√° portada)</label>
                  <div class="fileRow"><button type="button" id="wPickLocalBtn">A√±adir fotos</button><span id="wLocalCount">0 seleccionadas</span></div>
                  <input class="hiddenInput" id="wLocalFiles" type="file" accept="image/*" multiple />
                </div>
              </div>
            </div>
            <div class="modalActions">
              <button class="ghost" id="wPrev">Atr√°s</button>
              <button class="primary" id="wNext">Siguiente</button>
            </div>
          </div>
        </div>

        <!-- PERFIL EDIT MODAL -->
        <div class="modalBack" id="profileEditBack">
          <div class="modal">
            <div class="modalHead"><strong>Mi perfil</strong><button class="close" id="profileEditClose">‚úï</button></div>
            <div class="modalBody">
              <div class="profileEditAvatar" id="peAvatar">
                <span id="peAvatarInitial">?</span>
                <div class="avatarOverlay">üì∑</div>
              </div>
              <input class="hiddenInput" id="peAvatarFile" type="file" accept="image/*" />
              <div class="userHandle" id="peCodeDisplay"></div>
              <div class="myCode">
                <div style="font-size:11px;font-weight:800;color:rgba(11,16,34,.55);margin-bottom:4px;">TU C√ìDIGO ¬∑ Comp√°rtelo para que te encuentren</div>
                <strong id="peCodeValue">‚Äî</strong><br>
                <button class="copyCodeBtn" id="copyCodeBtn">üìã Copiar c√≥digo</button>
              </div>
              <div class="form">
                <div class="field">
                  <label>Nombre de usuario</label>
                  <input id="peUsername" type="text" placeholder="@tunombre (sin espacios)" />
                </div>
                <div class="field">
                  <label>Correo electr√≥nico</label>
                  <input id="peEmail" type="email" disabled style="opacity:.6;" />
                </div>
              </div>
            </div>
            <div class="modalActions">
              <button class="ghost" id="profileEditCancel">Cancelar</button>
              <button class="primary" id="profileEditSave">Guardar</button>
            </div>
          </div>
        </div>

        <!-- BUSCAR USUARIOS MODAL -->
        <div class="modalBack" id="searchUsersBack">
          <div class="modal">
            <div class="modalHead"><strong>Buscar usuarios</strong><button class="close" id="searchUsersClose">‚úï</button></div>
            <div class="modalBody">
              <div class="smallNote">Pega el c√≥digo de otro usuario para encontrarlo y seguirle.</div>
              <input class="searchUserInput" id="searchUserInput" type="text" placeholder="Ej: ABC123XY" />
              <div id="searchUserResults"></div>
            </div>
            <div class="modalActions"><button class="primary" id="searchUsersClose2">Cerrar</button></div>
          </div>
        </div>

        <!-- LISTA SEGUIDORES/SIGUIENDO MODAL -->
        <div class="modalBack" id="socialListBack">
          <div class="modal">
            <div class="modalHead"><strong id="socialListTitle">Seguidores</strong><button class="close" id="socialListClose">‚úï</button></div>
            <div class="modalBody">
              <div id="socialListContent"></div>
            </div>
            <div class="modalActions"><button class="primary" id="socialListClose2">Cerrar</button></div>
          </div>
        </div>

        <!-- PERFIL DE OTRO USUARIO MODAL -->
        <div class="userProfileBack" id="userProfileBack">
          <div class="userProfileCard">
            <div class="userProfileHeader">
              <div class="userProfileHeaderInfo">
                <div class="userProfileBigAvatar" id="upAvatar">?</div>
                <div>
                  <div class="userProfileName" id="upName">‚Äî</div>
                  <div class="userProfileHandle" id="upHandle">‚Äî</div>
                </div>
              </div>
              <button class="userProfileClose" id="userProfileClose">‚úï</button>
            </div>
            <div class="userProfileStatsRow">
              <div class="userProfileStat">
                <div class="statNum" id="upFollowers">0</div>
                <div class="statLbl">Seguidores</div>
              </div>
              <div class="userProfileStat">
                <div class="statNum" id="upFollowing">0</div>
                <div class="statLbl">Siguiendo</div>
              </div>
              <div class="userProfileStat">
                <div class="statNum" id="upObjCount">0</div>
                <div class="statLbl">Objetivos</div>
              </div>
            </div>
            <div class="userProfileActions">
              <button class="btnFollowFull" id="upFollowBtn">Seguir</button>
            </div>
            <div class="userProfileObjsTitle">Objetivos p√∫blicos</div>
            <div class="userProfileObjsList" id="upObjsList">
              <div class="miniSpinner"></div>
            </div>
          </div>
        </div>

      </div><!-- /appShell -->

      <div class="nav">
        <div class="navInner">
          <button class="navBtn active" data-nav="home">‚åÇ</button>
          <button class="navBtn" data-nav="compass">üß≠</button>
          <button class="navBtn" data-nav="profile">üë§</button>
        </div>
      </div>
    </section>
  </div>

  <!-- DETALLE -->
  <div class="screen" id="screen-detail">
    <section class="detail">
      <div class="detailShell">
        <div class="detailHero" id="detailHero"></div>
        <div class="detailOverlay"></div>
        <div class="detailTopBtns">
          <button class="iconBtn" id="backBtn">‚Üê</button>
          <button class="iconBtn" id="toggleDoneTop">‚ô°</button>
        </div>
        <div class="detailThumbs" id="detailThumbs"></div>
        <div class="detailTitleBlock">
          <h2 id="detailTitle">‚Äî</h2>
          <div class="subline" id="detailSub">‚Äî</div>
        </div>
        <div class="sheet">
          <div class="chips">
            <div class="chip"><div class="k">Categor√≠a</div><div class="v" id="chipCat">‚Äî</div></div>
            <div class="chip"><div class="k">Estado</div><div class="v" id="chipState">‚Äî</div></div>
            <div class="chip"><div class="k">Coste</div><div class="v" id="chipCost">‚Äî</div></div>
          </div>
          <div class="descTitle">Descripci√≥n</div>
          <div class="desc" id="detailDesc">‚Äî</div>
          <div class="sheetBottom">
            <div>
              <div style="font-size:12px;color:rgba(11,16,34,.55);font-weight:900;">Coste total</div>
              <div class="price" id="detailPrice">‚Äî</div>
            </div>
            <button class="action" id="toggleDoneBtn">‚Ä∫</button>
          </div>
        </div>
      </div>
    </section>
  </div>

</div><!-- /frame -->

<script>
/* ================================================================
   STORAGE (por usuario ‚Äî clave incluye uid)
================================================================ */
const BASE_KEY = "lalista_v6_";
let currentUid = null;

function storageKey(){ return BASE_KEY + (currentUid || "guest"); }
function loadObjetivos(){
  try{
    const raw = localStorage.getItem(storageKey());
    if(!raw) return [];
    const d = JSON.parse(raw);
    return Array.isArray(d) ? d : [];
  }catch(e){ return []; }
}
function saveObjetivos(){ localStorage.setItem(storageKey(), JSON.stringify(objetivos)); }

let objetivos = [];

/* ================================================================
   HELPERS
================================================================ */
const $ = q => document.querySelector(q);
const $$ = q => document.querySelectorAll(q);
const eur = n => (Math.round((Number(n)||0)*100)/100).toLocaleString("es-ES") + "‚Ç¨";
function escapeHTML(str){
  return String(str).replace(/[&<>"']/g, s => ({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"}[s]));
}
function firstImg(o){ return (o.imgs && o.imgs.length) ? o.imgs[0] : ""; }

/* ================================================================
   FIREBASE AUTH
================================================================ */
function waitFirebase(cb){
  if(window._fbOnAuthStateChanged){ cb(); }
  else { window.addEventListener("firebaseReady", cb, { once: true }); }
}

waitFirebase(() => {
  window._fbOnAuthStateChanged(async user => {
    if(user){
      currentUid = user.uid;
      objetivos = loadObjetivos();
      // Ensure user profile exists in Firestore
      await ensureFirestoreProfile(user);
      showAppScreen(user);
    } else {
      currentUid = null;
      showAuthScreen();
    }
  });
});

/* ================================================================
   FIRESTORE PROFILE MANAGEMENT
================================================================ */
function genCode(){
  const chars = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
  let c = "";
  for(let i=0;i<8;i++) c += chars[Math.floor(Math.random()*chars.length)];
  return c;
}

// In-memory cache of fetched profiles
const profileCache = {};

async function ensureFirestoreProfile(user){
  try{
    let profile = await window._fsGetUser(user.uid);
    if(!profile){
      // New user ‚Äî create profile
      const code = genCode();
      profile = {
        uid: user.uid,
        username: user.displayName || "",
        code,
        avatarData: user.photoURL || "",
        following: [],
        followers: []
      };
      await window._fsSetUser(user.uid, profile);
    }
    profileCache[user.uid] = profile;
    return profile;
  }catch(e){
    console.warn("Firestore profile init error:", e);
    return null;
  }
}

async function getMyProfile(){
  if(!currentUid) return null;
  if(profileCache[currentUid]) return profileCache[currentUid];
  try{
    const p = await window._fsGetUser(currentUid);
    if(p) profileCache[currentUid] = p;
    return p;
  }catch(e){ return null; }
}

async function saveMyProfile(data){
  if(!currentUid) return;
  const current = await getMyProfile() || {};
  const updated = { ...current, ...data };
  profileCache[currentUid] = updated;
  await window._fsSetUser(currentUid, updated);
}

async function getProfileByUid(uid){
  if(profileCache[uid]) return profileCache[uid];
  try{
    const p = await window._fsGetUser(uid);
    if(p) profileCache[uid] = { uid, ...p };
    return p ? { uid, ...p } : null;
  }catch(e){ return null; }
}

async function isFollowing(targetUid){
  const me = await getMyProfile();
  return me ? (me.following||[]).includes(targetUid) : false;
}

async function followUser(targetUid){
  if(!currentUid || targetUid === currentUid) return;
  try{
    await window._fsFollow(currentUid, targetUid);
    // Update cache
    const me = profileCache[currentUid];
    if(me){
      if(!me.following) me.following = [];
      if(!me.following.includes(targetUid)) me.following.push(targetUid);
    }
    const them = profileCache[targetUid];
    if(them){
      if(!them.followers) them.followers = [];
      if(!them.followers.includes(currentUid)) them.followers.push(currentUid);
    }
  }catch(e){ console.warn("Follow error:", e); }
}

async function unfollowUser(targetUid){
  if(!currentUid) return;
  try{
    await window._fsUnfollow(currentUid, targetUid);
    const me = profileCache[currentUid];
    if(me) me.following = (me.following||[]).filter(id=>id!==targetUid);
    const them = profileCache[targetUid];
    if(them) them.followers = (them.followers||[]).filter(id=>id!==currentUid);
  }catch(e){ console.warn("Unfollow error:", e); }
}

/* ================================================================
   AUTH SCREEN LOGIC
================================================================ */
const screenAuth   = $("#screen-auth");
const screenApp    = $("#screen-app");
const screenDetail = $("#screen-detail");

function openAuthModal(tab){
  switchAuthTab(tab || "login");
  $("#authModalBack").classList.add("show");
}
function closeAuthModal(){ $("#authModalBack").classList.remove("show"); }
function switchAuthTab(tab){
  const isLogin = tab === "login";
  $("#tabLogin").classList.toggle("active", isLogin);
  $("#tabRegister").classList.toggle("active", !isLogin);
  $("#formLogin").classList.toggle("active", isLogin);
  $("#formRegister").classList.toggle("active", !isLogin);
}

$("#openLoginBtn").addEventListener("click", () => openAuthModal("login"));
$("#openRegisterBtn").addEventListener("click", () => openAuthModal("register"));
$("#authModalClose").addEventListener("click", closeAuthModal);
$("#authModalBack").addEventListener("click", e => { if(e.target === $("#authModalBack")) closeAuthModal(); });

function showAuthScreen(){
  screenAuth.classList.add("active");
  screenApp.classList.remove("active");
  screenDetail.classList.remove("active");
  closeAuthModal();
}

function showAppScreen(user){
  closeAuthModal();
  screenAuth.classList.remove("active");
  screenApp.classList.add("active");
  screenDetail.classList.remove("active");
  updateUserUI();
  renderHome("Todos");
  showView("home");
}

/* ================================================================
   updateUserUI ‚Äî uses Firestore profile
================================================================ */
async function updateUserUI(){
  const user = window._fbAuth?.currentUser;
  if(!user) return;
  const profile = await getMyProfile();

  const nameEl   = $("#userName");
  const emailEl  = $("#userEmail");
  const avatarEl = $("#userAvatar");
  const handleEl = $("#userHandleDisplay");

  if(nameEl)  nameEl.textContent  = profile?.username || user.displayName || "Sin nombre";
  if(emailEl) emailEl.textContent = user.email || "";
  if(handleEl) handleEl.textContent = profile?.username ? "@"+profile.username : "";

  const avatarSrc = profile?.avatarData || user.photoURL || "";
  if(avatarEl){
    if(avatarSrc){
      avatarEl.innerHTML = '<img src="' + avatarSrc + '" alt="avatar">';
    } else {
      const initial = (profile?.username || user.displayName || user.email || "?")[0].toUpperCase();
      avatarEl.textContent = initial;
    }
  }

  const followersEl = $("#followersCount");
  const followingEl = $("#followingCount");
  if(followersEl) followersEl.textContent = (profile?.followers||[]).length;
  if(followingEl) followingEl.textContent = (profile?.following||[]).length;
}

function setAuthLoading(on){
  $("#authSpinner").classList.toggle("show", on);
  $$("#formLogin .btnPrimary, #formLogin .btnGoogle, #formRegister .btnPrimary, #formRegister .btnGoogle")
    .forEach(b => b.disabled = on);
}
function showAuthError(el, msg){ el.textContent = msg; el.classList.add("show"); }
function clearAuthError(el){ el.textContent = ""; el.classList.remove("show"); }
function friendlyError(code){
  const map = {
    "auth/invalid-email":"Correo electr√≥nico no v√°lido.",
    "auth/user-not-found":"No existe cuenta con ese correo.",
    "auth/wrong-password":"Contrase√±a incorrecta.",
    "auth/invalid-credential":"Correo o contrase√±a incorrectos.",
    "auth/email-already-in-use":"Ya existe una cuenta con ese correo.",
    "auth/weak-password":"La contrase√±a debe tener al menos 6 caracteres.",
    "auth/popup-closed-by-user":"Ventana de Google cerrada.",
    "auth/cancelled-popup-request":"Ventana de Google cerrada.",
    "auth/network-request-failed":"Error de red. Comprueba tu conexi√≥n.",
    "auth/too-many-requests":"Demasiados intentos. Espera un momento."
  };
  return map[code] || "Error inesperado. Int√©ntalo de nuevo.";
}

// LOGIN
$("#loginBtn").addEventListener("click", async () => {
  const e = $("#loginEmail").value.trim();
  const p = $("#loginPass").value;
  const errEl = $("#loginError");
  clearAuthError(errEl);
  if(!e||!p){ showAuthError(errEl,"Rellena correo y contrase√±a."); return; }
  setAuthLoading(true);
  try{
    await window._fbSignInEmail(e,p);
  }catch(err){ showAuthError(errEl, friendlyError(err.code)); }
  finally{ setAuthLoading(false); }
});

// FORGOT
$("#forgotBtn").addEventListener("click", async () => {
  const e = $("#loginEmail").value.trim();
  const errEl = $("#loginError");
  clearAuthError(errEl);
  if(!e){ showAuthError(errEl,"Introduce tu correo primero."); return; }
  setAuthLoading(true);
  try{
    await window._fbResetPassword(e);
    showAuthError(errEl,"");
    errEl.classList.remove("show");
    const s = document.createElement("div");
    s.className="authSuccess show";
    s.textContent="Email de recuperaci√≥n enviado ‚úÖ";
    errEl.after(s); setTimeout(()=>s.remove(),4000);
  }catch(err){ showAuthError(errEl, friendlyError(err.code)); }
  finally{ setAuthLoading(false); }
});

// GOOGLE LOGIN
async function handleGoogleLogin(){
  const errEl = $("#loginError");
  clearAuthError(errEl);
  setAuthLoading(true);
  try{ await window._fbGoogleLogin(); }
  catch(err){ showAuthError(errEl, friendlyError(err.code)); }
  finally{ setAuthLoading(false); }
}
$("#loginGoogleBtn").addEventListener("click", handleGoogleLogin);
$("#registerGoogleBtn").addEventListener("click", handleGoogleLogin);

// REGISTER
$("#registerBtn").addEventListener("click", async () => {
  const name  = $("#registerName").value.trim();
  const e     = $("#registerEmail").value.trim();
  const p     = $("#registerPass").value;
  const errEl = $("#registerError");
  const okEl  = $("#registerSuccess");
  clearAuthError(errEl);
  if(!e||!p){ showAuthError(errEl,"Rellena correo y contrase√±a."); return; }
  setAuthLoading(true);
  try{
    const cred = await window._fbRegister(e,p);
    if(name) await window._fbUpdateProfile({ displayName: name });
    okEl.textContent="¬°Cuenta creada! Iniciando sesi√≥n‚Ä¶"; okEl.classList.add("show");
  }catch(err){ showAuthError(errEl, friendlyError(err.code)); }
  finally{ setAuthLoading(false); }
});

// TABS
$("#tabLogin").addEventListener("click",    () => switchAuthTab("login"));
$("#tabRegister").addEventListener("click", () => switchAuthTab("register"));

// SIGN OUT
$("#signOutBtn").addEventListener("click", async () => {
  if(!confirm("¬øCerrar sesi√≥n?")) return;
  await window._fbSignOut();
});

/* ================================================================
   NAV & VIEWS
================================================================ */
let currentView = "home";
let viewMode = "carousel";
let leafletMap = null;

function showView(name){
  currentView = name;
  $$("#view-home, #view-compass, #view-profile").forEach(v => v.style.display="none");
  const el = $("#view-"+name);
  if(el) el.style.display="block";
  $$(".navBtn").forEach(b => b.classList.toggle("active", b.dataset.nav===name));

  const pageTitle = $("#pageTitle");
  if(name==="home")    { pageTitle.textContent="Mis objetivos"; $("#homeHeader").style.display=""; }
  if(name==="compass") { pageTitle.textContent="Mapa"; $("#homeHeader").style.display="none"; initMap(); }
  if(name==="profile") { pageTitle.textContent="Perfil"; $("#homeHeader").style.display="none"; renderProfile(); }
}

$$(".navBtn").forEach(btn => btn.addEventListener("click", () => showView(btn.dataset.nav)));
$("#mapBackBtn").addEventListener("click", () => showView("home"));

function initMap(){
  if(leafletMap) return;
  leafletMap = L.map("map",{zoomControl:true,attributionControl:false}).setView([20,0],2);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:18}).addTo(leafletMap);
  refreshMap();
}
function refreshMap(){
  if(!leafletMap) return;
  leafletMap.eachLayer(l => { if(l instanceof L.Marker) leafletMap.removeLayer(l); });
  objetivos.forEach(o => {
    if(o.lat==null||o.lng==null) return;
    L.marker([o.lat,o.lng]).addTo(leafletMap)
      .bindPopup('<b>'+escapeHTML(o.titulo)+'</b><br>'+escapeHTML(o.cat)+(o.done?" ¬∑ ‚úÖ":""));
  });
}

/* ================================================================
   RENDER HOME
================================================================ */
const carousel         = $("#carousel");
const listViewContainer = $("#listViewContainer");
const communityFeed    = $("#communityFeed");
let currentCat = "Todos";

function refreshEverywhere(){
  saveObjetivos();
  // Sync public objectives to Firestore
  if(currentUid && window._fsSaveObjective){
    objetivos.forEach(o => {
      window._fsSaveObjective(currentUid, o).catch(()=>{});
    });
  }
  renderHome(currentCat);
  if(currentView==="compass") refreshMap();
  if(currentView==="profile") renderProfile();
}

function renderHome(cat){
  currentCat = cat||"Todos";
  $$(".tab").forEach(t => t.classList.toggle("active", t.dataset.cat===currentCat));

  if(currentCat==="Comunidad"){
    carousel.style.display="none";
    listViewContainer.style.display="none";
    communityFeed.style.display="block";
    $("#homeActionsBar").style.display="none";
    renderCommunityFeed();
    return;
  }

  communityFeed.style.display="none";
  $("#homeActionsBar").style.display="flex";
  carousel.style.display="";
  listViewContainer.style.display="";

  const list = objetivos.filter(o => cat==="Todos" || o.cat===cat);

  carousel.innerHTML = list.map(o =>
    '<article class="objCard '+(o.done?"done":"") + '" data-id="'+o.id+'">'
    +'<div class="objImg" style="background-image:url(\''+firstImg(o)+'\')"></div>'
    +'<div class="objBody"><div>'
    +'<div class="objTitle">'+escapeHTML(o.titulo)+'</div>'
    +'<div class="objMeta">'+escapeHTML(o.cat)+' ¬∑ '+eur(o.coste)+(o.place?" ¬∑ "+escapeHTML(o.place):"")+'</div>'
    +'</div><div class="badge '+(o.done?"done":"")+'">'+( o.done?"Cumplido":o.cat)+'</div></div></article>'
  ).join("");
  carousel.scrollTo({left:0,behavior:"auto"});

  listViewContainer.innerHTML = list.map(o =>
    '<div class="listObjCard '+(o.done?"done":"") + '" data-id="'+o.id+'">'
    +'<div class="listObjImg" style="background-image:url(\''+firstImg(o)+'\')"></div>'
    +'<div class="listObjBody">'
    +'<div class="listObjTitle">'+escapeHTML(o.titulo)+'</div>'
    +'<div class="listObjMeta">'+escapeHTML(o.cat)+' ¬∑ '+eur(o.coste)+(o.place?" ¬∑ "+escapeHTML(o.place):"")+'</div>'
    +'<div class="listObjBadge '+(o.done?"done":"")+'">'+( o.done?"Cumplido":"Pendiente")+'</div>'
    +'</div></div>'
  ).join("") || '<div style="padding:24px 0;text-align:center;color:rgba(11,16,34,.40);font-size:13px;font-weight:700;">No hay objetivos aqu√≠ todav√≠a.</div>';

  applyViewMode();
}

async function renderCommunityFeed(){
  communityFeed.innerHTML = '<div class="miniSpinner"></div>';
  const me = await getMyProfile();
  const following = me ? (me.following||[]) : [];

  if(!following.length){
    communityFeed.innerHTML = '<div style="padding:40px 16px;text-align:center;">'
      +'<div style="font-size:40px;margin-bottom:12px;">üë•</div>'
      +'<div style="font-size:15px;font-weight:800;color:var(--ink);margin-bottom:8px;">A√∫n no sigues a nadie</div>'
      +'<div style="font-size:13px;color:rgba(11,16,34,.55);font-weight:700;">Busca usuarios con el üîç y s√≠guelos para ver sus objetivos p√∫blicos aqu√≠.</div>'
      +'</div>';
    return;
  }

  // Load profiles and objectives in parallel
  const results = await Promise.allSettled(
    following.map(uid => Promise.all([
      getProfileByUid(uid),
      window._fsGetPublicObjectives(uid)
    ]))
  );

  let cards = [];
  results.forEach(r => {
    if(r.status==="fulfilled" && r.value[0]){
      const [profile, objs] = r.value;
      objs.forEach(o => cards.push({ o, profile }));
    }
  });

  if(!cards.length){
    communityFeed.innerHTML = '<div style="padding:40px 16px;text-align:center;color:rgba(11,16,34,.45);font-size:13px;font-weight:700;">Las personas que sigues a√∫n no tienen objetivos p√∫blicos.</div>';
    return;
  }

  cards.sort((a,b) => (a.o.done?1:0) - (b.o.done?1:0));

  communityFeed.innerHTML = cards.map(({o, profile}) => {
    const avatarHtml = profile.avatarData
      ? '<img src="'+profile.avatarData+'" alt="av">'
      : (profile.username||"?")[0].toUpperCase();
    const uid = profile.uid || "";
    return '<div class="feedCard">'
      +'<div class="feedCardHero" style="background-image:url(\''+firstImg(o)+'\')"></div>'
      +'<div class="feedCardBody">'
      +'<div class="feedCardAuthor" data-profile-uid="'+uid+'">'
      +'<div class="feedAvatar">'+avatarHtml+'</div>'
      +'<span class="feedAuthorName">@'+escapeHTML(profile.username||"usuario")+'</span>'
      +'</div>'
      +'<div class="feedTitle">'+escapeHTML(o.titulo)+'</div>'
      +'<div class="feedMeta">'+escapeHTML(o.cat)+' ¬∑ '+eur(o.coste)+(o.done?' ¬∑ ‚úÖ Cumplido':'')+'</div>'
      +'</div></div>';
  }).join("");
}

communityFeed.addEventListener("click", e => {
  const author = e.target.closest("[data-profile-uid]");
  if(author && author.dataset.profileUid) openUserProfile(author.dataset.profileUid);
});

function applyViewMode(){
  const btn = $("#viewToggleBtn");
  if(viewMode==="carousel"){
    carousel.classList.remove("hidden");
    listViewContainer.classList.remove("active");
    if(btn) btn.textContent="‚ò∞";
  } else {
    carousel.classList.add("hidden");
    listViewContainer.classList.add("active");
    if(btn) btn.textContent="‚äü";
  }
}

$("#viewToggleBtn").addEventListener("click", () => {
  viewMode = (viewMode==="carousel") ? "list" : "carousel";
  applyViewMode();
});

$$(".tab").forEach(t => t.addEventListener("click", () => {
  $$(".tab").forEach(x => x.classList.remove("active"));
  t.classList.add("active");
  renderHome(t.dataset.cat);
}));

carousel.addEventListener("click", e => {
  const card = e.target.closest(".objCard");
  if(card) openDetail(Number(card.dataset.id));
});
listViewContainer.addEventListener("click", e => {
  const card = e.target.closest(".listObjCard");
  if(card) openDetail(Number(card.dataset.id));
});

/* ================================================================
   PROFILE (my own)
================================================================ */
async function renderProfile(){
  const pend = objetivos.filter(o => !o.done);
  const done = objetivos.filter(o => o.done);
  const costTotal = objetivos.reduce((a,o) => a+(Number(o.coste)||0),0);
  const costPend  = pend.reduce((a,o) => a+(Number(o.coste)||0),0);
  const costDone  = done.reduce((a,o) => a+(Number(o.coste)||0),0);

  $("#kpiPend").textContent = pend.length;
  $("#kpiDone").textContent = done.length;
  $("#kpiCostTotal").textContent = eur(costTotal);
  $("#kpiCostPend").textContent  = eur(costPend);

  const profile = await getMyProfile();
  $("#followersCount").textContent = (profile?.followers||[]).length;
  $("#followingCount").textContent = (profile?.following||[]).length;

  $("#listPend").innerHTML = pend.length
    ? pend.map(o => '<div class="rowItem"><div class="rowLeft"><strong>'+escapeHTML(o.titulo)+'</strong><small>'+escapeHTML(o.cat)+(o.place?" ¬∑ "+escapeHTML(o.place):"")+'</small></div><div class="cost">'+eur(o.coste||0)+'</div></div>').join("")
    : '<div class="rowItem"><div class="rowLeft"><strong>Todo hecho üòÆ‚Äçüí®</strong><small>No hay pendientes.</small></div><div class="cost">0‚Ç¨</div></div>';

  $("#listDone").innerHTML = done.length
    ? done.map(o => '<div class="rowItem"><div class="rowLeft"><strong>'+escapeHTML(o.titulo)+'</strong><small>'+escapeHTML(o.cat)+(o.place?" ¬∑ "+escapeHTML(o.place):"")+'</small></div><div class="cost">'+eur(o.coste||0)+'</div></div>').join("")
    : '<div class="rowItem"><div class="rowLeft"><strong>A√∫n ninguno cumplido</strong><small>Se empieza por uno.</small></div><div class="cost">'+eur(costDone)+'</div></div>';
}

// Click on userCard ‚Üí open profile edit
$("#userCard").addEventListener("click", openProfileEdit);

/* ================================================================
   FOLLOWERS / FOLLOWING MODAL (with clickable profiles)
================================================================ */
$("#followersCard").addEventListener("click", () => openSocialList("followers"));
$("#followingCard").addEventListener("click", () => openSocialList("following"));

async function openSocialList(type){
  const profile = await getMyProfile();
  const uids = type==="followers" ? (profile?.followers||[]) : (profile?.following||[]);
  $("#socialListTitle").textContent = type==="followers" ? "Seguidores" : "Siguiendo";
  $("#socialListContent").innerHTML = '<div class="miniSpinner"></div>';
  $("#socialListBack").classList.add("show");

  if(!uids.length){
    $("#socialListContent").innerHTML = '<div style="padding:20px;text-align:center;color:rgba(11,16,34,.45);font-size:13px;font-weight:700;">No hay nadie aqu√≠ todav√≠a.</div>';
    return;
  }

  // Load profiles from Firestore
  const profiles = await window._fsGetUsersByUids(uids);
  const myFollowing = profile?.following || [];

  $("#socialListContent").innerHTML = profiles.length
    ? profiles.map(p => {
        const uid = p.uid;
        const avatarHtml = p.avatarData
          ? '<img src="'+p.avatarData+'" alt="av">'
          : (p.username||"?")[0].toUpperCase();
        const isF = myFollowing.includes(uid);
        return '<div class="userResult">'
          +'<div class="userResultAvatar" style="cursor:pointer;" data-profile-uid="'+uid+'">'+avatarHtml+'</div>'
          +'<div class="userResultInfo" data-profile-uid="'+uid+'">'
          +'<div class="userResultName">'+escapeHTML(p.username||"Usuario")+'</div>'
          +'<div class="userResultHandle">@'+escapeHTML(p.username||p.code||"")+'</div>'
          +'</div>'
          +(uid!==currentUid
            ? '<button class="btnFollow '+(isF?"following":"") +'" data-follow-uid="'+uid+'">'+(isF?"Siguiendo":"Seguir")+'</button>'
            : '<span style="font-size:12px;color:rgba(11,16,34,.4);">T√∫</span>')
          +'</div>';
      }).join("")
    : '<div style="padding:20px;text-align:center;color:rgba(11,16,34,.45);font-size:13px;font-weight:700;">No hay nadie aqu√≠ todav√≠a.</div>';
}

function closeSocialList(){ $("#socialListBack").classList.remove("show"); }
$("#socialListClose").addEventListener("click", closeSocialList);
$("#socialListClose2").addEventListener("click", closeSocialList);
$("#socialListBack").addEventListener("click", e => { if(e.target===$("#socialListBack")) closeSocialList(); });

$("#socialListContent").addEventListener("click", async e => {
  // Click on profile info or avatar ‚Üí open profile
  const profileEl = e.target.closest("[data-profile-uid]");
  if(profileEl && !e.target.closest("[data-follow-uid]")){
    const uid = profileEl.dataset.profileUid;
    if(uid && uid!==currentUid){
      closeSocialList();
      openUserProfile(uid);
      return;
    }
  }

  // Follow / Unfollow button
  const btn = e.target.closest("[data-follow-uid]");
  if(!btn) return;
  const uid = btn.dataset.followUid;
  const following = await isFollowing(uid);
  btn.disabled = true;
  if(following){
    await unfollowUser(uid);
    btn.textContent="Seguir"; btn.classList.remove("following");
  } else {
    await followUser(uid);
    btn.textContent="Siguiendo"; btn.classList.add("following");
  }
  btn.disabled = false;
  await updateUserUI();
  if(currentView==="profile") renderProfile();
});

/* ================================================================
   BUSCAR USUARIOS MODAL
================================================================ */
function openSearchUsers(){ $("#searchUserInput").value=""; $("#searchUserResults").innerHTML=""; $("#searchUsersBack").classList.add("show"); }
function closeSearchUsers(){ $("#searchUsersBack").classList.remove("show"); }
$("#searchUsersClose").addEventListener("click", closeSearchUsers);
$("#searchUsersClose2").addEventListener("click", closeSearchUsers);
$("#searchUsersBack").addEventListener("click", e => { if(e.target===$("#searchUsersBack")) closeSearchUsers(); });
$("#searchBtn").addEventListener("click", openSearchUsers);

let searchDebounce = null;
$("#searchUserInput").addEventListener("input", () => {
  clearTimeout(searchDebounce);
  searchDebounce = setTimeout(async () => {
    const q = $("#searchUserInput").value.trim();
    if(!q){ $("#searchUserResults").innerHTML=""; return; }
    $("#searchUserResults").innerHTML = '<div class="miniSpinner"></div>';
    try{
      const found = await window._fsSearchByCode(q);
      if(!found){
        $("#searchUserResults").innerHTML = '<div style="padding:12px;font-size:13px;color:rgba(11,16,34,.45);font-weight:700;">No se encontr√≥ ning√∫n usuario con ese c√≥digo.</div>';
        return;
      }
      if(found.uid===currentUid){
        $("#searchUserResults").innerHTML = '<div style="padding:12px;font-size:13px;color:rgba(11,16,34,.45);font-weight:700;">Ese eres t√∫ üòÑ</div>';
        return;
      }
      profileCache[found.uid] = found;
      const isF = await isFollowing(found.uid);
      const avatarHtml = found.avatarData
        ? '<img src="'+found.avatarData+'" alt="av">'
        : (found.username||"?")[0].toUpperCase();
      $("#searchUserResults").innerHTML = '<div class="userResult">'
        +'<div class="userResultAvatar" style="cursor:pointer;" data-profile-uid="'+found.uid+'">'+avatarHtml+'</div>'
        +'<div class="userResultInfo" data-profile-uid="'+found.uid+'">'
        +'<div class="userResultName">'+escapeHTML(found.username||"Usuario")+'</div>'
        +'<div class="userResultHandle">@'+escapeHTML(found.username||found.code)+'</div>'
        +'</div>'
        +'<button class="btnFollow '+(isF?"following":"") +'" data-follow-uid="'+found.uid+'">'+(isF?"Siguiendo":"Seguir")+'</button>'
        +'</div>';
    }catch(e){
      $("#searchUserResults").innerHTML = '<div style="padding:12px;font-size:13px;color:#b91c1c;font-weight:700;">Error al buscar. Int√©ntalo de nuevo.</div>';
    }
  }, 350);
});

$("#searchUserResults").addEventListener("click", async e => {
  // Click on avatar or name ‚Üí open profile
  const profileEl = e.target.closest("[data-profile-uid]");
  if(profileEl && !e.target.closest("[data-follow-uid]")){
    const uid = profileEl.dataset.profileUid;
    if(uid && uid!==currentUid){
      closeSearchUsers();
      openUserProfile(uid);
      return;
    }
  }

  const btn = e.target.closest("[data-follow-uid]");
  if(!btn) return;
  const uid = btn.dataset.followUid;
  const following = await isFollowing(uid);
  btn.disabled = true;
  if(following){
    await unfollowUser(uid);
    btn.textContent="Seguir"; btn.classList.remove("following");
  } else {
    await followUser(uid);
    btn.textContent="Siguiendo"; btn.classList.add("following");
  }
  btn.disabled = false;
  await updateUserUI();
});

/* ================================================================
   PERFIL DE OTRO USUARIO MODAL
================================================================ */
let viewingProfileUid = null;

async function openUserProfile(uid){
  if(!uid) return;
  viewingProfileUid = uid;

  // Reset UI
  $("#upAvatar").innerHTML = "?";
  $("#upName").textContent = "‚Äî";
  $("#upHandle").textContent = "‚Äî";
  $("#upFollowers").textContent = "‚Äî";
  $("#upFollowing").textContent = "‚Äî";
  $("#upObjCount").textContent = "‚Äî";
  $("#upObjsList").innerHTML = '<div class="miniSpinner"></div>';
  $("#upFollowBtn").textContent = "‚Ä¶";
  $("#upFollowBtn").disabled = true;
  $("#userProfileBack").classList.add("show");

  try{
    // Load profile + objectives in parallel
    const [profile, objs] = await Promise.all([
      getProfileByUid(uid),
      window._fsGetPublicObjectives(uid)
    ]);

    if(!profile){
      $("#upName").textContent = "Usuario no encontrado";
      $("#upObjsList").innerHTML = "";
      return;
    }

    // Avatar
    const av = $("#upAvatar");
    if(profile.avatarData){
      av.innerHTML = '<img src="'+profile.avatarData+'" alt="av">';
    } else {
      av.textContent = (profile.username||"?")[0].toUpperCase();
    }

    $("#upName").textContent = profile.username || "Usuario";
    $("#upHandle").textContent = "@" + (profile.username || profile.code || "");
    $("#upFollowers").textContent = (profile.followers||[]).length;
    $("#upFollowing").textContent = (profile.following||[]).length;
    $("#upObjCount").textContent = objs.length;

    // Follow button
    const amFollowing = await isFollowing(uid);
    const followBtn = $("#upFollowBtn");
    followBtn.textContent = amFollowing ? "Siguiendo" : "Seguir";
    followBtn.className = "btnFollowFull" + (amFollowing ? " following" : "");
    followBtn.disabled = false;

    // Objectives
    if(!objs.length){
      $("#upObjsList").innerHTML = '<div style="padding:12px;font-size:13px;color:rgba(11,16,34,.45);font-weight:700;text-align:center;">Este usuario no tiene objetivos p√∫blicos.</div>';
    } else {
      $("#upObjsList").innerHTML = objs.map(o =>
        '<div class="userObjMini">'
        +'<div class="userObjMiniImg" style="background-image:url(\''+firstImg(o)+'\')"></div>'
        +'<div class="userObjMiniBody">'
        +'<div class="userObjMiniTitle">'+escapeHTML(o.titulo)+'</div>'
        +'<div class="userObjMiniMeta">'+escapeHTML(o.cat||"")+(o.done?" ¬∑ ‚úÖ Cumplido":"")+(o.coste?" ¬∑ "+eur(o.coste):"")+'</div>'
        +'</div></div>'
      ).join("");
    }

  }catch(err){
    console.warn("openUserProfile error:", err);
    $("#upObjsList").innerHTML = '<div style="padding:12px;font-size:13px;color:#b91c1c;font-weight:700;">Error al cargar el perfil.</div>';
    $("#upFollowBtn").disabled = false;
    $("#upFollowBtn").textContent = "Seguir";
  }
}

function closeUserProfile(){
  $("#userProfileBack").classList.remove("show");
  viewingProfileUid = null;
}

$("#userProfileClose").addEventListener("click", closeUserProfile);
$("#userProfileBack").addEventListener("click", e => { if(e.target===$("#userProfileBack")) closeUserProfile(); });

$("#upFollowBtn").addEventListener("click", async () => {
  const uid = viewingProfileUid;
  if(!uid) return;
  const btn = $("#upFollowBtn");
  btn.disabled = true;
  const following = await isFollowing(uid);
  if(following){
    await unfollowUser(uid);
    btn.textContent = "Seguir";
    btn.className = "btnFollowFull";
    // Update follower count in modal
    const profile = profileCache[uid];
    if(profile) $("#upFollowers").textContent = (profile.followers||[]).length;
  } else {
    await followUser(uid);
    btn.textContent = "Siguiendo";
    btn.className = "btnFollowFull following";
    const profile = profileCache[uid];
    if(profile) $("#upFollowers").textContent = (profile.followers||[]).length;
  }
  btn.disabled = false;
  await updateUserUI();
  if(currentView==="profile") renderProfile();
});

/* ================================================================
   PROFILE EDIT MODAL
================================================================ */
async function openProfileEdit(){
  const user = window._fbAuth?.currentUser;
  const profile = await getMyProfile();

  const peAv = $("#peAvatar");
  const avatarSrc = profile?.avatarData || user?.photoURL || "";
  if(avatarSrc){
    peAv.innerHTML = '<img src="'+avatarSrc+'" alt="av"><div class="avatarOverlay">üì∑</div>';
  } else {
    const ini = (profile?.username || user?.displayName || user?.email || "?")[0].toUpperCase();
    peAv.innerHTML = '<span>'+ini+'</span><div class="avatarOverlay">üì∑</div>';
  }

  $("#peCodeDisplay").textContent = profile?.username ? "@"+profile.username : "";
  $("#peCodeValue").textContent = profile?.code || "‚Äî";
  $("#peUsername").value = profile?.username || "";
  $("#peEmail").value = user?.email || "";

  $("#profileEditBack").classList.add("show");
}
function closeProfileEdit(){ $("#profileEditBack").classList.remove("show"); }

$("#profileEditClose").addEventListener("click", closeProfileEdit);
$("#profileEditCancel").addEventListener("click", closeProfileEdit);
$("#profileEditBack").addEventListener("click", e => { if(e.target===$("#profileEditBack")) closeProfileEdit(); });

$("#peAvatar").addEventListener("click", () => $("#peAvatarFile").click());
$("#peAvatarFile").addEventListener("change", async () => {
  const f = $("#peAvatarFile").files?.[0];
  if(!f) return;
  try{
    const data = await new Promise((res,rej) => {
      const r = new FileReader();
      r.onload = () => res(r.result);
      r.onerror = rej;
      r.readAsDataURL(f);
    });
    const peAv = $("#peAvatar");
    peAv.innerHTML = '<img src="'+data+'" alt="av"><div class="avatarOverlay">üì∑</div>';
    peAv.dataset.pendingAvatar = data;
  }catch(e){ alert("No se pudo cargar la imagen."); }
  finally{ $("#peAvatarFile").value=""; }
});

$("#copyCodeBtn").addEventListener("click", () => {
  const code = $("#peCodeValue").textContent;
  navigator.clipboard?.writeText(code).then(() => {
    $("#copyCodeBtn").textContent="‚úÖ Copiado!";
    setTimeout(() => { $("#copyCodeBtn").textContent="üìã Copiar c√≥digo"; }, 2000);
  });
});

$("#profileEditSave").addEventListener("click", async () => {
  const username = $("#peUsername").value.trim().replace(/\s/g,"").replace(/^@/,"");
  const pendingAvatar = $("#peAvatar").dataset.pendingAvatar || "";
  const updates = { username };
  if(pendingAvatar) updates.avatarData = pendingAvatar;
  await saveMyProfile(updates);
  if(username && window._fbAuth?.currentUser){
    try{ await window._fbUpdateProfile({ displayName: username }); }catch(e){}
  }
  delete $("#peAvatar").dataset.pendingAvatar;
  closeProfileEdit();
  await updateUserUI();
  if(currentView==="profile") renderProfile();
});

/* ================================================================
   LIGHTBOX
================================================================ */
const lightbox  = $("#lightbox");
const lbImg     = $("#lbImg");
const lbCounter = $("#lbCounter");
const lbStage   = $("#lbStage");
let galleryImgs = [], galleryIdx = 0;

function openLightbox(imgs, idx){
  galleryImgs = (imgs||[]).filter(Boolean);
  if(!galleryImgs.length) return;
  galleryIdx = Math.max(0, Math.min(idx||0, galleryImgs.length-1));
  renderLB();
  lightbox.classList.add("show");
}
function closeLightbox(){ lightbox.classList.remove("show"); }
function renderLB(){
  lbImg.src = galleryImgs[galleryIdx];
  lbCounter.textContent = (galleryIdx+1)+"/"+galleryImgs.length;
  $("#lbPrev").style.visibility = galleryImgs.length>1?"visible":"hidden";
  $("#lbNext").style.visibility = galleryImgs.length>1?"visible":"hidden";
}
function prevImg(){ galleryIdx=(galleryIdx-1+galleryImgs.length)%galleryImgs.length; renderLB(); }
function nextImg(){ galleryIdx=(galleryIdx+1)%galleryImgs.length; renderLB(); }

$("#lbClose").addEventListener("click", closeLightbox);
$("#lbPrev").addEventListener("click", prevImg);
$("#lbNext").addEventListener("click", nextImg);
lightbox.addEventListener("click", e => { if(!e.target.closest(".lbStage") && !e.target.closest(".lbNav") && !e.target.closest(".lbTop")) closeLightbox(); });
window.addEventListener("keydown", e => {
  if(!lightbox.classList.contains("show")) return;
  if(e.key==="Escape") closeLightbox();
  if(e.key==="ArrowLeft") prevImg();
  if(e.key==="ArrowRight") nextImg();
});
let lbStartX = null;
lbStage.addEventListener("touchstart", e => { lbStartX=e.touches[0].clientX; },{passive:true});
lbStage.addEventListener("touchend", e => {
  if(lbStartX===null) return;
  const dx = e.changedTouches[0].clientX - lbStartX; lbStartX=null;
  if(Math.abs(dx)<40) return;
  dx>0 ? prevImg() : nextImg();
},{passive:true});

/* ================================================================
   DETALLE
================================================================ */
let selectedId = null;

function openDetail(id){
  selectedId = id;
  const o = objetivos.find(x => x.id===id);
  if(!o) return;
  $("#detailHero").style.backgroundImage = "url('"+firstImg(o)+"')";
  $("#detailTitle").textContent = o.titulo;
  const place = o.place ? " ¬∑ "+o.place : "";
  $("#detailSub").textContent = o.cat+" ¬∑ "+(o.done?"Cumplido":"Pendiente")+place;
  $("#chipCat").textContent   = o.cat;
  $("#chipState").textContent = o.done?"Cumplido":"Pendiente";
  $("#chipCost").textContent  = eur(o.coste);
  $("#detailPrice").textContent = eur(o.coste);
  $("#detailDesc").textContent  = o.desc || "A√±ade una descripci√≥n en Ajustes.";
  $("#toggleDoneTop").textContent = o.done?"‚ô•":"‚ô°";
  const imgs = o.imgs||[];
  $("#detailThumbs").innerHTML = imgs.slice(0,4).map((src,i) =>
    '<div class="thumb '+(i===0?"":"dim")+'" data-idx="'+i+'" style="background-image:url(\''+src+'\')"></div>'
  ).join("");
  screenApp.classList.remove("active");
  screenDetail.classList.add("active");
}

function closeDetail(){
  screenDetail.classList.remove("active");
  screenApp.classList.add("active");
}

function toggleDone(){
  const o = objetivos.find(x => x.id===selectedId);
  if(!o) return;
  o.done = !o.done;
  const place = o.place ? " ¬∑ "+o.place : "";
  $("#chipState").textContent = o.done?"Cumplido":"Pendiente";
  $("#detailSub").textContent = o.cat+" ¬∑ "+(o.done?"Cumplido":"Pendiente")+place;
  $("#toggleDoneTop").textContent = o.done?"‚ô•":"‚ô°";
  $("#toggleDoneBtn").textContent = o.done?"‚úì":"‚Ä∫";
  refreshEverywhere();
}

$("#backBtn").addEventListener("click", closeDetail);
$("#toggleDoneBtn").addEventListener("click", toggleDone);
$("#toggleDoneTop").addEventListener("click", toggleDone);
$("#detailHero").addEventListener("click", () => {
  const o = objetivos.find(x => x.id===selectedId);
  if(o) openLightbox(o.imgs||[], 0);
});
$("#detailThumbs").addEventListener("click", e => {
  const thumb = e.target.closest(".thumb");
  if(!thumb) return;
  const o = objetivos.find(x => x.id===selectedId);
  if(o) openLightbox(o.imgs||[], Number(thumb.dataset.idx)||0);
  // Update hero
  const imgs = o?.imgs||[];
  const idx = Number(thumb.dataset.idx)||0;
  if(imgs[idx]) $("#detailHero").style.backgroundImage = "url('"+imgs[idx]+"')";
  $$(".thumb").forEach((t,i) => t.classList.toggle("dim", i!==idx));
});

/* ================================================================
   GEAR / SETTINGS MODAL
================================================================ */
let editingId = null;
let pendingLocalImgs = [];

function openSettings(){ showSettingsList(); $("#settingsBack").classList.add("show"); }
function closeSettings(){ $("#settingsBack").classList.remove("show"); editingId=null; pendingLocalImgs=[]; updateLocalCount(); }
$("#gearBtn").addEventListener("click", openSettings);
$("#settingsClose").addEventListener("click", closeSettings);
$("#settingsBack").addEventListener("click", e => { if(e.target===$("#settingsBack")) closeSettings(); });
$("#btnCloseList").addEventListener("click", closeSettings);

function showSettingsList(){
  $("#settingsListView").style.display="";
  $("#settingsFormView").style.display="none";
  $("#settingsActionsList").style.display="";
  $("#settingsActionsForm").style.display="none";
  renderSettingsList();
}
function showSettingsForm(){
  $("#settingsListView").style.display="none";
  $("#settingsFormView").style.display="";
  $("#settingsActionsList").style.display="none";
  $("#settingsActionsForm").style.display="";
}
function renderSettingsList(){
  const list = objetivos;
  $("#settingsList").innerHTML = list.map(o =>
    '<div class="miniItem '+(o.done?"done":"") + '" data-settings-id="'+o.id+'">'
    +'<div class="miniImg" style="background-image:url(\''+firstImg(o)+'\')"></div>'
    +'<div class="miniText"><b>'+escapeHTML(o.titulo)+'</b><span>'+escapeHTML(o.cat)+(o.done?" ¬∑ ‚úÖ":"")+'</span></div>'
    +'<div class="tag">Editar</div>'
    +'</div>'
  ).join("") || '<div class="smallNote">No hay objetivos todav√≠a.</div>';
}

$("#settingsList").addEventListener("click", e => {
  const item = e.target.closest("[data-settings-id]");
  if(!item) return;
  openEdit(Number(item.dataset.settingsId));
});

function openEdit(id){
  editingId = id;
  const o = objetivos.find(x => x.id===id);
  if(!o) return;
  $("#formModeNote").textContent="Editar objetivo";
  $("#fTitle").value = o.titulo||"";
  $("#fCat").value   = o.cat||"Viajes";
  $("#fCost").value  = o.coste||0;
  $("#fDone").checked = !!o.done;
  $("#fPublic").checked = o.isPublic !== false;
  $("#fDesc").value  = o.desc||"";
  const imgs = o.imgs||[];
  $("#fImg0").value = imgs[0]||"";
  $("#fImg1").value = imgs[1]||"";
  $("#fImg2").value = imgs[2]||"";
  $("#fImg3").value = imgs[3]||"";
  $("#fPlace").value = o.place||"";
  $("#fLat").value   = o.lat!=null?o.lat:"";
  $("#fLng").value   = o.lng!=null?o.lng:"";
  pendingLocalImgs=[]; updateLocalCount();
  showSettingsForm();
}

$("#btnAdd").addEventListener("click", () => {
  editingId=null;
  openAddForm();
});
function openAddForm(){
  $("#formModeNote").textContent="Nuevo objetivo";
  ["fTitle","fCost","fDesc","fImg0","fImg1","fImg2","fImg3","fPlace","fLat","fLng"].forEach(id=>{
    const el=$("#"+id); if(el) el.value="";
  });
  $("#fCat").value="Viajes";
  $("#fDone").checked=false;
  $("#fPublic").checked=true;
  pendingLocalImgs=[]; updateLocalCount();
  showSettingsForm();
}
$("#btnBackToList").addEventListener("click", () => { editingId=null; pendingLocalImgs=[]; updateLocalCount(); showSettingsList(); });

function updateLocalCount(){ $("#localCount").textContent = pendingLocalImgs.length+" seleccionadas"; }
function filesToDataUrls(files){
  return Promise.all(Array.from(files).map(f => new Promise((res,rej) => {
    const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(f);
  })));
}
$("#pickLocalBtn").addEventListener("click", () => $("#localFiles").click());
$("#localFiles").addEventListener("change", async () => {
  if(!$("#localFiles").files?.length) return;
  try{ const d=await filesToDataUrls($("#localFiles").files); pendingLocalImgs.push(...d); updateLocalCount(); }
  catch(e){ alert("No se pudieron cargar fotos."); }
  finally{ $("#localFiles").value=""; }
});

$("#btnSave").addEventListener("click", () => {
  const titulo   = $("#fTitle").value.trim();
  const cat      = $("#fCat").value;
  const coste    = Number($("#fCost").value||0);
  const done     = $("#fDone").checked;
  const isPublic = !!$("#fPublic").checked;
  const desc     = $("#fDesc").value.trim();
  const place    = $("#fPlace").value.trim();
  const latRaw   = $("#fLat").value.trim();
  const lngRaw   = $("#fLng").value.trim();
  const lat = latRaw===""?null:Number(latRaw);
  const lng = lngRaw===""?null:Number(lngRaw);

  if(!titulo){ alert("Ponga un t√≠tulo üôÇ"); return; }
  if((lat!==null&&!Number.isFinite(lat))||(lng!==null&&!Number.isFinite(lng))){ alert("Lat/Lng no son v√°lidos."); return; }

  const urlImgs = [$("#fImg0").value,$("#fImg1").value,$("#fImg2").value,$("#fImg3").value].map(s=>(s||"").trim()).filter(Boolean);
  let finalImgs = [];
  if(pendingLocalImgs.length) finalImgs.push(pendingLocalImgs[0]);
  finalImgs.push(...urlImgs);
  if(editingId!=null){
    const prev = objetivos.find(o => o.id===editingId);
    const keepLocal = (prev?.imgs||[]).filter(s => s.startsWith("data:"));
    finalImgs.push(...keepLocal);
  }
  if(pendingLocalImgs.length>1) finalImgs.push(...pendingLocalImgs.slice(1));
  finalImgs = [...new Set(finalImgs)].filter(Boolean);
  if(!finalImgs.length){ alert("A√±ada al menos una imagen."); return; }

  if(editingId==null){
    const nextId = objetivos.reduce((m,o) => Math.max(m,Number(o.id)||0),0)+1;
    objetivos.unshift({id:nextId,titulo,cat,coste,done,desc,imgs:finalImgs,place,lat,lng,isPublic});
  } else {
    const idx = objetivos.findIndex(x => x.id===editingId);
    if(idx>=0) objetivos[idx] = {...objetivos[idx],titulo,cat,coste,done,desc,imgs:finalImgs,place,lat,lng,isPublic};
  }
  pendingLocalImgs=[]; updateLocalCount();
  refreshEverywhere(); showSettingsList();
});

$("#btnDelete").addEventListener("click", () => {
  if(editingId==null) return;
  const o = objetivos.find(x => x.id===editingId);
  if(!confirm('¬øBorrar "' + (o?.titulo||"objetivo") + '"?')) return;
  // Delete from Firestore
  if(currentUid && window._fsDeleteObjective) window._fsDeleteObjective(currentUid, editingId).catch(()=>{});
  objetivos = objetivos.filter(x => x.id!==editingId);
  if(selectedId===editingId && screenDetail.classList.contains("active")) closeDetail();
  editingId=null; pendingLocalImgs=[]; updateLocalCount();
  refreshEverywhere(); showSettingsList();
});

/* ================================================================
   IDEAS
================================================================ */
const ideasCatalogo = {
  Viajes:["Torre Eiffel","Museo del Louvre","Mont Saint-Michel","Costa Azul","Provenza","Coliseo de Roma","Venecia","Torre de Pisa","Costa Amalfitana","Florencia","Sagrada Familia","Londres y Big Ben","Berl√≠n","Viena","Fiordos noruegos","Gran Ca√±√≥n","Times Square","Golden Gate","Las Vegas","Yellowstone","Chich√©n Itz√°","Machu Picchu","Cristo Redentor","Amazonas","Buenos Aires","Gran Muralla China","Tokio","Monte Fuji","Kioto (Fushimi Inari)","Shangh√°i","Bangkok","Taj Mahal","Burj Khalifa","Islas de Tailandia","Desierto de Dub√°i","Pir√°mides de Giza","Sahara","Marrakech","Safari Serengeti","Cataratas Victoria","Auroras en Islandia","Patagonia","Gran Barrera de Coral","Volc√°n activo","Alpes","Ruta 66","Transiberiano","Himalaya","Igl√∫ de cristal","Avistamiento de ballenas","Maldivas","Bora Bora","Santorini","Bali","Haw√°i","Seychelles","Filipinas","Mauricio","Ibiza","Islas Feroe","Nueva York en Navidad","Dub√°i","Singapur","Hong Kong","Estambul","Praga","√Åmsterdam","Budapest","Edimburgo","Chicago","Globo en Capadocia","Carnaval de R√≠o","Oktoberfest","A√±o Nuevo en S√≠dney","Ruta gastron√≥mica por Jap√≥n","Crucero Caribe","Ryokan en Jap√≥n","Viaje solo","5 continentes","50 pa√≠ses antes de los 50","Interrail","Vivir 6 meses fuera","Mochilero por Sudam√©rica","N√≥mada digital","Roadtrip 30 d√≠as","Camino de Santiago","Dormir en el desierto","7 maravillas modernas","10 Patrimonios UNESCO","Viaje con padres","Disney con hijos","Viaje sorpresa","Viaje √©pico de jubilaci√≥n"],
  Familia:["Tener mi primer hijo/a antes de los 35","Crear tradiciones familiares propias","Gran viaje familiar cada verano","Dise√±ar la casa de mis sue√±os","Llegar a la vejez rodeado de hijos y nietos","Comidas familiares todos los domingos","Cita mensual obligatoria con mi pareja","Renovar votos a los 10 a√±os","Vivir un a√±o en el extranjero en familia","Transmitir recetas familiares","√Ålbum f√≠sico familiar cada a√±o","Crear fondo familiar de emergencia","Dejar herencia s√≥lida","Celebrar todos los cumplea√±os juntos","Gran reuni√≥n familiar cada 5 a√±os","Cuidar de mis padres cuando lo necesiten","Viaje individual con cada hijo","Ense√±ar educaci√≥n financiera a mis hijos","Construir negocio familiar","Superar juntos una crisis econ√≥mica"],
  Trabajo:["Conseguir primer ascenso antes de los 30","Alcanzar puesto directivo antes de los 40","Liderar equipo de m√°s de 20 personas","Ser referente en mi sector","Cambiar de sector con √©xito","Trabajar en empresa internacional","Lograr puesto 100% remoto","Negociar aumento del 20%","Superar 50.000‚Ç¨ anuales antes de los 35","Alcanzar 100.000‚Ç¨ anuales antes de los 45","Crear negocio propio antes de los 35","Lanzar producto digital rentable","Automatizar 50% de procesos","Abrir segunda l√≠nea de negocio","Delegar completamente la operativa","Monetizar un hobby","Construir marca personal s√≥lida","Hablar en evento profesional","Independencia financiera antes de los 55","Jubilarme antes de la edad legal"]
};

function openIdeas(cat){
  cat = cat||"Viajes";
  $$(".ideaTab").forEach(b => b.classList.remove("active"));
  document.querySelector('.ideaTab[data-idea-cat="'+cat+'"]')?.classList.add("active");
  renderIdeas(cat);
  $("#ideasBack").classList.add("show");
}
function closeIdeas(){ $("#ideasBack").classList.remove("show"); }
function renderIdeas(cat){
  const list = ideasCatalogo[cat]||[];
  $("#ideasList").innerHTML = list.map(t =>
    '<div class="miniItem"><div class="miniText"><b>'+escapeHTML(t)+'</b><span>'+escapeHTML(cat)+'</span></div>'
    +'<div class="tag" data-idea-add="1" data-idea-title="'+escapeHTML(t)+'" data-idea-cat="'+escapeHTML(cat)+'">A√±adir</div></div>'
  ).join("") || '<div class="smallNote">No hay ideas aqu√≠ todav√≠a.</div>';
}

$("#ideasClose").addEventListener("click", closeIdeas);
$("#ideasClose2").addEventListener("click", closeIdeas);
$("#ideasBack").addEventListener("click", e => { if(e.target===$("#ideasBack")) closeIdeas(); });
$$(".ideaTab").forEach(btn => btn.addEventListener("click", () => {
  $$(".ideaTab").forEach(b => b.classList.remove("active"));
  btn.classList.add("active");
  renderIdeas(btn.dataset.ideaCat);
}));
document.addEventListener("click", e => {
  const add = e.target.closest("[data-idea-add]");
  if(!add) return;
  closeIdeas();
  openWizard({titulo: add.dataset.ideaTitle||"", cat: add.dataset.ideaCat||"Viajes"});
});

/* ================================================================
   WIZARD
================================================================ */
let wStep=0, wLocalImgs=[];

function wizardStepEls(){ return Array.from($$(".wizardStep")); }

function setWizardStep(n){
  const steps = wizardStepEls();
  wStep = Math.max(0, Math.min(n, steps.length-1));
  steps.forEach(s => s.classList.remove("active"));
  steps[wStep].classList.add("active");
  $("#wizardDots").innerHTML = steps.map((_,i) => '<div class="dot '+(i===wStep?"active":"")+'"></div>').join("");
  $("#wPrev").style.visibility = wStep===0 ? "hidden" : "visible";
  $("#wNext").textContent = wStep===steps.length-1 ? "Crear" : "Siguiente";
}

function resetWizard(){
  ["wTitle","wCost","wDesc","wPlace","wLat","wLng","wImgUrl"].forEach(id => {
    const el=$("#"+id); if(el) el.value="";
  });
  $("#wCat").value="Viajes";
  wLocalImgs=[];
  $("#wLocalCount").textContent="0 seleccionadas";
  $("#wLocalFiles").value="";
  setWizardStep(0);
}

function openWizard(prefill){
  prefill = prefill||{};
  resetWizard();
  if(prefill.titulo) $("#wTitle").value = prefill.titulo;
  if(prefill.cat)    $("#wCat").value   = prefill.cat;
  $("#wizardBack").classList.add("show");
}
function closeWizard(){ $("#wizardBack").classList.remove("show"); }

$("#wizardClose").addEventListener("click", closeWizard);
$("#wizardBack").addEventListener("click", e => { if(e.target===$("#wizardBack")) closeWizard(); });
$("#wPickLocalBtn").addEventListener("click", () => $("#wLocalFiles").click());
$("#wLocalFiles").addEventListener("change", async () => {
  if(!$("#wLocalFiles").files?.length) return;
  try{ const d=await filesToDataUrls($("#wLocalFiles").files); wLocalImgs.push(...d); $("#wLocalCount").textContent=wLocalImgs.length+" seleccionadas"; }
  catch(e){ alert("No se pudieron cargar fotos."); }
  finally{ $("#wLocalFiles").value=""; }
});

$("#wPrev").addEventListener("click", () => setWizardStep(wStep-1));
$("#wNext").addEventListener("click", () => {
  const stepsCount = wizardStepEls().length;
  if(wStep===0){
    if(!$("#wTitle").value.trim()){ alert("Ponga un t√≠tulo üôÇ"); return; }
    setWizardStep(1); return;
  }
  if(wStep < stepsCount-1){ setWizardStep(wStep+1); return; }

  // CREAR
  const titulo  = $("#wTitle").value.trim();
  const cat     = $("#wCat").value;
  const coste   = Number($("#wCost").value||0);
  const desc    = $("#wDesc").value.trim();
  const place   = $("#wPlace").value.trim();
  const latRaw  = $("#wLat").value.trim();
  const lngRaw  = $("#wLng").value.trim();
  const lat = latRaw===""?null:Number(latRaw);
  const lng = lngRaw===""?null:Number(lngRaw);

  if((lat!==null&&!Number.isFinite(lat))||(lng!==null&&!Number.isFinite(lng))){ alert("Lat/Lng no v√°lidos."); return; }

  let imgs = [];
  if(wLocalImgs.length){ imgs.push(wLocalImgs[0]); if(wLocalImgs.length>1) imgs.push(...wLocalImgs.slice(1)); }
  const manual = ($("#wImgUrl").value||"").trim();
  if(manual) imgs.push(manual);
  imgs = [...new Set(imgs)].filter(Boolean);

  if(!imgs.length){ alert("A√±ade al menos una imagen: URL o foto del m√≥vil."); return; }

  const nextId = objetivos.reduce((m,o) => Math.max(m,Number(o.id)||0),0)+1;
  const isPublic = !!$("#wPublic").checked;
  objetivos.unshift({id:nextId,titulo,cat,coste,done:false,desc,imgs,place,lat,lng,isPublic});

  refreshEverywhere();
  closeWizard();
  showView("home");
  renderHome(currentCat);
});

$("#addWizardBtn").addEventListener("click", () => openWizard());
</script>
</body>
</html>